<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>نسخة العميل – إرسال وتدقيق وإعادة الإرسال (v3.1)</title>
<style>
  :root{--bg:#f7f8fb;--ink:#111;--muted:#555;--line:#e5e7eb;--card:#fff;--accent:#2563eb;--head:#e6f0ff}
  *{box-sizing:border-box}
  html, body, input, select, textarea, button, table{font-variant-numeric:lining-nums tabular-nums}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Kufi Arabic","Cairo",Tahoma,Arial,sans-serif}
  .wrap{max-width:1100px;margin:auto;padding:18px}
  .card{background:var(--card);border:1px solid #d9dde5;border-radius:14px;padding:18px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
  .title{display:flex;align-items:center;gap:12px}
  .title h1{margin:0;font-size:20px}
  .logo{height:56px;object-fit:contain}
  .row{display:grid;gap:10px}
  @media(min-width:768px){.row{grid-template-columns:repeat(12,1fr)}.col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-5{grid-column:span 5}.col-6{grid-column:span 6}.col-8{grid-column:span 8}.col-12{grid-column:span 12}}
  input[type=text],input[type=date],input[type=email],input[type=search],select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  textarea{min-height:110px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #cfd7e3;padding:8px;vertical-align:middle}
  th{background:var(--head);text-align:center}
  td.num{width:54px;text-align:center}
  td[contenteditable]{outline:0;min-height:28px;word-break:break-word}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid #d0d7ff;background:#fff;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#eef2ff;border:1px solid #c7d2fe;font-size:.85rem;color:#374151}
  .hidden{display:none!important}
  .footer{margin-top:18px;font-size:12px;color:#334155;text-align:center;border-top:1px solid #d9dde5;padding-top:10px}
  .footer a{color:#2563eb;text-decoration:none}
  .muted{color:var(--muted);font-size:13px}
  @media print{.no-print{display:none!important}.card{border:0;box-shadow:none}body{background:#fff}@page{size:A4;margin:12mm} tr,td,th{page-break-inside:avoid}}
</style>
</head>
<body>
<div class="wrap">
  <section id="clientApp" class="card">
    <div class="title" style="gap:14px;align-items:center">
      <!-- Use a logo with a safe filename (no spaces/case issues) -->
      <img id="brandTop" alt="Ergonomic Industrial" src="brand.png" class="logo">
      <h1>نسخة العميل – إرسال وتدقيق وإعادة الإرسال</h1>
      <span style="margin-inline-start:auto"></span>
      <div class="no-print" style="display:flex;gap:8px;align-items:center">
        <span class="pill">المرحلة الحالية</span>
        <select id="phaseSel">
          <option value="client_init">١) من العميل إلى المدقق</option>
          <option value="auditor_action">٢) المدقق يملأ التدقيق</option>
          <option value="client_approve">٣) اعتماد العميل وإرساله للمصمم</option>
        </select>
        <button class="btn" id="printBtn">🖨️ طباعة</button>
      </div>
    </div>

    <p class="muted" id="phaseHint"></p>

    <div class="row" style="margin-top:6px">
      <div class="col-4"><label>اسم الشركة<br><input id="fCompany" type="text" placeholder="مثال: شركة الخليج"></label></div>
      <div class="col-4"><label>اسم الموقع<br><input id="fSite" type="text" placeholder="مثال: مصنع الشعيبة"></label></div>
      <div class="col-4"><label>وصف الموقع<br><input id="fDesc" type="text" placeholder="مكتب / ورشة / …"></label></div>
      <div class="col-3"><label>رقم الباب<br><input id="fGateNo" type="text" placeholder="1"></label></div>
      <div class="col-5"><label>اسم الباب<br><input id="fGateName" type="text" placeholder="مثال: الحماية من الآلات"></label></div>
      <div class="col-4"><label>التاريخ<br><input id="fDate" type="date"></label></div>

      <!-- أطراف التواصل حسب المرحلة -->
      <div class="col-6"><label>اسم المدقق<br><input id="fAuditorName" type="text" placeholder="مثال: م. أحمد"></label></div>
      <div class="col-6"><label>إيميل المدقق<br><input id="fAuditorMail" type="email" placeholder="auditor@example.com"></label></div>
      <div class="col-6"><label>هاتف/واتساب المدقق (اختياري مع مفتاح الدولة)<br><input id="fAuditorPhone" type="text" placeholder="+9655xxxxxxx"></label></div>

      <div class="col-6"><label>إيميل العميل (لاستلام نتيجة التدقيق)<br><input id="fClientMail" type="email" placeholder="client@example.com"></label></div>
    </div>

    <div class="toolbar no-print">
      <span class="pill">بنود التدقيق</span>
      <button class="btn" id="addRow">➕ إضافة بند</button>
      <button class="btn" id="clearRows">🗑️ مسح الكل</button>
      <span class="muted">— يمكن للمدقق تعديل البنود أو النوع أثناء المرحلة (٢)</span>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:60px">م</th>
          <th>البند</th>
          <th style="width:140px">نوع</th>
          <th colspan="2">حقل التقييم</th>
          <th style="width:220px">ملاحظات (≤50)</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="toolbar no-print" style="justify-content:flex-end">
      <button class="btn" id="exportHtml">⬇️ تصدير HTML</button>
      <button class="btn" id="copySummary">📋 نسخ ملخّص</button>
      <button class="btn primary" id="shareAction">📤 إرسال حسب المرحلة</button>
    </div>

    <div class="footer no-print">
      Ergonomic Industrial — <a href="https://ergonomicindustrial.com" target="_blank">ergonomicindustrial.com</a> — Email: <a href="mailto:ergonomicindustrial@gmail.com">ergonomicindustrial@gmail.com</a> — Phone/WhatsApp: 67756743
    </div>
  </section>
</div>

<script>
(function(){
  const $ = s=>document.querySelector(s);
  const els = {
    tbody: $('#tbody'), addRow: $('#addRow'), clearRows: $('#clearRows'),
    exportHtml: $('#exportHtml'), copySummary: $('#copySummary'), shareAction: $('#shareAction'),
    phaseSel: $('#phaseSel'), phaseHint: $('#phaseHint'), printBtn: $('#printBtn'),
    fCompany: $('#fCompany'), fSite: $('#fSite'), fDesc: $('#fDesc'), fGateNo: $('#fGateNo'), fGateName: $('#fGateName'), fDate: $('#fDate'),
    fAuditorName: $('#fAuditorName'), fAuditorMail: $('#fAuditorMail'), fAuditorPhone: $('#fAuditorPhone'), fClientMail: $('#fClientMail')
  };

  // ✅ fixed email typo
  const DESIGNER_EMAIL_FINAL = 'ergonomicindustrial@gmail.com';

  const LS_KEY = 'client_flow_v3_1';
  let rows = []; // {id,text,type,sel,note}

  function uid(){return Math.random().toString(36).slice(2)}
  function escapeHtml(s){return String(s).replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]))}
  function today(){return new Date().toISOString().slice(0,10)}

  // Phase hints
  const PHINT = {
    client_init: 'المرحلة (١): يقوم العميل بإدخال بيانات الموقع واسم/إيميل المدقق ثم يرسل النموذج للمدقق عبر الإيميل أو الواتساب.',
    auditor_action: 'المرحلة (٢): المدقق يراجع البنود ويعبّئ الحقول (✔/✖ أو 1–5) ثم يعيد الإرسال إلى العميل.',
    client_approve: 'المرحلة (٣): العميل يراجع نتيجة التدقيق ويعتمدها ثم يرسل النسخة النهائية إلى المصمم.'
  };

  // Types
  const TYPE_TXT = { yesno: '✔/✖', scale: '1–5', note: 'ملاحظة فقط' };

  // Defaults
  els.fDate.value = today();

  function inputForType(type, idx, sel){
    if(type==='yesno'){
      const ok = sel==='ok'? 'checked':''; const no = sel==='no'? 'checked':'';
      return `<label style="margin-inline:6px"><input type="radio" name="r${idx}" value="ok" ${ok}> ✔</label>
              <label style="margin-inline:6px"><input type="radio" name="r${idx}" value="no" ${no}> ✖</label>`;
    } else if(type==='scale') {
      const opts = ['','1','2','3','4','5'].map(v=>`<option ${sel===v?'selected':''}>${v}</option>`).join('');
      return `<select class="scaleSel" data-idx="${idx}">${opts}</select>`;
    }
    return '<span class="muted">—</span>';
  }

  function makeRow(r,i){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="num">${i+1}</td>
      <td contenteditable class="txt" data-id="${r.id}">${escapeHtml(r.text||'* بند جديد')}</td>
      <td style="text-align:center">
        <select class="typeSel" data-id="${r.id}">
          <option value="yesno" ${r.type==='yesno'?'selected':''}>${TYPE_TXT.yesno}</option>
          <option value="scale" ${r.type==='scale'?'selected':''}>${TYPE_TXT.scale}</option>
          <option value="note" ${r.type==='note'?'selected':''}>${TYPE_TXT.note}</option>
        </select>
      </td>
      <td colspan="2" style="text-align:center">${inputForType(r.type, i, r.sel||'')}</td>
      <td><input type="text" class="note" data-id="${r.id}" maxlength="50" placeholder="حتى 50 حرفًا" value="${r.note?escapeHtml(r.note):''}"></td>
    `;
    return tr;
  }

  function render(){
    els.tbody.innerHTML='';
    const frag = document.createDocumentFragment();
    rows.forEach((r,i)=> frag.appendChild(makeRow(r,i)) );
    els.tbody.appendChild(frag);
  }

  function addRow(text){ rows.push({id:uid(), text:text||'', type:'yesno', sel:'', note:''}); render(); persist(); }

  function collectMeta(){
    return {
      company: els.fCompany.value, site: els.fSite.value, desc: els.fDesc.value,
      gateNo: els.fGateNo.value, gateName: els.fGateName.value, date: els.fDate.value,
      auditorName: els.fAuditorName.value, auditorMail: els.fAuditorMail.value, auditorPhone: els.fAuditorPhone.value,
      clientMail: els.fClientMail.value, phase: els.phaseSel.value
    };
  }

  function persist(){
    try{ localStorage.setItem(LS_KEY, JSON.stringify({meta:collectMeta(), rows})) }catch(e){}
  }
  function restore(){
    const raw = localStorage.getItem(LS_KEY); if(!raw) return;
    try{
      const d = JSON.parse(raw);
      const m = d.meta||{};
      els.fCompany.value=m.company||''; els.fSite.value=m.site||''; els.fDesc.value=m.desc||'';
      els.fGateNo.value=m.gateNo||''; els.fGateName.value=m.gateName||''; els.fDate.value=m.date||today();
      els.fAuditorName.value=m.auditorName||''; els.fAuditorMail.value=m.auditorMail||''; els.fAuditorPhone.value=m.auditorPhone||'';
      els.fClientMail.value=m.clientMail||''; els.phaseSel.value=m.phase||'client_init';
      rows = Array.isArray(d.rows)? d.rows.map(x=>({id:x.id||uid(), text:x.text||'', type:x.type||'yesno', sel:x.sel||'', note:x.note||''})) : [];
      render(); updatePhaseHint();
    }catch(e){}
  }

  function updatePhaseHint(){ els.phaseHint.textContent = PHINT[els.phaseSel.value]||'' }

  // Table events
  els.tbody.addEventListener('input', e=>{
    if(e.target.classList.contains('txt')){
      const id=e.target.dataset.id; const r=rows.find(x=>x.id===id); if(r){ r.text=e.target.innerText.trim(); persist(); }
    }
    if(e.target.classList.contains('note')){
      const id=e.target.dataset.id; const r=rows.find(x=>x.id===id); if(r){ r.note=e.target.value; persist(); }
    }
  });
  els.tbody.addEventListener('change', e=>{
    if(e.target.classList.contains('typeSel')){
      const id=e.target.dataset.id; const r=rows.find(x=>x.id===id); if(r){ r.type=e.target.value; r.sel=''; render(); persist(); }
    }
    if(e.target.matches('input[type=radio]')){
      const name=e.target.name; const idx=parseInt(name.replace(/^r/,''),10); const r=rows[idx]; if(r){ r.sel=e.target.value; persist(); }
    }
    if(e.target.classList.contains('scaleSel')){
      const idx=parseInt(e.target.dataset.idx,10); const r=rows[idx]; if(r){ r.sel=e.target.value; persist(); }
    }
  });

  els.addRow.onclick = ()=> addRow('* بند جديد');
  els.clearRows.onclick = ()=>{ if(confirm('مسح كل البنود؟')){ rows=[]; render(); persist(); } };

  // Title & summary
  function buildTitle(){
    const m=collectMeta();
    return `${m.company||'-'} | باب ${m.gateNo||'-'} – ${m.gateName||''} | ${m.date||''}`;
  }

  function summaryText(){
    const m=collectMeta();
    const lines=[
      `العنوان: ${buildTitle()}`,
      `الشركة: ${m.company||'-'}`,
      `الموقع: ${m.site||'-'}`,
      `الوصف: ${m.desc||'-'}`,
      `الباب: ${m.gateNo||'-'} – ${m.gateName||''}`,
      `التاريخ: ${m.date||''}`,
      `المدقق: ${m.auditorName||'-'} (${m.auditorMail||'-'})`,
      '',
      '— البنود —'
    ];
    rows.forEach((r,i)=>{
      const sel = r.type==='yesno'? (r.sel===''?'':(r.sel==='ok'?'✔':'✖')) : (r.type==='scale'? (r.sel||'') : '—');
      lines.push(`${i+1}. ${r.text||''} | نوع: ${TYPE_TXT[r.type]} | قيمة: ${sel} | ملاحظة: ${r.note||''}`);
    });
    const footer = [
      '',
      'Ergonomic Industrial — ergonomicindustrial.com',
      'Email: ergonomicindustrial@gmail.com | WhatsApp: 67756743'
    ];
    return lines.concat(footer).join('\n');
  }

  els.copySummary.onclick = ()=>{
    const txt = summaryText();
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(txt).then(()=> alert('تم نسخ الملخص للنقل')).catch(()=>{
        prompt('انسخ الملخص يدويًا:', txt);
      });
    } else {
      prompt('انسخ الملخص يدويًا:', txt);
    }
  };

  // Export HTML (includes same logo path)
  function exportHTML(){
    const m=collectMeta();
    const rowsHtml = rows.map((r,i)=>{
      const typeTxt = TYPE_TXT[r.type];
      let field = '';
      if(r.type==='yesno') field = '<td style="text-align:center">☐ ✔</td><td style="text-align:center">☐ ✖</td>';
      else if(r.type==='scale') field = '<td colspan="2" style="text-align:center">1 2 3 4 5</td>';
      else field = '<td colspan="2" style="text-align:center">—</td>';
      return `<tr><td style="text-align:center">${i+1}</td><td>${escapeHtml(r.text||'')}</td><td style="text-align:center">${typeTxt}</td>${field}<td>${escapeHtml(r.note||'')}</td></tr>`;
    }).join('');

    const brandTop = `<div style="text-align:end"><img alt="Ergonomic Industrial" src="brand.png" style="height:48px"></div>`;
    const footer = `<div style="margin-top:14px;padding:10px 12px;border-top:1px solid #e5e7eb;color:#334155;font-size:12px;text-align:center">
      <div>Ergonomic Industrial — <a href="https://ergonomicindustrial.com" target="_blank">ergonomicindustrial.com</a></div>
      <div>Email: <a href="mailto:ergonomicindustrial@gmail.com">ergonomicindustrial@gmail.com</a> | Phone/WhatsApp: 67756743</div>
    </div>`;

    const html = `<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${buildTitle()}</title>
    <style>body{font-family:Tahoma,Arial;margin:0;background:#f7f8fb;color:#111;font-variant-numeric:lining-nums tabular-nums} .wrap{max-width:900px;margin:auto;padding:16px} .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:16px} h2{text-align:center;margin:.2rem 0 .6rem} table{width:100%;border-collapse:collapse;margin-top:10px} th,td{border:1px solid #ccc;padding:8px;vertical-align:middle} th{background:#e6f0ff;text-align:center} a{color:#2563eb} @page{size:A4;margin:12mm} tr,td,th{page-break-inside:avoid}</style></head>
    <body><div class="wrap"><div class="card">${brandTop}
    <h2>${buildTitle()}</h2>
    <div style="margin:6px 0 10px;color:#333">اسم الشركة: ${escapeHtml(m.company||'-')} | اسم الموقع: ${escapeHtml(m.site||'-')} | وصف الموقع: ${escapeHtml(m.desc||'-')} | التاريخ: ${escapeHtml(m.date||'')}</div>
    <table><thead><tr><th>م</th><th>البند</th><th>نوع</th><th colspan="2">حقل التقييم</th><th>ملاحظات</th></tr></thead><tbody>${rowsHtml}</tbody></table>
    ${footer}
    </div></div></body></html>`;

    const fname = suggestFileName()+'.html';
    const blob=new Blob([html],{type:'text/html'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=fname; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  function suggestFileName(){
    const m=collectMeta();
    const sanitize = s=>String(s||'').trim().replace(/\s+/g,'-').replace(/[^\w\-]/g,'');
    return [sanitize(m.company||'Client'),sanitize(m.site||'Site'),`G${sanitize(m.gateNo||'0')}`,(m.date||today())].filter(Boolean).join('_');
  }

  // ✅ WhatsApp helper: digits only to avoid 404
  function waLink(text, phoneRaw){
    const phone = String(phoneRaw||'').replace(/[^\d]/g,''); // keep digits only
    if(!phone){ return null; }
    return 'https://wa.me/' + phone + '?text=' + encodeURIComponent(text||'');
  }

  // Share by phase
  function shareByPhase(){
    const m=collectMeta();
    if(!m.company || !m.site || !m.auditorName){ alert('رجاءً أكمل: الشركة / الموقع / اسم المدقق'); return; }

    const subject = buildTitle();
    const body = summaryText()+"\n\n* ملاحظة: أرفِق ملف HTML إن تم تصديره.";

    if(els.phaseSel.value==='client_init'){
      // إلى المدقق
      const to = (m.auditorMail||'').trim();
      if(to){ window.location.href = 'mailto:' + to + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body); }
      const wa = waLink(body, m.auditorPhone);
      if(wa){ window.open(wa,'_blank'); }
    }
    else if(els.phaseSel.value==='auditor_action'){
      // إلى العميل
      const to = (m.clientMail||'').trim();
      if(to){ window.location.href = 'mailto:' + to + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body); }
      const wa = waLink('تم استكمال التدقيق\n\n' + body, m.auditorPhone);
      if(wa){ window.open(wa,'_blank'); }
    }
    else if(els.phaseSel.value==='client_approve'){
      // إلى المصمم
      const to = DESIGNER_EMAIL_FINAL;
      window.location.href = 'mailto:' + to + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
    }
  }

  // Bind general events
  ['input','change'].forEach(ev=>{
    ['fCompany','fSite','fDesc','fGateNo','fGateName','fDate','fAuditorName','fAuditorMail','fAuditorPhone','fClientMail','phaseSel']
    .forEach(id=>{ const el = els[id]; el && el.addEventListener(ev, ()=>{ if(id==='phaseSel') updatePhaseHint(); persist(); }) })
  });

  els.exportHtml.onclick = exportHTML;
  els.shareAction.onclick = shareByPhase;
  els.printBtn.onclick = ()=> window.print();

  // Paste as plain text within editable cells
  els.tbody.addEventListener('paste', e=>{
    if(e.target.classList.contains('txt')){
      e.preventDefault();
      const text=(e.clipboardData||window.clipboardData).getData('text/plain');
      document.execCommand('insertText', false, text);
    }
  });

  // Init
  function seed(){ if(rows.length) return; ['* التأكد من نظافة الموقع','* فحص معدات الإطفاء','* تدريب العاملين على المخاطر','* سلامة التمديدات الكهربائية'].forEach(t=> addRow(t)); }
  function init(){ restore(); if(!rows.length) seed(); render(); updatePhaseHint(); }
  init();
})();
  /* === تصدير نسخة HTML جاهزة للطباعة والأرشفة === */

</html>
