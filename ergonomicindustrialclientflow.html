<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ù…Ù„ (Work Flow) â€“ Ergonomic Industrial</title>
<style>
:root{--bg:#f7f8fb;--ink:#111;--card:#fff;--accent:#2563eb;--muted:#666}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Kufi Arabic","Cairo",sans-serif}
.wrap{max-width:920px;margin:auto;background:var(--card);padding:20px;border-radius:12px;box-shadow:0 0 12px rgba(0,0,0,.1)}
h1{margin:0 0 10px;text-align:center;color:var(--accent);font-size:20px}
.toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;margin:12px 0}
.btn{padding:8px 14px;border:1px solid #ddd;border-radius:10px;background:#fff;cursor:pointer;font-size:14px}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.warn{background:#fee2e2;border-color:#ef4444}
.group{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
.small{font-size:.9rem;color:var(--muted)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:end;max-width:780px;margin:0 auto}
.row label{display:block;font-size:.9rem;color:#333}
input[type="text"],input[type="email"],input[type="tel"]{padding:8px 10px;border:1px solid #ccc;border-radius:10px;width:100%}
select{padding:8px 10px;border:1px solid #ccc;border-radius:10px}
iframe{width:100%;height:78vh;border:none;border-radius:8px;background:#fff}
footer{text-align:center;font-size:.85rem;color:var(--muted);margin-top:10px}
@media(max-width:720px){.row{grid-template-columns:1fr} iframe{height:72vh}}
@media print{.no-print{display:none}}
</style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ§¾ Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ù…Ù„ (Work Flow) â€“ Ergonomic Industrial</h1>

  <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ± -->
  <div class="toolbar no-print">
    <label class="small">Ø§Ù„Ø¯ÙˆØ±:</label>
    <select id="role">
      <option value="client">ğŸ‘¤ Ø¹Ù…ÙŠÙ„</option>
      <option value="auditor">ğŸ•µï¸ Ù…Ø¯Ù‚Ù‘Ù‚</option>
      <option value="designer">ğŸ› ï¸ Ù…ØµÙ…Ù‘Ù…</option>
    </select>
    <span class="small" id="docTitleHint"></span>
  </div>

  <!-- ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªÙˆØ§ØµÙ„ -->
  <div class="row no-print" style="margin-bottom:6px">
    <div>
      <label>ğŸ“§ Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…Ù† Ø§Ù„Ù…Ø¯Ù‚Ù‘Ù‚ Ù„Ù„Ø¹Ù…ÙŠÙ„):</label>
      <input id="clientEmail" type="email" placeholder="example@company.com">
    </div>
    <div>
      <label>ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø±Ù‚Ù… Ø¯ÙˆÙ„ÙŠ Ù…Ø«Ù„ 9665xxxxxxx):</label>
      <input id="clientWa" type="tel" placeholder="9665xxxxxxxx">
    </div>
  </div>

  <!-- Ø£Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ± -->
  <div class="toolbar no-print">
    <div class="group" data-role="client">
      <button class="btn primary" id="printBtn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© / PDF</button>
      <button class="btn" id="sendWhatsApp">ğŸ’¬ Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button>
      <button class="btn" id="sendEmailAuditor">âœ‰ï¸ Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…ØµÙ…Ù‘Ù… (ergonomicindustrial@gmail.com)</button>
      <button class="btn" id="downloadHtml">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ ÙƒÙ€ HTML</button>
      <button class="btn" id="shareGeneral">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ©</button>
      <button class="btn" id="saveLocal">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§</button>
    </div>

    <div class="group" data-role="auditor">
      <button class="btn primary" id="printBtn2">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© / PDF</button>
      <button class="btn" id="resendToClientWA">ğŸ” Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¹Ù…ÙŠÙ„ (ÙˆØ§ØªØ³Ø§Ø¨)</button>
      <button class="btn" id="resendToClientMail">ğŸ” Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¹Ù…ÙŠÙ„ (Ø¥ÙŠÙ…ÙŠÙ„)</button>
      <button class="btn" id="downloadHtml2">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ ÙƒÙ€ HTML</button>
      <button class="btn" id="saveLocal2">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</button>
      <span class="small">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø§Ù†Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø³Ø®Ø© Ø«Ù… Ø§Ù„Ø­ÙØ¸/Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.</span>
    </div>

    <div class="group" data-role="designer">
      <button class="btn primary" id="printBtn3">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© / PDF</button>
      <button class="btn" id="downloadHtml3">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ ÙƒÙ€ HTML</button>
      <button class="btn" id="shareGeneral3">ğŸ“¤ Ù…Ø´Ø§Ø±ÙƒØ©</button>
    </div>
  </div>

  <iframe id="preview"></iframe>
  <footer class="no-print">Ergonomic Industrial Â© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</footer>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  const iframe = document.getElementById('preview');
  const roleSel = document.getElementById('role');
  const docTitleHint = document.getElementById('docTitleHint');
  const clientEmail = document.getElementById('clientEmail');
  const clientWa = document.getElementById('clientWa');

  // ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø®Ø© Ù…Ù† localStorage (?k) Ø«Ù… fallback Ø¥Ù„Ù‰ client_preview_html =====
  function loadHtmlFromStore(){
    const params=new URLSearchParams(location.search);
    const k=params.get('k');
    let html=null;
    if(k){ try{ html=localStorage.getItem(k); }catch(e){} }
    if(!html){ try{ html=localStorage.getItem('client_preview_html'); }catch(e){} }
    return html;
  }

  const html = loadHtmlFromStore();
  if(!html){
    document.body.innerHTML = `
      <div style="max-width:600px;margin:auto;text-align:center;padding:50px;">
        <h2 style="color:#b91c1c;">âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</h2>
        <p>Ø§ÙØªØ­ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± Ø²Ø± <strong>"ØªØµØ¯ÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø¨ (HTML)"</strong> Ø£Ùˆ <strong>"ØªØµØ¯ÙŠØ± Ø¨Ø§Ø¨-Ø¨Ø§Ø¨"</strong> Ù…Ù† <code>index.html</code>.</p>
      </div>`;
    return;
  }

  // Ø§ÙƒØªØ¨ Ø§Ù„Ù€ HTML Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø± (Ù†ÙØ³ Ø§Ù„Ø£ØµÙ„)
  const doc = iframe.contentDocument || iframe.contentWindow.document;
  doc.open(); doc.write(html); doc.close();

  // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©
  function currentTitle(){
    try{ return (doc.title || 'Ù†Ø³Ø®Ø© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚'); }catch(e){ return 'Ù†Ø³Ø®Ø© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚'; }
  }
  function getCurrentHtml(){
    try{ return doc.documentElement.outerHTML; }catch(e){ return html; }
  }
  function makeFile(){
    const blob=new Blob([getCurrentHtml()],{type:'text/html'});
    return new File([blob], (currentTitle().replace(/[^\w\u0600-\u06FF\- ]+/g,'_') || 'Ergonomic-Checklist') + '.html', {type:'text/html'});
  }

  // ØªÙ„Ù…ÙŠØ­ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
  docTitleHint.textContent = 'â€” ' + currentTitle();

  // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
  function applyRole(){
    const role=roleSel.value;
    document.querySelectorAll('[data-role]').forEach(el=>{
      el.style.display = (el.getAttribute('data-role')===role)? 'flex':'none';
    });
  }
  roleSel.addEventListener('change', applyRole);
  applyRole();

  // Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø©
  function toWaLink(phone, text){
    const msg=encodeURIComponent(text||'');
    const digits=(phone||'').replace(/[^\d]/g,'');
    return digits? `https://wa.me/${digits}?text=${msg}` : `https://wa.me/?text=${msg}`;
  }
  function openMail(to, subject, body){
    const s=encodeURIComponent(subject||''); const b=encodeURIComponent(body||'');
    window.location.href=`mailto:${encodeURIComponent(to||'')}?subject=${s}&body=${b}`;
  }
  function shareOrDownload(shareText){
    const file=makeFile();
    if(navigator.canShare && navigator.canShare({files:[file]})){
      navigator.share({title: currentTitle(), text: shareText||'Ù…Ø´Ø§Ø±ÙƒØ© Ù†Ø³Ø®Ø© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚', files:[file]});
    }else{
      const a=document.createElement('a');
      a.href=URL.createObjectURL(file); a.download=file.name; a.click(); URL.revokeObjectURL(a.href);
      alert('â„¹ï¸ ØªÙ… ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±ÙØ§Ù‚Ù‡ Ø¨Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨/Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙŠØ¯ÙˆÙŠÙ‹Ø§.');
    }
  }
  function downloadOnly(){
    const file=makeFile();
    const a=document.createElement('a');
    a.href=URL.createObjectURL(file); a.download=file.name; a.click(); URL.revokeObjectURL(a.href);
  }
  function saveLocalCopy(){
    try{
      localStorage.setItem('client_saved_html', getCurrentHtml());
      alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© (Ø¨Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª) Ù…Ø­Ù„ÙŠÙ‹Ø§.');
    }catch(e){ alert('âŒ ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­ÙØ¸.'); }
  }

  // ===== Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ =====
  (document.getElementById('printBtn')||{}).onclick=()=>iframe.contentWindow.print();
  (document.getElementById('sendWhatsApp')||{}).onclick=()=>{
    const text = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ù‡Ø°Ù‡ Ù†Ø³Ø®Ø© ${currentTitle()} Ù…Ù† Ergonomic Industrial.`;
    const link = toWaLink('', text);
    window.open(link,'_blank');
  };
  (document.getElementById('sendEmailAuditor')||{}).onclick=()=>{
    const subject = `${currentTitle()} â€“ Ergonomic Industrial`;
    const body = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…ØŒ\n\nØ£Ø±Ø³Ù„ Ù„ÙƒÙ… Ù†Ø³Ø®Ø© Ø§Ù„Ø¨Ø§Ø¨ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.\nØ§Ù„Ø¹Ù†ÙˆØ§Ù†: ${currentTitle()}\n\nØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù† Ù†Ø¸Ø§Ù… Ergonomic Industrial.\n\n(Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¨Ø¥Ù…ÙƒØ§Ù†ÙƒÙ… Ø§Ù„Ø±Ø¯ ÙˆØ¥Ø±ÙØ§Ù‚ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­ÙÙˆØ¸.)`;
    openMail('ergonomicindustrial@gmail.com', subject, body);
  };
  (document.getElementById('downloadHtml')||{}).onclick=downloadOnly;
  (document.getElementById('shareGeneral')||{}).onclick=()=>shareOrDownload('Ù…Ø´Ø§Ø±ÙƒØ© Ù†Ø³Ø®Ø© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚');
  (document.getElementById('saveLocal')||{}).onclick=saveLocalCopy;

  // ===== Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø¯Ù‚Ù‘Ù‚ =====
  (document.getElementById('printBtn2')||{}).onclick=()=>iframe.contentWindow.print();
  (document.getElementById('resendToClientWA')||{}).onclick=()=>{
    const text = `ØªÙ…Øª Ù…Ø±Ø§Ø¬Ø¹Ø© ${currentTitle()}.\nÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø·Ù„Ø§Ø¹ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«.`;
    const link = toWaLink(clientWa.value, text);
    window.open(link,'_blank');
  };
  (document.getElementById('resendToClientMail')||{}).onclick=()=>{
    const subject = `Ù…Ø±Ø§Ø¬Ø¹Ø© ${currentTitle()} â€“ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø·Ù„Ø§Ø¹`;
    const body = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…ØŒ\n\nØ£Ø±ÙÙ‚Øª Ù„ÙƒÙ… Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙŠ Ø¹Ù„Ù‰ ${currentTitle()}.\nÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.\n\nØªØ­ÙŠØ§ØªÙŠ.`;
    openMail(clientEmail.value || '', subject, body);
  };
  (document.getElementById('downloadHtml2')||{}).onclick=downloadOnly;
  (document.getElementById('saveLocal2')||{}).onclick=saveLocalCopy;

  // ===== Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØµÙ…Ù‘Ù… =====
  (document.getElementById('printBtn3')||{}).onclick=()=>iframe.contentWindow.print();
  (document.getElementById('downloadHtml3')||{}).onclick=downloadOnly;
  (document.getElementById('shareGeneral3')||{}).onclick=()=>shareOrDownload('Ù…Ø´Ø§Ø±ÙƒØ© Ù†Ø³Ø®Ø© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚');

  // Ø­ÙØ¸ Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  try{
    const savedCE = localStorage.getItem('wf_client_email'); if(savedCE) clientEmail.value=savedCE;
    const savedWA = localStorage.getItem('wf_client_wa'); if(savedWA) clientWa.value=savedWA;
  }catch(e){}
  clientEmail.addEventListener('input', ()=>{ try{ localStorage.setItem('wf_client_email', clientEmail.value||''); }catch(e){} });
  clientWa.addEventListener('input', ()=>{ try{ localStorage.setItem('wf_client_wa', clientWa.value||''); }catch(e){} });
});
</script>
</body>
</html>
