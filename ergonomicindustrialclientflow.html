<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>نسخة العميل – الإصدار النهائي الثابت</title>
<style>
  :root {
    --bg:#f7f8fb; --ink:#111; --muted:#666; --line:#e5e7eb; --card:#fff; --accent:#2563eb;
  }
  * { box-sizing:border-box; }
  body { margin:0; background:var(--bg); color:var(--ink); font-family:"Noto Kufi Arabic","Cairo",Tahoma,Arial,sans-serif; }
  .wrap { max-width:1100px; margin:auto; padding:20px; }
  .card { background:var(--card); border:1px solid #ddd; border-radius:14px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,.05); }
  h1 { text-align:center; color:#2563eb; font-size:22px; margin-bottom:15px; }
  h2 { font-size:18px; margin:12px 0; color:#333; }
  label { font-size:14px; display:block; margin-top:8px; }
  input[type=text], input[type=date], select { width:100%; padding:10px; border:1px solid var(--line); border-radius:10px; background:#fff; }
  textarea { width:100%; padding:10px; border:1px solid var(--line); border-radius:10px; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th, td { border:1px solid #ddd; padding:8px; text-align:right; }
  th { background:#eef2ff; }
  .toolbar { display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
  .btn { padding:10px 14px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer; font-size:14px; }
  .btn.primary { background:#2563eb; color:#fff; border-color:#2563eb; }
  .btn.warn { background:#fee2e2; border-color:#fecaca; }
  .hidden { display:none !important; }
  .muted { color:var(--muted); font-size:13px; }
  .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border:1px solid #ddd; border-radius:999px; background:#fff; font-size:12px; }
  .logo { height:60px; object-fit:contain; }
  @media print {
    .no-print { display:none !important; }
    body { background:#fff; }
    .card { box-shadow:none; border:0; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card" id="admin">
    <h1>🧾 إعداد نسخة العميل</h1>
    <div class="muted">املأ الحقول، أضف البنود، ثم أنشئ نسخة العميل للطباعة أو الإرسال.</div>

    <div class="toolbar">
      <label>رقم الباب <input id="gateNo" type="text" placeholder="مثلاً 3"></label>
      <label>اسم الباب <input id="gateName" type="text" placeholder="الحماية من الآلات"></label>
      <label>تاريخ اليوم <input id="todayInput" type="date"></label>
    </div>

    <div class="toolbar">
      <label>اسم العميل <input id="clientName" type="text" placeholder="اسم العميل"></label>
      <label>اسم الموقع <input id="siteName" type="text" placeholder="موقع العمل"></label>
    </div>

    <div class="toolbar">
      <button class="btn" id="addRow">➕ إضافة بند</button>
      <button class="btn" id="selectAll">✔️ تحديد الكل</button>
      <button class="btn" id="clearAll">❌ إلغاء التحديد</button>
      <button class="btn primary" id="saveDraft">💾 حفظ كمسودة</button>
      <button class="btn warn" id="reset">إعادة تعيين</button>
    </div>

    <table>
      <thead>
        <tr><th>تضمين</th><th>البند</th><th>نوع الاستجابة</th><th>حذف</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="toolbar">
      <button class="btn primary" id="makeClient">🚀 إنشاء نسخة العميل</button>
      <button class="btn" id="exportHTML">⬇️ تصدير HTML</button>
    </div>
  </div>

  <div class="card hidden" id="client">
    <h1>✅ نسخة العميل – قائمة التدقيق</h1>
    <div id="meta" class="muted"></div>

    <div class="toolbar">
      <label>اسم المدقق <input id="auditorName" type="text" placeholder="اسم المدقق"></label>
      <label>تاريخ التفتيش <input id="inspectDate" type="date"></label>
    </div>

    <h2>البنود المطلوب التحقق منها</h2>
    <form id="clientForm"></form>

    <div class="toolbar no-print">
      <button class="btn primary" id="printBtn">🖨️ طباعة</button>
      <button class="btn" id="sendWA">📲 واتساب</button>
      <button class="btn" id="sendEmail">✉️ إيميل</button>
      <button class="btn" id="back">↩️ رجوع</button>
    </div>
  </div>
</div>

<script>
const els = {
  tbody: document.getElementById('tbody'), gateNo: gateNo, gateName: gateName, todayInput: todayInput,
  clientName: clientName, siteName: siteName, makeClient: makeClient, clientForm: clientForm,
  admin: admin, client: client, meta: meta, auditorName: auditorName, inspectDate: inspectDate,
  printBtn: printBtn, sendWA: sendWA, sendEmail: sendEmail, back: back, saveDraft: saveDraft, reset: reset
};
const state = { rows: [] };

function uid(){ return Math.random().toString(36).slice(2); }
function render(){
  els.tbody.innerHTML = '';
  state.rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><input type='checkbox' class='pick' ${r.pick?'checked':''} data-id='${r.id}'></td>
      <td contenteditable='true' class='txt' data-id='${r.id}'>${r.text}</td>
      <td><select class='kind' data-id='${r.id}'><option value='yn' ${r.kind==='yn'?'selected':''}>صح/خطأ</option><option value='rate' ${r.kind==='rate'?'selected':''}>تقييم 1–5</option></select></td>
      <td><button class='btn warn del' data-id='${r.id}'>حذف</button></td>`;
    els.tbody.appendChild(tr);
  });
}

function save(){ localStorage.setItem('client_draft', JSON.stringify(state.rows)); }
function load(){ const s = localStorage.getItem('client_draft'); if(!s) return; state.rows = JSON.parse(s); render(); }

addRow.onclick = ()=>{ state.rows.unshift({id:uid(), text:'* بند جديد', pick:true, kind:'yn'}); render(); save(); };
selectAll.onclick = ()=>{ state.rows.forEach(r=>r.pick=true); render(); save(); };
clearAll.onclick = ()=>{ state.rows.forEach(r=>r.pick=false); render(); save(); };

els.tbody.addEventListener('input', e=>{ const id=e.target.dataset.id; const r=state.rows.find(r=>r.id===id); if(!r)return; if(e.target.classList.contains('txt'))r.text=e.target.innerText; save(); });
els.tbody.addEventListener('change', e=>{ const id=e.target.dataset.id; const r=state.rows.find(r=>r.id===id); if(!r)return; if(e.target.classList.contains('pick'))r.pick=e.target.checked; if(e.target.classList.contains('kind'))r.kind=e.target.value; save(); });
els.tbody.addEventListener('click', e=>{ if(e.target.classList.contains('del')){ const id=e.target.dataset.id; state.rows=state.rows.filter(r=>r.id!==id); render(); save(); }});

els.makeClient.onclick=()=>{
  const selected = state.rows.filter(r=>r.pick);
  if(!selected.length) return alert('اختر بندًا واحدًا على الأقل');
  els.meta.textContent = `رقم الباب ${els.gateNo.value} – ${els.gateName.value} | العميل: ${els.clientName.value} | الموقع: ${els.siteName.value}`;
  els.clientForm.innerHTML = '';
  selected.forEach((r,i)=>{
    const div=document.createElement('div');
    div.className='card';
    div.innerHTML=`<strong>${i+1}. ${r.text}</strong><br>
      ${(r.kind==='yn')?
        '<label><input type=radio name=f'+i+'> صح</label> <label><input type=radio name=f'+i+'> خطأ</label>':
        '<select><option>—</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>'}
      <br><input type=text maxlength=50 placeholder='ملاحظة (50 حرف)'>`;
    els.clientForm.appendChild(div);
  });
  els.admin.classList.add('hidden'); els.client.classList.remove('hidden');
};

els.back.onclick=()=>{ els.client.classList.add('hidden'); els.admin.classList.remove('hidden'); };
els.printBtn.onclick=()=>window.print();
els.sendWA.onclick=()=>{ const txt='نسخة العميل\n'+els.meta.textContent; window.open('https://wa.me/?text='+encodeURIComponent(txt),'_blank'); };
els.sendEmail.onclick=()=>{ const sub='نسخة العميل'; const body=els.meta.textContent; location.href=`mailto:ergonomicindustrial@gmail.com?subject=${encodeURIComponent(sub)}&body=${encodeURIComponent(body)}`; };
els.saveDraft.onclick=()=>{ save(); alert('تم الحفظ'); };
els.reset.onclick=()=>{ localStorage.removeItem('client_draft'); state.rows=[]; render(); };

load();
</script>
</body>
</html>
