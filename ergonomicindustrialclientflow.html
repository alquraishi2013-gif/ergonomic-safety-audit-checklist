<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>نسخة العميل – مطابقة للاتفاق (✓ / ✗ + ملاحظات ≤50)</title>
<style>
  :root{--bg:#f7f8fb;--ink:#111;--muted:#666;--line:#e5e7eb;--card:#fff;--accent:#2563eb;--head:#e6f0ff}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Kufi Arabic","Cairo",Tahoma,Arial,sans-serif}
  .wrap{max-width:980px;margin:auto;padding:18px}
  .sheet{background:var(--card);border:1px solid #d9dde5;border-radius:14px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
  .title{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:8px}
  .logo{height:64px;object-fit:contain}
  h1{margin:.2rem 0 .6rem;font-size:22px}
  .meta{display:grid;grid-template-columns:1fr 1fr;gap:10px;max-width:420px;margin-inline-start:auto}
  .meta label{display:flex;gap:6px;align-items:center;font-size:14px;color:#333}
  .meta input{flex:1;padding:8px;border:1px solid var(--line);border-radius:10px;background:#fff}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #cfd7e3;padding:8px;vertical-align:middle}
  th{background:var(--head);text-align:center}
  td.num{width:48px;text-align:center}
  td.chk{text-align:center;width:46px}
  td.note input{width:100%;padding:8px;border:1px solid var(--line);border-radius:8px}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid #d0d7ff;background:#fff;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .muted{color:var(--muted);font-size:13px}
  .box{border:1px dashed #cfd7e3;border-radius:10px;padding:10px;margin:8px 0}
  .hidden{display:none!important}
  @media print{.no-print{display:none!important}.sheet{border:0;box-shadow:none}body{background:#fff}}
</style>
</head>
<body>
<div class="wrap">
  <!-- لوحة الإعداد (المصمم) -->
  <div id="setup" class="sheet">
    <div class="title">
      <img id="lg" class="logo" alt="logo" hidden>
      <h1>🧾 إعداد البنود – نسخة العميل</h1>
    </div>
    <div class="box">
      <div class="muted">**الورك فلو المتفق عليه**: مني كمصمم ➜ العميل ➜ المدقق ➜ العميل ➜ أرجع لي. نسخة العميل ستحتوي فقط البنود التي أحددها هنا.</div>
    </div>

    <div class="toolbar">
      <label class="btn no-print"><input type="file" id="logoInput" accept="image/*"> رفع الشعار</label>
      <button class="btn" id="addRow">➕ إضافة بند</button>
      <button class="btn" id="selectAll">✔️ تحديد الكل</button>
      <button class="btn" id="clearAll">❌ إلغاء التحديد</button>
      <button class="btn" id="save">💾 حفظ مسودة</button>
      <button class="btn" id="reset">إعادة تعيين</button>
      <span class="muted">يمكنك تعديل نص البند مباشرة في الجدول</span>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:74px">تضمين</th>
          <th>نص البند</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="toolbar">
      <label>رقم الباب <input id="gateNo" type="text" placeholder="1"></label>
      <label>اسم الباب <input id="gateName" type="text" placeholder="الأحكام العامة"></label>
      <label>تاريخ الإصدار <input id="issueDate" type="date"></label>
      <button class="btn primary" id="build">🚀 إنشاء نسخة العميل</button>
      <button class="btn" id="exportHtml">⬇️ تصدير HTML للعميل</button>
    </div>
  </div>

  <!-- نسخة العميل النهائية (✓ / ✗ + ملاحظة ≤ 50) -->
  <div id="client" class="sheet hidden">
    <div class="title">
      <img id="lg2" class="logo" alt="logo" hidden>
      <h1 id="titleTxt">قائمة تدقيق السلامة – الباب</h1>
    </div>

    <div class="meta">
      <label>اسم العميل: <input id="cClient" type="text" placeholder="اسم العميل"></label>
      <label>اسم الموقع: <input id="cSite" type="text" placeholder="الموقع"></label>
      <label>المدقق: <input id="cAuditor" type="text" placeholder="اسم المدقق"></label>
      <label>التاريخ: <input id="cDate" type="date"></label>
    </div>

    <table id="clientTable">
      <thead>
        <tr>
          <th>م</th>
          <th>البند</th>
          <th>✓</th>
          <th>✗</th>
          <th>ملاحظات</th>
        </tr>
      </thead>
      <tbody id="clientBody"></tbody>
    </table>

    <div class="toolbar no-print">
      <button class="btn primary" id="printBtn">🖨️ طباعة</button>
      <button class="btn" id="waBtn">📲 إرسال واتساب</button>
      <button class="btn" id="mailBtn">✉️ إرسال بريد</button>
      <button class="btn" id="back">↩️ رجوع للتعديل</button>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = s=>document.querySelector(s);
  const els = {
    setup: $('#setup'), client: $('#client'),
    lg: $('#lg'), lg2: $('#lg2'), logoInput: $('#logoInput'),
    tbody: $('#tbody'), addRow: $('#addRow'), selectAll: $('#selectAll'), clearAll: $('#clearAll'),
    save: $('#save'), reset: $('#reset'), gateNo: $('#gateNo'), gateName: $('#gateName'), issueDate: $('#issueDate'),
    build: $('#build'), exportHtml: $('#exportHtml'),
    titleTxt: $('#titleTxt'), cClient: $('#cClient'), cSite: $('#cSite'), cAuditor: $('#cAuditor'), cDate: $('#cDate'),
    clientBody: $('#clientBody'), printBtn: $('#printBtn'), waBtn: $('#waBtn'), mailBtn: $('#mailBtn'), back: $('#back')
  };
  const today = new Date().toISOString().slice(0,10);
  els.issueDate.value = today; els.cDate.value = today;

  let logoData = '';
  let rows = []; // {id,text,include}

  function uid(){return Math.random().toString(36).slice(2)}
  function persist(){ localStorage.setItem('agreed_client_rows', JSON.stringify({logoData, rows, gateNo:els.gateNo.value, gateName:els.gateName.value, issueDate:els.issueDate.value})); }
  function load(){
    const s = localStorage.getItem('agreed_client_rows'); if(!s) return;
    try{ const d = JSON.parse(s); logoData=d.logoData||''; rows=Array.isArray(d.rows)?d.rows:[]; if(logoData){els.lg.src=logoData;els.lg.hidden=false}
      els.gateNo.value=d.gateNo||''; els.gateName.value=d.gateName||''; els.issueDate.value=d.issueDate||today; renderSetup(); }catch(e){}
  }

  function renderSetup(){
    els.tbody.innerHTML='';
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td style="width:74px;text-align:center"><input type="checkbox" class="pick" data-id="${r.id}" ${r.include?'checked':''}></td>
                    <td contenteditable class="txt" data-id="${r.id}">${r.text}</td>`;
      els.tbody.appendChild(tr);
    });
  }

  function addRow(text){ rows.push({id:uid(), text:text||'* بند جديد', include:true}); renderSetup(); persist(); }

  els.addRow.onclick=()=>addRow();
  els.selectAll.onclick=()=>{ rows.forEach(r=>r.include=true); renderSetup(); persist(); };
  els.clearAll.onclick=()=>{ rows.forEach(r=>r.include=false); renderSetup(); persist(); };
  els.tbody.addEventListener('input', e=>{ const id=e.target.dataset.id; const r=rows.find(x=>x.id===id); if(!r) return; r.text=e.target.innerText.trim(); persist(); });
  els.tbody.addEventListener('change', e=>{ if(e.target.classList.contains('pick')){ const id=e.target.dataset.id; const r=rows.find(x=>x.id===id); if(r){ r.include=e.target.checked; persist(); } }});

  els.logoInput.addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f){logoData=''; els.lg.hidden=true; return;}
    const rd=new FileReader(); rd.onload=ev=>{logoData=ev.target.result; els.lg.src=logoData; els.lg.hidden=false; persist();}; rd.readAsDataURL(f);
  });

  els.save.onclick=()=>{persist(); alert('تم حفظ المسودة محليًا');};
  els.reset.onclick=()=>{ if(confirm('مسح كل البيانات؟')){ localStorage.removeItem('agreed_client_rows'); rows=[]; logoData=''; els.lg.hidden=true; renderSetup(); } };

  // إنشاء نسخة العميل
  els.build.onclick=()=>{
    const list = rows.filter(r=>r.include && r.text.trim());
    if(!list.length) return alert('اختر بندًا واحدًا على الأقل');
    els.titleTxt.textContent = `قائمة تدقيق السلامة – الباب ${els.gateNo.value||'-'} – ${els.gateName.value||''}`;
    els.clientBody.innerHTML='';
    if(logoData){els.lg2.src=logoData; els.lg2.hidden=false}else{els.lg2.hidden=true}

    list.forEach((r,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td class="num">${i+1}</td>
                      <td>${r.text}</td>
                      <td class="chk"><input type="checkbox" name="ok_${i}" class="ok"></td>
                      <td class="chk"><input type="checkbox" name="no_${i}" class="no"></td>
                      <td class="note"><input type="text" maxlength="50" placeholder="حتى 50 حرفًا"></td>`;
      els.clientBody.appendChild(tr);
    });

    // اجعل ✓ و ✗ متنافيين لكل صف
    els.clientBody.querySelectorAll('tr').forEach(tr=>{
      const ok=tr.querySelector('.ok'); const no=tr.querySelector('.no');
      ok.addEventListener('change',()=>{ if(ok.checked) no.checked=false; });
      no.addEventListener('change',()=>{ if(no.checked) ok.checked=false; });
    });

    els.setup.classList.add('hidden');
    els.client.classList.remove('hidden');
  };

  // تصدير HTML ثابت للعميل (نفس الجدول بدون سكربت)
  els.exportHtml.onclick=()=>{
    const list = rows.filter(r=>r.include && r.text.trim());
    if(!list.length) return alert('اختر بندًا واحدًا على الأقل');
    const safe=s=>String(s).replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));
    const rowsHtml=list.map((r,i)=>`<tr><td style="text-align:center">${i+1}</td><td>${safe(r.text)}</td><td>☐</td><td>☐</td><td></td></tr>`).join('');
    const html=`<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>نسخة العميل</title>
      <style>body{font-family:Tahoma,Arial;margin:0;background:#f7f8fb;color:#111} .wrap{max-width:900px;margin:auto;padding:16px} .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:16px} h2{text-align:center} table{width:100%;border-collapse:collapse;margin-top:10px} th,td{border:1px solid #ccc;padding:8px;text-align:center} th{background:#e6f0ff}</style></head>
      <body><div class="wrap"><div class="card">${logoData?`<div style="text-align:center"><img src="${logoData}" style="height:60px"></div>`:''}
      <h2>قائمة تدقيق السلامة – الباب ${safe(els.gateNo.value||'-')} – ${safe(els.gateName.value||'')}</h2>
      <table><thead><tr><th>م</th><th>البند</th><th>✓</th><th>✗</th><th>ملاحظات</th></tr></thead><tbody>${rowsHtml}</tbody></table>
      <div style="margin-top:12px">اسم العميل: __________ | الموقع: __________ | المدقق: __________ | التاريخ: __________</div></div></div></body></html>`;
    const blob=new Blob([html],{type:'text/html'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='نسخة-العميل.html'; a.click(); URL.revokeObjectURL(url);
  };

  // أدوات العميل
  function summaryTxt(){
    const lines=[]; lines.push(els.titleTxt.textContent);
    lines.push(`اسم العميل: ${els.cClient.value||'-'} | الموقع: ${els.cSite.value||'-'} | المدقق: ${els.cAuditor.value||'-'} | التاريخ: ${els.cDate.value||'-'}`);
    lines.push('---');
    els.clientBody.querySelectorAll('tr').forEach((tr,i)=>{
      const item=tr.children[1].textContent.trim();
      const ok=tr.querySelector('.ok').checked? '✓':'-';
      const no=tr.querySelector('.no').checked? '✗':'-';
      const note=tr.querySelector('input[type="text"]').value.trim();
      lines.push(`${i+1}) ${item} | ${ok}/${no}${note? ' | ملاحظة: '+note:''}`);
    });
    return lines.join('
');
  }

  els.printBtn.onclick=()=>window.print();
  els.waBtn.onclick=()=>{ const url='https://wa.me/?text='+encodeURIComponent(summaryTxt()); window.open(url,'_blank'); };
  els.mailBtn.onclick=()=>{ const sub='نسخة العميل'; const body=summaryTxt(); location.href=`mailto:ergonomicindustrial@gmail.com?subject=${encodeURIComponent(sub)}&body=${encodeURIComponent(body)}`; };
  els.back.onclick=()=>{ els.client.classList.add('hidden'); els.setup.classList.remove('hidden'); };

  // بيانات افتراضية أول مرة
  function seed(){ if(rows.length) return; ['التأكد من وجود دليل إرشادي للسلامة','تحديد مخاطر العمل','توفير معدات الوقاية الشخصية','فحص معدات الإطفاء وصلاحيتها'].forEach(t=>addRow(t)); }
  load(); seed();
})();
</script>
</body>
</html>
