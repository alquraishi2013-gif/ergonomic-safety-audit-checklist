<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ูุณุฎุฉ ุงููุตูู โ ุงุฎุชุจุงุฑ ุงูุจุงุจ ูุฅุฏุฎุงู ุจูุงูุงุช ุงูุนููู (ุฅุตูุงุญ ุงูุฃุฎุทุงุก)</title>
<style>
  :root{--bg:#f7f8fb;--ink:#111;--muted:#666;--line:#e5e7eb;--card:#fff;--accent:#2563eb;--head:#e6f0ff}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Kufi Arabic","Cairo",Tahoma,Arial,sans-serif}
  .wrap{max-width:1100px;margin:auto;padding:18px}
  .card{background:var(--card);border:1px solid #d9dde5;border-radius:14px;padding:18px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
  .title{display:flex;align-items:center;gap:12px}
  .title h1{margin:0;font-size:20px}
  .logo{height:64px;object-fit:contain}
  .muted{color:var(--muted);font-size:13px}
  .row{display:grid;gap:10px}
  @media(min-width:768px){.row{grid-template-columns:repeat(12,1fr)}.col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-5{grid-column:span 5}.col-6{grid-column:span 6}.col-8{grid-column:span 8}.col-12{grid-column:span 12}}
  input[type=text],input[type=date],input[type=search],input[type=number],select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #cfd7e3;padding:8px;vertical-align:middle}
  th{background:var(--head);text-align:center}
  td.num{width:54px;text-align:center}
  td[contenteditable]{outline:0;min-height:28px}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid #d0d7ff;background:#fff;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;border:1px solid #c7d2fe;font-size:.8rem;color:#374151}
  .hidden{display:none!important}
  .box{border:1px dashed #cfd7e3;border-radius:10px;padding:10px;margin:8px 0}
  @media print{.no-print{display:none!important}.card{border:0;box-shadow:none}body{background:#fff}}
  .tests{margin-top:10px}
  .tests pre{white-space:pre-wrap;background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:10px}
</style>
</head>
<body>
<div class="wrap">
  <!-- ููุญุฉ ุงููุตูู -->
  <section id="designer" class="card">
    <div class="title">
      <img id="lg" class="logo" alt="logo" hidden>
      <h1>ูุณุฎุฉ ุงููุตูู โ ุงุฎุชุจุงุฑ ุงูุจุงุจ ูุชุญุถูุฑ ูุณุฎุฉ ุงูุนููู</h1>
      <span style="margin-inline-start:auto"></span>
      <button type="button" class="btn no-print" id="printSetup">๐จ๏ธ ุทุจุงุนุฉ</button>
    </div>
    <div class="muted">ุฃุฏุฎู ุจูุงูุงุช ุงูุนููู ูุงููููุนุ ุงุฎุชุฑ ุงูุจุงุจ ูุงููุงูุจุ ุนุฏูู ุงูุจููุฏุ ุซู ุงุถุบุท "ูุนุงููุฉ ูุณุฎุฉ ุงูุนููู" ููุงุฎุชุจุงุฑ. ููููู ุฃูุถูุง ุชุตุฏูุฑ HTML ุฌุงูุฒ ููุนููู.</div>
    <div id="toast" class="hidden" style="margin-top:8px;padding:8px 12px;border:1px solid #c7d2fe;background:#eef2ff;border-radius:10px;color:#374151"></div>

    <div class="row" style="margin-top:10px">
      <div class="col-4"><label>ุงุณู ุงูุดุฑูุฉ<br><input id="dClient" type="text" placeholder="ูุซุงู: ุดุฑูุฉ ุงูุฎููุฌ"></label></div>
      <div class="col-4"><label>ุงุณู ุงููููุน<br><input id="dSite" type="text" placeholder="ูุซุงู: ูุตูุน ุงูุดุนูุจุฉ"></label></div>
      <div class="col-4"><label>ูุตู ุงููููุน<br>
        <div style="display:flex;gap:6px">
          <select id="dDescSel" style="flex:1">
            <option value="">โ ุงุฎุชุฑ ูุตููุง โ</option>
            <option>ููุชุจ</option>
            <option>ูุฑุดุฉ</option>
            <option>ูุตูุน</option>
            <option>ูุณุชูุฏุน</option>
            <option>ูููุน ุฎุงุฑุฌู</option>
            <option value="__other">ุฃุฎุฑูโฆ</option>
          </select>
          <input id="dDescOther" type="text" placeholder="ุงูุชุจ ูุตููุง" class="hidden" style="flex:1">
        </div>
      </label></div>
      <div class="col-3"><label>ุฑูู ุงูุจุงุจ<br><input id="gateNo" type="text" placeholder="1"></label></div>
      <div class="col-5"><label>ุงุณู ุงูุจุงุจ<br><input id="gateName" type="text" placeholder="ูุซุงู: ุงูุญูุงูุฉ ูู ุงูุขูุงุช"></label></div>
      <div class="col-4"><label>ุชุงุฑูุฎ ุงูุฅุตุฏุงุฑ<br><input id="issueDate" type="date"></label></div>
      <div class="col-6"><label class="btn no-print" style="display:inline-flex;align-items:center;gap:8px"><input type="file" id="logoInput" accept="image/*"> ุฑูุน ุงูุดุนุงุฑ</label></div>
    </div>

    <div class="toolbar no-print">
      <span class="pill">๐ ููุงูุจ ุงูุฃุจูุงุจ ุงูุณุฑูุนุฉ:</span>
      <button type="button" class="btn" data-tpl="ch1">ุจุงุจ 1</button>
      <button type="button" class="btn" data-tpl="ch2">ุจุงุจ 2</button>
      <button type="button" class="btn" data-tpl="ch3">ุจุงุจ 3</button>
      <button type="button" class="btn" data-tpl="ch4">ุจุงุจ 4</button>
      <button type="button" class="btn" data-tpl="ch5">ุจุงุจ 5</button>
      <button type="button" class="btn" data-tpl="ch6">ุจุงุจ 6</button>
      <button type="button" class="btn" data-tpl="ch7">ุจุงุจ 7</button>
      <button type="button" class="btn" data-tpl="ch8">ุจุงุจ 8</button>
      <button type="button" class="btn" data-tpl="ergo">Ergonomic</button>
      <span style="flex:1"></span>
      <label class="pill"><input type="checkbox" id="optChecks" checked> โ/โ</label>
      <label class="pill"><input type="checkbox" id="optRisk"> ุชูููู ุงููุฎุงุทุฑ (1โ5)</label>
    </div>

    <div class="toolbar no-print">
      <button type="button" class="btn" id="addRow">โ ุฅุถุงูุฉ ุจูุฏ</button>
      <button type="button" class="btn" id="selectAll">โ๏ธ ุชุญุฏูุฏ ุงููู</button>
      <button type="button" class="btn" id="clearAll">โ ุฅูุบุงุก ุงูุชุญุฏูุฏ</button>
      <button type="button" class="btn" id="saveDraft">๐พ ุญูุธ ูุณูุฏุฉ</button>
      <button type="button" class="btn" id="reset">ุฅุนุงุฏุฉ ุชุนููู</button>
      <span style="flex:1"></span>
      <input id="filter" type="search" placeholder="ููุชุฑุฉ ุงูุจููุฏโฆ" style="max-width:280px">
    </div>

    <table>
      <thead><tr><th style="width:74px">ุชุถููู</th><th>ูุต ุงูุจูุฏ</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="toolbar no-print">
      <button type="button" class="btn primary" id="preview">๐๏ธ ูุนุงููุฉ ูุณุฎุฉ ุงูุนููู (ุงุฎุชุจุงุฑ)</button>
      <button type="button" class="btn" id="exportHtml">โฌ๏ธ ุชุตุฏูุฑ HTML ููุนููู (ุฃูููุงูู)</button>
    </div>

    <!-- ุงุฎุชุจุงุฑุงุช ุชููุงุฆูุฉ -->
    <details class="tests no-print">
      <summary>โ ุงุฎุชุจุงุฑุงุช ุณุฑูุนุฉ</summary>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin:6px 0">
        <button type="button" class="btn" id="btnRunTests">ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช</button>
        <span class="pill">ูู ูุนุฏูู ุฃู ุงุฎุชุจุงุฑ ููุฌูุฏุ ุณูุถูู ุงุฎุชุจุงุฑุงุช ููุท</span>
      </div>
      <pre id="testOut" class="muted"></pre>
    </details>
  </section>

  <!-- ูุนุงููุฉ/ุงุฎุชุจุงุฑ ูุณุฎุฉ ุงูุนููู -->
  <section id="client" class="card hidden">
    <div class="title" style="justify-content:center">
      <img id="lg2" class="logo" alt="logo" hidden>
      <h1 id="titleTxt">ูุงุฆูุฉ ุชุฏููู ุงูุณูุงูุฉ โ ุงูุจุงุจ</h1>
    </div>

    <div class="row">
      <div class="col-4"><label>ุงุณู ุงูุดุฑูุฉ<br><input id="cClient" type="text"></label></div>
      <div class="col-4"><label>ุงุณู ุงููููุน<br><input id="cSite" type="text"></label></div>
      <div class="col-4"><label>ูุตู ุงููููุน<br><input id="cDesc" type="text" placeholder="ููุชุจ / ูุฑุดุฉ / โฆ"></label></div>
      <div class="col-4"><label>ุงุณู ุงููุฏูู<br><input id="cAuditor" type="text"></label></div>
      <div class="col-4"><label>ุงูุชุงุฑูุฎ<br><input id="cDate" type="date"></label></div>
    </div>

    <table id="clientTable">
      <thead>
        <tr>
          <th>ู</th><th>ุงูุจูุฏ</th><th id="hOk">โ</th><th id="hNo">โ</th><th id="hRisk" class="hidden">ุงููุฎุงุทุฑ (1โ5)</th><th>ููุงุญุธุงุช (โค50)</th>
        </tr>
      </thead>
      <tbody id="clientBody"></tbody>
    </table>

    <div class="toolbar no-print">
      <button type="button" class="btn" id="back">โฉ๏ธ ุฑุฌูุน ููุชุนุฏูู</button>
      <span style="flex:1"></span>
      <button type="button" class="btn" id="printClient">๐จ๏ธ ุทุจุงุนุฉ</button>
    </div>
  </section>
</div>

<script>
(function(){
  const $ = s=>document.querySelector(s);
  const S = s=>document.querySelectorAll(s);

  // ุงูุนูุงุตุฑ
  const els = {
    // ููุญุฉ ุงููุตูู
    designer: $('#designer'), client: $('#client'),
    lg: $('#lg'), lg2: $('#lg2'), logoInput: $('#logoInput'),
    dClient: $('#dClient'), dSite: $('#dSite'), dDescSel: $('#dDescSel'), dDescOther: $('#dDescOther'),
    gateNo: $('#gateNo'), gateName: $('#gateName'), issueDate: $('#issueDate'),
    optChecks: $('#optChecks'), optRisk: $('#optRisk'),
    addRow: $('#addRow'), selectAll: $('#selectAll'), clearAll: $('#clearAll'), saveDraft: $('#saveDraft'), reset: $('#reset'),
    filter: $('#filter'),
    tbody: $('#tbody'),
    preview: $('#preview'), exportHtml: $('#exportHtml'), printSetup: $('#printSetup'),
    // ูุนุงููุฉ ุงูุนููู
    titleTxt: $('#titleTxt'), cClient: $('#cClient'), cSite: $('#cSite'), cDesc: $('#cDesc'), cAuditor: $('#cAuditor'), cDate: $('#cDate'),
    clientBody: $('#clientBody'), hRisk: $('#hRisk'), back: $('#back'), printClient: $('#printClient'),
    // ุงุฎุชุจุงุฑุงุช
    btnRunTests: $('#btnRunTests'), testOut: $('#testOut')
  };

  // ุชุงุฑูุฎ ุงูุชุฑุงุถู
  const today = new Date().toISOString().slice(0,10);
  els.issueDate.value = today; els.cDate.value = today;

  // ุงูุญุงูุฉ
  let logoData = '';
  let rows = []; // {id,text,include}

  // ุซูุงุจุช ุงูุชุฎุฒูู
  const LS_KEY = 'designer_console_v2';

  // ููุงูุจ ุงูุฃุจูุงุจ (ุนุฑุจู)
  const templates = {
    ch1:[
      "ุงูุชุฃูุฏ ูู ูุฌูุฏ ุฏููู ุฅุฑุดุงุฏู ููุณูุงูุฉ ููุชูุจ ุจุงูุนุฑุจูุฉ ููุบุฉ ูููููุง ุงูุนูุงู",
      "ุชุญุฏูุฏ ูุฎุงุทุฑ ุงูุนูู ุญุณุจ ุทุจูุนุฉ ุงููุดุงุท",
      "ุชุฒููุฏ ุงูููุฆุฉ ุจุงููุฎุทุทุงุช ุงูููุงุฆูุฉ ุงููุนุชูุฏุฉ",
      "ุฅุจูุงุบ ูุชุฏุฑูุจ ุงูุนูุงู ุนูู ุงููุฎุงุทุฑ ูุงูููุงูุฉ ูุจู ูุจุงุดุฑุฉ ุงูุนูู",
      "ุชูููุฑ ูุนุฏุงุช ุงูููุงูุฉ ุงูุดุฎุตูุฉ ูุฌุงููุง ูุชุฏุฑูุจ ุงูุนูุงู ุนูู ุงุณุชุฎุฏุงููุง",
      "ุงุนุชูุงุฏ ูุงุฆุญุฉ ุฌุฒุงุกุงุช ุฎุงุตุฉ ุจูุฎุงููุงุช ุงูุณูุงูุฉ",
      "ูุถุน ุนูุงูุงุช ุฅุฑุดุงุฏูุฉ ูุชุญุฐูุฑูุฉ ูุงุถุญุฉ ูููุตูุงุช ุจูุบุฉ ูููููุง ุงูุนูุงู",
      "ุชุนููู ูุดุฑู/ูุฑุงูุจ ุณูุงูุฉ ุญุณุจ ุญุฌู ูุฎุทูุฑุฉ ุงูููุดุฃุฉ",
      "ุชุฃููู ูุดุฑู ุงูุณูุงูุฉ ุจุดูุงุฏุฉ ูุฎุจุฑุฉ ููุงุณุจุฉ",
      "ููููุดุขุช ุนุงููุฉ ุงูุฎุทูุฑุฉ (300+ ุนุงูู): ุฅูุดุงุก ูุณู ุณูุงูุฉ ูุตุญุฉ ููููุฉ",
      "ุชุฏุฑูุจ ุฏูุฑู ููุดุฑูู ููุฑุงูุจู ุงูุณูุงูุฉ",
      "ุฅุฌุฑุงุก ุชูุชูุด ุฏูุฑู ูุชุณุฌูู ุงูุญูุงุฏุซ ูุงูุฅุตุงุจุงุช",
      "ุฅุฎุทุงุฑ ุงูููุฆุฉ ุจุงูุญูุงุฏุซ ุงูุฌุณููุฉ ุฎูุงู 24 ุณุงุนุฉ",
      "ุญูุธ ุณุฌูุงุช ูุญุฏุซุฉ ูุชุงุญุฉ ููููุชุดูู"
    ],
    ch2:["ูุชุงูุฉ ุงููุจุงูู ูุงูุฃุณูู","ุชุฌููุฒ ุณุงุญุงุช ุงูุนูู ุจูุธูุงุช/ุฃุณูู","ููุฑุงุช ูุงุถุญุฉ ููุฎุงุฑุฌ ุทูุงุฑุฆ ุขููุฉ","ุฃุฑุถูุงุช ุณูููุฉ ููุธููุฉ ูุตุฑู ูุบุทู","ุงูุชุฎูุต ุงูุณููู ูู ุงููุถูุงุช ูุงูููุงุฏ ุงูููููุงุฆูุฉ","ุตูุงูุฉ ุฏูุฑูุฉ ูููุจุงูู ูุงููุฑุงูู","ููุงูุฉ ูู ุงูุณููุท ูุงูุฃุดูุงุก ุงููุชุณุงูุทุฉ ูุงูุญูุฑ","ุณูุงูู ูุชููุฉ ุบูุฑ ุฒููุฉ ููุฒูุฏุฉ ุจุญูุงุฌุฒ","ุณูุงูุงุช ุขููุฉ ูุน ุญูุงุฌุฒ ูุชุซุจูุช ุฌูุฏ","ุณูุฏุฑุงุช/ููุตุงุช ูุฑุฎุตุฉ ูุขููุฉ","ุนุฒู ูุตุงุฏุฑ ุงูุบุจุงุฑ/ุงูุบุงุฒุงุช ูุน ุดูุท","ูุญุต ุฃูุนูุฉ ุงูุถุบุท","ุฃุฏูุงุช ุตุงูุญุฉ ููุญุฏุฏุฉ ุฃูุงูููุง","ูุนุฏุงุช ุฅุทูุงุก ููุงุณุจุฉ ูููุฒุนุฉ"],
    ch3:["ุชุฏุฑูุจ ุงูุนูุงู ุนูู ููุงูุฉ ุงูุขูุงุช","ูุง ุชุดุบูู ุฏูู ุญูุงุฌุฒ","ุนุฏู ุชุนุทูู ุฃุฌูุฒุฉ ุงูููุงูุฉ","ูุณุงูุฉ 60 ุณู ุญูู ุงูุขูุงุช","ุญูุงุฌุฒ ุฏุงุฆูุฉ ููุฃุฌุฒุงุก ุงูุฎุทุฑุฉ","ุฅุฒุงูุฉ ุงูุญูุงุฌุฒ ููุท ุจุนุฏ ุงูุฅููุงู","ููุชุงุญ ุฅููุงู ุทุงุฑุฆ","ุตูุงูุฉ ุฏูุฑูุฉ ุจุณุฌูุงุช","ููุงูุฉ ูู ุงูุดุฑุฑ ูุงูุดุธุงูุง"],
    ch4:[
      "ุชุฏุงูู ุงูููุงุฏ ูุงูุฎุงูุงุช ุจุทุฑููุฉ ุขููุฉ ูุง ุชุดูู ุฎุทุฑุงู ุนูู ุณูุงูุฉ ุงูุนุงูููู",
      "ุงุณุชุฎุฏุงู ูุนุฏุงุช ุงูุฑูุน ุงููููุงููููุฉ ุงูููุงุณุจุฉ ูุตูุงูุชูุง ุฏูุฑูุงู (ุชูุชูุด ุฃุณุจูุนู ูุงุฎุชุจุงุฑ ุณููู)",
      "ุชุซุจูุช ููุญุฉ ุชุจูู ุฃูุตู ุญูููุฉ ุชุดุบูู ูุฃูููุฉ ุนูู ูู ุขูุฉ ุฑูุน",
      "ุฅุนุฏุงุฏ ุณุฌู ุฎุงุต ููู ุขูุฉ ุฑูุน ูุดูู ุจูุงูุงุช ุงูุตูุนุ ุงูุญูู ุงูุฃูุตูุ ุงููุญุต ุงูุฏูุฑูุ ุงูุตูุงูุฉ ูุงูุฅุตูุงุญุงุช",
      "ุชุฒููุฏ ูุดุบูู ุขูุฉ ุงูุฑูุน ุจูุณููุฉ ุงุชุตุงู ุตุงูุญุฉ ูุจู ุจุฏุก ุงูุนูู",
      "ุชุญุฏูุฏ ูุณุงุฑุงุช ุขูุงุช ุงูุฑูุน ุจูุณุงุฆู ุชุญุฐูุฑ ูููุน ูุฑูุฑ ุงูุฃุดุฎุงุต ุฃู ูููููู ุชุญุช ุงูุฃุญูุงู ุงููุนููุฉ",
      "ุชุดุบูู ุขูุงุช ุงูุฑูุน ูุงูุฌุฑ ูุงูููู ููุชุตุฑ ุนูู ุฃุดุฎุงุต ูุฎุชุตูู ููุคูููู ููุฑุฎูุตูู",
      "ุชุฃููู ูุณุงุฆู ุงูููู ุงููููุงููููุฉ ูุฅุฌุฑุงุก ูุญุต ุฏูุฑู ููุง ูููุงู ููุชุทูุจุงุช ุงูุณูุงูุฉ",
      "ุชุฎุฒูู ุงูููุงุฏ ูุงููุนุฏุงุช ููู ุฃุตูู ุงูุชุฎุฒูู ุงูุณูููุ ูุน ุนุฒู ุงูููุงุฏ ุงูุฎุทุฑุฉ ูู ูุฎุงุฒู ุฎุงุตุฉ",
      "ูุถุน ูุงูุชุงุช ุฅุฑุดุงุฏูุฉ ุนูู ุงููุฎุงุฒู ุชุจูู ุฏุฑุฌุฉ ุงูุฎุทูุฑุฉ ูุทุฑู ุงูุชุฏุงูู ูุงูููู ุงูุขูู"
    ],
    ch5:["ููุงุชูุญ ุนุฒู ุขููุฉ ูุจุฃูุงูู ุธุงูุฑุฉ","ููุงุทุน ุฃูุชููุงุชูููุฉ ููุฃุนุทุงู","ููุญุงุช ุชูุฒูุน ูู ุฃูุงูู ุขููุฉ","ุนุฏู ุงุณุชุฎุฏุงู ุงูููุญุงุช ููุชุฎุฒูู","ุนุฒู ูุงูู ููุฃุณูุงู ูุงููุงุจูุงุช","ูุญุต ุฏูุฑู ููุนุงูุฌุฉ ููุฑูุฉ","ุนุงูููู ูุคูููู","ุนุฒู ุงูุชูุงุฑ ูุจู ุงูุตูุงูุฉ ูุชุญุฐูุฑุงุช","ููุงุฒุงุช/ุฃุญุฐูุฉ ุนุงุฒูุฉ ูููุน ุงููุฌููุฑุงุช","ุชุฃุฑูุถ ุงูุณุชุงุชูู","ูุนุฏุงุช ุฅุทูุงุก ุญุฑุงุฆู ููุฑุจุงุฆูุฉ","ูุญูุต ุทุจูุฉ ููุนุงูููู ุจุงูููุฑุจุงุก","ููุญุงุช ุชุญุฐูุฑ ูุงุถุญุฉ"],
    ch6:["ุฅุถุงุกุฉ ูุงููุฉ ููุชุฌุงูุณุฉ","ุงูุญุฏ ูู ุงูุถูุถุงุก/ุงูุงูุชุฒุงุฒุงุช","ุญุฑุงุฑุฉ ุนูู ุถูู ุงูุญุฏูุฏ","ููุงูุฉ ููุนูุงู ุจุงูููุงูุน ุงูููุดููุฉ","ุชูููุฉ ูุงููุฉ","ุญูุงุฌุฒ ุญุฑุงุฑูุฉ ููุฃูุฑุงู ูุงููุญุงู"],
    ch7:["ุญุฏูุฏ ุงูุชุนุฑุถ ููููุงุฏ ุงูููููุงุฆูุฉ","ุดูุท/ุชูููุฉ ุนูุฏ ุงููุตุฏุฑ","ุงุณุชุจุฏุงู ุจุจุฏุงุฆู ุฃูู ุฎุทุฑุงู","ุชูููู ุงูููุชุด ูู ุจูุงูุงุช ุงูููุงุฏ","ุชูุธูู ุฑุทุจ/ุดูุท ุฏูุฑู"],
    ch8:["ุฃูุงูู ุฑุงุญุฉ/ุทุนุงู ููู ุงุดุชุฑุงุทุงุช","ุบุฑู ุชุจุฏูู ูุฎุฒุงุฆู","ุญูุงูุงุช ูููุงุฏ ุชูุธูู","ููุงู ุดุฑุจ ูุจุฑุฏุฉ ูุงููุฉ","ุนุฏุฏ ูุงูู ูู ุฏูุฑุงุช ุงูููุงู","ุตุฑู ุตุญู ููุงุฆู ููููุงูุน ุงููุงุฆูุฉ"],
    ergo:["ุงุฑุชูุงุน ุงูุทุงููุฉ ููุงุณุจ","ูุฑุณู ูุงุจู ููุชุนุฏูู ุจุฏุนู ุฃุณูู ุงูุธูุฑ","ูุณุงูุฉ ุฑุคูุฉ ุงูุดุงุดุฉ ููุตู ุจูุง","ููุงููุฉ ูุฏููุฉ ุถูู ุงูุญุฏูุฏ"]
  };

  // ุฃุฏูุงุช ุนุงูุฉ
  function uid(){return Math.random().toString(36).slice(2);}
  function escapeHtml(s){ return String(s).replace(/[&<>]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c])); }
  function toast(msg){ const t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),1500); }

  // ุญูุธ/ุงุณุชุฑุฌุงุน
  function persist(){
    const payload = {
      logoData, rows,
      dClient: els.dClient.value, dSite: els.dSite.value,
      descSel: els.dDescSel.value, descOther: els.dDescOther.value,
      gateNo: els.gateNo.value, gateName: els.gateName.value, issue: els.issueDate.value,
      opts: { checks: els.optChecks.checked, risk: els.optRisk.checked }
    };
    try{ localStorage.setItem(LS_KEY, JSON.stringify(payload)); }catch(e){ console.warn('persist failed', e); }
  }
  function restore(){
    const raw = localStorage.getItem(LS_KEY); if(!raw) return;
    try{
      const d = JSON.parse(raw);
      logoData = d.logoData||''; if(logoData){ els.lg.src=logoData; els.lg.hidden=false; }
      rows = Array.isArray(d.rows)? d.rows: [];
      els.dClient.value = d.dClient||''; els.dSite.value=d.dSite||'';
      els.dDescSel.value = d.descSel||''; els.dDescOther.value = d.descOther||'';
      if(els.dDescSel.value==='__other'){ els.dDescOther.classList.remove('hidden'); }
      els.gateNo.value=d.gateNo||''; els.gateName.value=d.gateName||''; els.issueDate.value=d.issue||today;
      if(d.opts){ els.optChecks.checked=!!d.opts.checks; els.optRisk.checked=!!d.opts.risk; }
      renderSetup();
    }catch(e){ console.warn('restore failed', e); }
  }

  // ุฅุฏุงุฑุฉ ุงูุจููุฏ
  function renderSetup(){
    const q = els.filter.value.trim().toLowerCase();
    els.tbody.innerHTML='';
    rows.forEach(r=>{
      if(q && !String(r.text||'').toLowerCase().includes(q)) return;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td style="width:74px;text-align:center"><input type="checkbox" class="pick" data-id="${r.id}" ${r.include?'checked':''}></td>
                    <td contenteditable class="txt" data-id="${r.id}">${escapeHtml(r.text||'')}</td>`;
      els.tbody.appendChild(tr);
    });
  }
  function addRow(text){ rows.push({id:uid(), text:(text||'* ุจูุฏ ุฌุฏูุฏ'), include:true}); renderSetup(); persist(); }

  // ุฃุญุฏุงุซ ูุตู ุงููููุน
  els.dDescSel.addEventListener('change',()=>{
    if(els.dDescSel.value==='__other'){
      els.dDescOther.classList.remove('hidden');
      els.dDescOther.focus();
    } else {
      els.dDescOther.classList.add('hidden');
    }
    persist();
  });
  els.dDescOther.addEventListener('input', persist);

  // ุดุนุงุฑ
  els.logoInput.addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f){logoData=''; els.lg.hidden=true; persist(); return;}
    const rd=new FileReader(); rd.onload=ev=>{ logoData=ev.target.result; els.lg.src=logoData; els.lg.hidden=false; persist(); }; rd.readAsDataURL(f);
  });

  // ุฃุฒุฑุงุฑ ุงูุจููุฏ
  els.addRow.onclick=()=>addRow();
  els.selectAll.onclick=()=>{ rows.forEach(r=>r.include=true); renderSetup(); persist(); };
  els.clearAll.onclick=()=>{ rows.forEach(r=>r.include=false); renderSetup(); persist(); };
  els.tbody.addEventListener('input', e=>{ if(e.target.classList.contains('txt')){ const id=e.target.dataset.id; const r=rows.find(x=>x.id===id); if(r){ r.text=e.target.innerText.trim(); persist(); } } });
  els.tbody.addEventListener('change', e=>{ if(e.target.classList.contains('pick')){ const id=e.target.dataset.id; const r=rows.find(x=>x.id===id); if(r){ r.include=e.target.checked; persist(); } } });
  els.filter.addEventListener('input', renderSetup);

  // ุชุญููู ุงูููุงูุจ (ุฅุตูุงุญ ุงูุณูุณูุฉ ูุชุนุฏุฏุฉ ุงูุฃุณุทุฑ)
  function applyTemplate(key){
    const arr = templates[key]||[]; if(!arr.length){ alert('ูุง ุชูุฌุฏ ุจููุฏ ููุฐุง ุงูุจุงุจ'); return; }
    const replace = confirm('ุงุณุชุจุฏุงู ุงููุงุฆูุฉ ุงูุญุงููุฉ ุจุงููุงูุจุ\nOK = ุงุณุชุจุฏุงู\nCancel = ุฅุถุงูุฉ');
    // ุฃุฒู ุฃู ููุชุฑุฉ ุญุชู ุชุธูุฑ ุงูุจููุฏ
    els.filter.value='';
    if(replace){ rows = []; }
    arr.forEach(t=> rows.push({id:uid(), text:t, include:true}));
    // ุงุณู/ุฑูู ุงูุจุงุจ ุชููุงุฆููุง ุฅู ูู ููููุฃุง
    if(!els.gateName.value){
      const nameMap={ch1:'ุงูุฃุญูุงู ุงูุนุงูุฉ', ch2:'ุงููุจุงูู ูุงููุฑุงูู', ch3:'ุงูุญูุงูุฉ ูู ุงูุขูุงุช', ch4:'ุชุฏุงูู ูุฑูุน ูุชุฎุฒูู ุงูููุงุฏ', ch5:'ุงูุณูุงูุฉ ุงูููุฑุจุงุฆูุฉ', ch6:'ุจูุฆุฉ ุงูุนูู', ch7:'ุงูููุงุฏ ุงูููููุงุฆูุฉ', ch8:'ุงููุฑุงูู ุงูุนุงูุฉ', ergo:'Ergonomic'};
      els.gateName.value = nameMap[key]||'';
    }
    if(!els.gateNo.value){ const noMap={ch1:'1',ch2:'2',ch3:'3',ch4:'4',ch5:'5',ch6:'6',ch7:'7',ch8:'8'}; els.gateNo.value = noMap[key]||els.gateNo.value; }
    renderSetup(); persist();
    // ูุฑุฑ ููุฌุฏูู ููุธูุฑ ูููุณุชุฎุฏู
    els.tbody.scrollIntoView({behavior:'smooth', block:'start'});
    toast(`ุชู ุชุญููู ${arr.length} ุจูุฏูุง ูู ${key.toUpperCase()}`);
  }
  S('[data-tpl]').forEach(btn=>{ btn.addEventListener('click',()=> applyTemplate(btn.getAttribute('data-tpl')) ); });

  // ุญูุธ/ุฅุนุงุฏุฉ ุชุนููู/ุทุจุงุนุฉ (ุทุจุงุนุฉ ุจุฏูู document.write)
  els.saveDraft.onclick=()=>{ persist(); alert('ุชู ุญูุธ ุงููุณูุฏุฉ ูุญูููุง'); };
  els.reset.onclick=()=>{ if(confirm('ูุณุญ ูู ุงูุจูุงูุงุชุ')){ localStorage.removeItem(LS_KEY); rows=[]; logoData=''; els.lg.hidden=true; renderSetup(); els.dClient.value=els.dSite.value=els.gateNo.value=els.gateName.value=''; els.dDescSel.value=''; els.dDescOther.value=''; persist(); } };
  els.printSetup.onclick=()=>{ window.print(); };

  // ูุนุงููุฉ ูุณุฎุฉ ุงูุนููู
  els.preview.onclick=()=>{
    // ูู ูุง ูู ููุง ุจูุฏ ูุญุฏุฏุ ูุญุฏุฏ ุงููู ุชููุงุฆููุง
    let list = rows.filter(r=>r.include && String(r.text||'').trim());
    if(!list.length && rows.length){ rows.forEach(r=>r.include=true); renderSetup(); persist(); list = rows.slice(); }
    if(!list.length){ alert('ุงุฎุชุฑ ุจูุฏูุง ูุงุญุฏูุง ุนูู ุงูุฃูู'); return; }

    els.titleTxt.textContent = `ูุงุฆูุฉ ุชุฏููู ุงูุณูุงูุฉ โ ุงูุจุงุจ ${els.gateNo.value||'-'} โ ${els.gateName.value||''}`;
    els.cClient.value = els.dClient.value; els.cSite.value = els.dSite.value;
    const desc = (els.dDescSel.value==='__other'? els.dDescOther.value : els.dDescSel.value) || '';
    els.cDesc.value = desc;
    // ุฃุฒู ุงูููุชุฑุฉ ุญุชู ูุง ุชุฎุชูู ุงูุจููุฏ
    els.filter.value='';
    els.clientBody.innerHTML='';
    if(logoData){ els.lg2.src=logoData; els.lg2.hidden=false; } else { els.lg2.hidden=true; }

    const includeRisk = !!els.optRisk.checked; if(includeRisk){ els.hRisk.classList.remove('hidden'); } else { els.hRisk.classList.add('hidden'); }

    list.forEach((r,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td class="num">${i+1}</td>
                      <td>${escapeHtml(r.text)}</td>
                      ${els.optChecks.checked? `<td class="chk"><input type="checkbox" class="ok"></td><td class="chk"><input type="checkbox" class="no"></td>` : `<td class="chk">โ</td><td class="chk">โ</td>`}
                      ${includeRisk? `<td style="text-align:center"><select class="riskSel"><option value=""></option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></td>` : ''}
                      <td><input type="text" maxlength="50" placeholder="ุญุชู 50 ุญุฑููุง"></td>`;
      els.clientBody.appendChild(tr);
    });

    // ุชูุงูู โ/โ
    els.clientBody.querySelectorAll('tr').forEach(tr=>{
      const ok=tr.querySelector('.ok'), no=tr.querySelector('.no');
      if(ok && no){ ok.addEventListener('change',()=>{ if(ok.checked) no.checked=false; }); no.addEventListener('change',()=>{ if(no.checked) ok.checked=false; }); }
    });

    els.designer.classList.add('hidden'); els.client.classList.remove('hidden');
  };

  // ุชูููุฏ HTML ููุณุฎุฉ ุงูุนููู (ูููุณุชุฎุฏู ูู ุงูุชุตุฏูุฑ ูุงูุงุฎุชุจุงุฑุงุช)
  function buildClientHTML(list, includeChecks, includeRisk, meta){
    const rowsHtml = list.map((txt,i)=>{
      const cells = [ `<td style="text-align:center">${i+1}</td>`, `<td>${escapeHtml(txt)}</td>` ];
      if(includeChecks){ cells.push('<td style="text-align:center">โ</td>','<td style="text-align:center">โ</td>'); }
      if(includeRisk){ cells.push('<td style="text-align:center">&nbsp;</td>'); }
      cells.push('<td></td>');
      return `<tr>${cells.join('')}</tr>`;
    }).join('');
    const checksHdr = includeChecks? '<th>โ</th><th>โ</th>' : '';
    const riskHdr   = includeRisk? '<th>ุงููุฎุงุทุฑ (1โ5)</th>' : '';
    const logoHTML  = logoData? `<div style="text-align:center;margin-bottom:8px"><img src="${logoData}" style="height:60px;object-fit:contain"></div>`:'';
    return `<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>ูุณุฎุฉ ุงูุนููู</title>
<style>body{font-family:Tahoma,Arial;margin:0;background:#f7f8fb;color:#111} .wrap{max-width:900px;margin:auto;padding:16px} .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:16px} h2{text-align:center;margin:.2rem 0 .6rem} table{width:100%;border-collapse:collapse;margin-top:10px} th,td{border:1px solid #ccc;padding:8px;vertical-align:middle} th{background:#e6f0ff;text-align:center}</style></head>
<body><div class="wrap"><div class="card">${logoHTML}
<h2>ูุงุฆูุฉ ุชุฏููู ุงูุณูุงูุฉ โ ุงูุจุงุจ ${escapeHtml(meta.gateNo||'-')} โ ${escapeHtml(meta.gateName||'')}</h2>
<div style="margin:6px 0 10px;color:#333">ุงูุดุฑูุฉ: ${escapeHtml(meta.client||'-')} | ุงููููุน: ${escapeHtml(meta.site||'-')} | ุงููุตู: ${escapeHtml(meta.desc||'-')} | ุงูุฅุตุฏุงุฑ: ${escapeHtml(meta.issue||'-')}</div>
<table><thead><tr><th>ู</th><th>ุงูุจูุฏ</th>${checksHdr}${riskHdr}<th>ููุงุญุธุงุช</th></tr></thead><tbody>${rowsHtml}</tbody></table>
</div></div></body></html>`;
  }

  // ุชุตุฏูุฑ HTML ููุนููู (ุฃูููุงูู) โ ุจุฏูู document.write
  els.exportHtml.onclick=()=>{
    const list = rows.filter(r=>r.include && String(r.text||'').trim()).map(r=>r.text.trim());
    if(!list.length){ alert('ุงุฎุชุฑ ุจูุฏูุง ูุงุญุฏูุง ุนูู ุงูุฃูู'); return; }
    const includeRisk = !!els.optRisk.checked; const includeChecks = !!els.optChecks.checked;
    const desc = (els.dDescSel.value==='__other'? els.dDescOther.value : els.dDescSel.value) || '';
    const html = buildClientHTML(list, includeChecks, includeRisk, {
      gateNo: els.gateNo.value, gateName: els.gateName.value, client: els.dClient.value, site: els.dSite.value, desc, issue: els.issueDate.value
    });
    const blob=new Blob([html],{type:'text/html'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='ูุณุฎุฉ-ุงูุนููู.html'; a.click(); URL.revokeObjectURL(url);
  };

  // ุงูุนูุฏุฉ ูู ุงููุนุงููุฉ
  els.back.onclick=()=>{ els.client.classList.add('hidden'); els.designer.classList.remove('hidden'); };
  els.printClient.onclick=()=>window.print();

  // ุชุฒุงูู ููู ุนุงูุฉ
  ['input','change'].forEach(ev=>{
    ['dClient','dSite','gateNo','gateName','issueDate','optChecks','optRisk'].forEach(id=>{ els[id].addEventListener(ev, persist); });
  });

  // ุงุฎุชุจุงุฑุงุช ุจุณูุทุฉ (ูุง ูุนุฏูู ุงูููุฌูุฏุฉุ ูุถูู ููุท)
  els.btnRunTests.addEventListener('click',()=>{
    const logs=[]; const ok=(name,cond)=>logs.push((cond?'โ ':'โ ')+name+(cond?'':' (ูุดู)'));

    // ุงุฎุชุจุงุฑ 1: ุชุญููู ูุงูุจ ุจุงุจ 1 ูุถูู ุจููุฏ
    const before=rows.length; applyTemplate('ch1'); const after=rows.length; ok('ุชุญููู ูุงูุจ ุจุงุจ 1 ูุถูู ุนูุงุตุฑ', after>before);

    // ุงุฎุชุจุงุฑ 2: ุงููุนุงููุฉ ุชูุธูุฑ ุงูุตูุญุฉ ููููุฃ ุงูุนูุงููู
    els.preview.click();
    ok('ุชุจุฏูู ุฅูู ูุถุน ุงูุนููู', !els.client.classList.contains('hidden'));
    ok('ุงูุนููุงู ูุญุชูู ุฑูู/ุงุณู ุงูุจุงุจ', /ูุงุฆูุฉ ุชุฏููู ุงูุณูุงูุฉ/.test(els.titleTxt.textContent));

    // ุงุฎุชุจุงุฑ 3: ุชุตุฏูุฑ HTML ููุชุฌ ูุตูุง ุตุงูุญูุง
    const list = rows.filter(r=>r.include && String(r.text||'').trim()).map(r=>r.text.trim());
    const html = buildClientHTML(list, true, true, {gateNo:'1',gateName:'ุงุฎุชุจุงุฑ',client:'X',site:'Y',desc:'ููุชุจ',issue:'2025-01-01'});
    ok('buildClientHTML ูุญุชูู <!doctype html>', /^<!doctype html>/i.test(html));

    els.testOut.textContent = logs.join('\n');
  });

  // ุจุฏุก
  function seed(){ if(rows.length) return; ['ุงูุชุฃูุฏ ูู ูุฌูุฏ ุฏููู ุฅุฑุดุงุฏู ููุณูุงูุฉ','ุชุญุฏูุฏ ูุฎุงุทุฑ ุงูุนูู','ุชูููุฑ ูุนุฏุงุช ุงูููุงูุฉ ุงูุดุฎุตูุฉ','ูุญุต ูุนุฏุงุช ุงูุฅุทูุงุก ูุตูุงุญูุชูุง'].forEach(t=>addRow(t)); }
  restore(); seed();
})();
</script>
</body>
</html>
