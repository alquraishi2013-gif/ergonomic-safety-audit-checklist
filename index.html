<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù‚Ø§Ø¦Ù…Ø© ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø³Ù„Ø§Ù…Ø© â€“ Ø¨Ø§Ø¨-Ø¨Ø§Ø¨</title>
<style>
  :root{--bg:#f7f8fb;--ink:#111;--muted:#666;--line:#e5e7eb;--card:#fff;--accent:#2563eb}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Kufi Arabic","Cairo",Tahoma,Arial,sans-serif}
  .wrap{max-width:1100px;margin:auto;padding:20px}
  .card{background:var(--card);border:1px solid #ddd;border-radius:14px;padding:20px}
  .header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
  .logo{height:70px;object-fit:contain}
  h1{margin:.2rem 0 1rem;font-size:22px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
  .btn{padding:8px 14px;border-radius:10px;cursor:pointer;margin:2px 0;font-size:14px;border:1px solid #ddd;background:#fff}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn.warn{background:#fff3cd;border-color:#fcd34d}
  label{display:block}
  input[type="text"],input[type="search"],input[type="number"],input[type="color"],select{padding:6px 10px;border:1px solid #ccc;border-radius:10px}
  input[type="text"],input[type="search"]{width:100%}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #ccc;padding:8px;vertical-align:top}
  th{background:#eef2ff}
  [contenteditable]{outline:0;min-height:30px}
  .muted{color:var(--muted);font-size:.9rem}
  .grid{display:grid;gap:10px}
  .grid-2{grid-template-columns:1fr 1fr}
  .right{margin-inline-start:auto}
  .sticky-head thead th{position:sticky;top:0;z-index:1}
  .inline-help{font-size:.85rem;color:#555;margin-top:6px}
  .sep{height:1px;background:#eee;margin:12px 0}
  .tests{margin-top:12px;padding:10px;border:1px dashed #cbd5e1;border-radius:10px;background:#fafafa}
  .rowlead{display:flex;align-items:center;gap:8px}
  .ord{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:8px;background:#eef2ff;font-weight:600}
  tr.dragging{opacity:.6}
  details summary{cursor:pointer}
  dialog{border:1px solid #ddd;border-radius:12px;padding:0;max-width:720px;width:min(92vw,720px)}
  .dlg-head{padding:12px 16px;border-bottom:1px solid #eee;font-weight:700}
  .dlg-body{padding:12px 16px}
  .dlg-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .dlg-actions{padding:12px 16px;border-top:1px solid #eee;display:flex;gap:8px;justify-content:flex-end}
  textarea{width:100%;height:220px;padding:10px;border:1px solid #ccc;border-radius:10px;resize:vertical}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;border:1px solid #c7d2fe;font-size:.8rem;color:#374151}
  @media (max-width:720px){.grid-2{grid-template-columns:1fr}.dlg-grid{grid-template-columns:1fr}}
  @media print{.no-print{display:none} body{background:#fff}}
</style>
</head>
<body>
<div class="wrap">
  <section class="card">
    <div class="header">
      <img id="companyLogo" src="" class="logo" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©" hidden>
      <div>
        <h1 id="title">Ù‚Ø§Ø¦Ù…Ø© ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø³Ù„Ø§Ù…Ø© â€“ </h1>
        <div id="ref" class="muted"></div>
      </div>
      <button class="btn right no-print" id="printBtn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© / PDF</button>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù„ØºØ© ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
    <div class="toolbar no-print">
      <button class="btn" id="langAr">ğŸ‡¸ğŸ‡¦ Ø¹Ø±Ø¨ÙŠ</button>
      <button class="btn" id="langEn">ğŸ‡¬ğŸ‡§ English</button>
      <span style="flex:1"></span>
      <label class="muted"><input type="checkbox" id="optAutoFill" checked> âš¡ ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ø¨Ø§Ø¨</label>
      <button class="btn" id="saveDraft">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©</button>
      <button class="btn warn" id="clearDraft">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©</button>
    </div>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø±Ø£Ø³ÙŠØ© -->
    <div class="grid grid-2 no-print">
      <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:
        <input id="client" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø±ÙƒØ© Ø§Ù„Ø®Ù„ÙŠØ¬ Ù„Ù„ØµÙ†Ø§Ø¹Ø§Øª">
      </label>
      <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹:
        <input id="site" type="text" placeholder="Ù…Ø«Ø§Ù„: Ù…ØµÙ†Ø¹ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ© â€“ Ø§Ù„Ø´Ø¹ÙŠØ¨Ø©">
      </label>
      <label>Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø±:
        <input id="logoInput" type="file" accept="image/*">
      </label>
      <label>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Ø¨:
        <input id="chapterNo" type="text" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: Ù¤ Ø£Ùˆ 4">
      </label>
      <label>Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¨:
        <input id="chapterName" type="text" placeholder="Ù…Ø«Ø§Ù„: ØªØ¯Ø§ÙˆÙ„ ÙˆØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯">
      </label>
      <div>
        <label>Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ù†ÙˆØ¯:
          <input id="filter" type="search" placeholder="Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ù„Ù„ÙÙ„ØªØ±Ø©â€¦">
        </label>
        <div class="inline-help">Ù…Ø«Ø§Ù„: Ø³Ù‚Ø§Ù„Ø§ØªØŒ Ù…Ø®Ø§Ø±Ø¬ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ØŒ Ø­ÙˆØ§Ø¬Ø² Ø§Ù„Ø¢Ù„Ø§Øªâ€¦</div>
      </div>
    </div>

    <!-- Ù‚ÙˆØ§Ù„Ø¨ ÙˆØ®ÙŠØ§Ø±Ø§Øª -->
    <div class="toolbar no-print">
      <span class="muted">ğŸ“š Ù‚ÙˆØ§Ù„Ø¨ Ø³Ø±ÙŠØ¹Ø©:</span>
      <button class="btn" id="tplCh1">Ø¨Ø§Ø¨ 1</button>
      <button class="btn" id="tplCh2">Ø¨Ø§Ø¨ 2</button>
      <button class="btn" id="tplCh3">Ø¨Ø§Ø¨ 3</button>
      <button class="btn" id="tplCh4">Ø¨Ø§Ø¨ 4</button>
      <button class="btn" id="tplCh5">Ø¨Ø§Ø¨ 5</button>
      <button class="btn" id="tplCh6">Ø¨Ø§Ø¨ 6</button>
      <button class="btn" id="tplCh7">Ø¨Ø§Ø¨ 7</button>
      <button class="btn" id="tplCh8">Ø¨Ø§Ø¨ 8</button>
      <button class="btn" id="tplErgo">Ergonomic</button>
      <span id="tplUserContainer" class="muted" style="display:flex;gap:6px;flex-wrap:wrap"></span>
      <button class="btn" id="saveAsTemplate">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙƒÙ‚Ø§Ù„Ø¨</button>
      <button class="btn" id="pasteFromWord">ğŸ“‹ Ù„ØµÙ‚ Ù…Ù† Word</button>
      <span style="flex:1"></span>
      <label class="muted"><input type="checkbox" id="optChecks" checked> Ø£Ø¹Ù…Ø¯Ø© âœ”/âœ–</label>
      <label class="muted"><input type="checkbox" id="optRisk"> ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø± (1â€“5)</label>
      <label class="muted">Ø¥Ø·Ø§Ø±:
        <input id="optBorderW" type="number" min="0" max="6" value="1" style="width:60px"> px
        <input id="optBorderColor" type="color" value="#333333">
      </label>
      <label class="muted">Ø­Ø¬Ù… Ø§Ù„Ø´Ø¹Ø§Ø±:
        <input id="optLogoIn" type="number" min="0.8" max="2.0" step="0.1" value="1.3" style="width:70px"> in
      </label>
      <button class="btn" id="exportPdf">ğŸ§¾ Ø·Ø¨Ø§Ø¹Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø¨ Ø¥Ù„Ù‰ PDF</button>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¨Ù†Ø¯ + Ø¨Ø§Ø¨-Ø¨Ø§Ø¨ -->
    <div class="toolbar no-print">
      <button class="btn" id="selectAll">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
      <button class="btn" id="clearAll">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>
      <button class="btn" id="addRow">â• Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</button>
      <button class="btn" id="deleteChecked">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</button>
      <span style="flex:1"></span>
      <!-- Ø¨Ø§Ø¨-Ø¨Ø§Ø¨ -->
      <button class="btn" id="bundleAdd">â• Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø¨ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</button>
      <button class="btn" id="bundleClear">â™»ï¸ ØªÙØ±ÙŠØº Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
      <button class="btn primary" id="bundleExport">ğŸ—‚ï¸ ØªØµØ¯ÙŠØ± Ø¨Ø§Ø¨-Ø¨Ø§Ø¨ (ÙŠÙØªØ­ ØªØ¨ÙˆÙŠØ¨Ø§Øª)</button>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <table id="tbl" class="sticky-head">
      <thead>
        <tr><th>Ø§Ø®ØªÙŠØ§Ø± / Ø±Ù‚Ù…</th><th>Ø¨Ù†Ø¯ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="sep"></div>
    <div class="muted no-print">ØªÙ„Ù…ÙŠØ­: â€œâ• Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø¨ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„â€ ØªØ­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø¨ ÙÙ‚Ø·ØŒ Ø«Ù… ØºÙŠÙ‘Ø± Ø±Ù‚Ù…/Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¨ ÙˆÙƒØ±Ø±. Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ â€œğŸ—‚ï¸ ØªØµØ¯ÙŠØ± Ø¨Ø§Ø¨-Ø¨Ø§Ø¨â€ Ø³ÙŠØªÙ… ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ù„ÙƒÙ„ Ø¨Ø§Ø¨.</div>

    <details class="tests no-print">
      <summary>âœ… Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø©</summary>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin:6px 0">
        <button class="btn" id="btnRunTests">ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</button>
        <span class="pill">Ù„Ù† Ù†Ø¹Ø¯Ù‘Ù„ Ø£ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙˆØ¬ÙˆØ¯Ø› Ø³Ù†Ø¶ÙŠÙ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙÙ‚Ø·</span>
      </div>
      <pre id="testOut" class="muted" style="white-space:pre-wrap"></pre>
    </details>
  </section>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ù„ØµÙ‚ Ù…Ù† Word -->
<dialog id="pasteDlg">
  <div class="dlg-head">ğŸ“‹ Ù„ØµÙ‚ Ø¨Ù†ÙˆØ¯ Ù…Ù† Word</div>
  <div class="dlg-body">
    <div class="dlg-grid">
      <label>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
        <input id="dlgChapterNo" type="text" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 4">
      </label>
      <label>Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
        <input id="dlgChapterName" type="text" placeholder="Ù…Ø«Ø§Ù„: ØªØ¯Ø§ÙˆÙ„ ÙˆØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯">
      </label>
    </div>
    <label>Ø§Ù„ØµÙ‚ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù‡Ù†Ø§ (Ø³Ø·Ø± Ù„ÙƒÙ„ Ø¨Ù†Ø¯):
      <textarea id="dlgText" placeholder="1- Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø£ÙˆÙ„\nâ€¢ Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ\n- Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø«Ø§Ù„Ø«..."></textarea>
    </label>
    <div class="dlg-grid">
      <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬:
        <select id="dlgMode">
          <option value="replace">Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</option>
          <option value="append">Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</option>
        </select>
      </label>
      <label>Ø­ÙØ¸ ÙƒÙ‚Ø§Ù„Ø¨ Ø¨Ø§Ø³Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
        <input id="dlgTplName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨">
      </label>
    </div>
    <div class="inline-help" style="margin:6px 0 10px">Ø³ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªØ±Ù‚ÙŠÙ… ÙˆØ§Ù„Ø±Ù…ÙˆØ² (â€¢ - 1) ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <label class="muted"><input type="checkbox" id="dlgBindChapter" checked> Ø±Ø¨Ø· ÙƒØ¨Ø§Ø¨ Ù„Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</label>
      <label class="muted"><input type="checkbox" id="dlgCopyToEn" checked> Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù„Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø£ÙŠØ¶Ù‹Ø§</label>
      <span class="pill">ÙŠÙÙŠØ¯ Ø¹Ù†Ø¯ Ø§Ù…ØªÙ„Ø§ÙƒÙƒ Ù†Øµ Ø¹Ø±Ø¨ÙŠ ÙÙ‚Ø·</span>
    </div>
  </div>
  <div class="dlg-actions">
    <button class="btn" id="dlgCancel" type="button">Ø¥Ù„ØºØ§Ø¡</button>
    <button class="btn primary" id="dlgApply" type="button">ØªØ·Ø¨ÙŠÙ‚</button>
  </div>
</dialog>

<script>
(function(){
  document.addEventListener('DOMContentLoaded', function(){
    // ===== Ø§Ù„Ø­Ø§Ù„Ø© =====
    let state = {
      lang: 'ar',
      logoDataURL: '',
      chapter: { number: '', name: '' },
      items: { ar: [], en: [] },
      options: { includeChecks: true, includeRisk: false, borderW: 1, borderColor: '#333333', logoIn: 1.3, autoFill: true },
      sections: [] // [{no,name,itemsAr,itemsEn}]
    };

    const LS_KEY_DRAFT = 'audit_generic_draft';
    const LS_KEY_TPL = 'audit_user_templates_v1';
    const LS_KEY_CHMAP = 'audit_chapter_templates_v1';
    const LS_KEY_SECTIONS = 'audit_sections_bundle_v1';

    // ===== Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© (Ù…Ø®ØªØµØ±Ø©) =====
    const templates = {
      ar:{ ch1:["Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¯Ù„ÙŠÙ„ Ø¥Ø±Ø´Ø§Ø¯ÙŠ Ù„Ù„Ø³Ù„Ø§Ù…Ø©â€¦","ØªØ­Ø¯ÙŠØ¯ Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø¹Ù…Ù„â€¦"],
           ergo:["Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù…Ù†Ø§Ø³Ø¨","ÙƒØ±Ø³ÙŠ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„â€¦"] },
      en:{ ch1:["Safety manual available","Identify work hazards"],
           ergo:["Desk height ok","Adjustable chair lumbar"] }
    };

    // ===== Ø¹Ù†Ø§ØµØ± DOM =====
    const els = {
      companyLogo: document.getElementById('companyLogo'),
      logoInput: document.getElementById('logoInput'),
      chapterNo: document.getElementById('chapterNo'),
      chapterName: document.getElementById('chapterName'),
      title: document.getElementById('title'),
      tbody: document.querySelector('#tbl tbody'),
      filter: document.getElementById('filter'),
      client: document.getElementById('client'),
      site: document.getElementById('site'),
      langAr: document.getElementById('langAr'),
      langEn: document.getElementById('langEn'),
      saveDraft: document.getElementById('saveDraft'),
      clearDraft: document.getElementById('clearDraft'),
      selectAll: document.getElementById('selectAll'),
      clearAll: document.getElementById('clearAll'),
      addRow: document.getElementById('addRow'),
      deleteChecked: document.getElementById('deleteChecked'),
      exportPdf: document.getElementById('exportPdf'),

      // Ù‚ÙˆØ§Ù„Ø¨
      tplUserContainer: document.getElementById('tplUserContainer'),
      saveAsTemplate: document.getElementById('saveAsTemplate'),
      pasteFromWord: document.getElementById('pasteFromWord'),
      tplCh1: document.getElementById('tplCh1'),
      tplCh2: document.getElementById('tplCh2'),
      tplCh3: document.getElementById('tplCh3'),
      tplCh4: document.getElementById('tplCh4'),
      tplCh5: document.getElementById('tplCh5'),
      tplCh6: document.getElementById('tplCh6'),
      tplCh7: document.getElementById('tplCh7'),
      tplCh8: document.getElementById('tplCh8'),
      tplErgo: document.getElementById('tplErgo'),

      // Ø¨Ø§Ø¨-Ø¨Ø§Ø¨
      bundleAdd: document.getElementById('bundleAdd'),
      bundleClear: document.getElementById('bundleClear'),
      bundleExport: document.getElementById('bundleExport'),

      // Ø­ÙˆØ§Ø± Ø§Ù„Ù„ØµÙ‚
      dlg: document.getElementById('pasteDlg'),
      dlgNo: document.getElementById('dlgChapterNo'),
      dlgName: document.getElementById('dlgChapterName'),
      dlgText: document.getElementById('dlgText'),
      dlgMode: document.getElementById('dlgMode'),
      dlgTplName: document.getElementById('dlgTplName'),
      dlgBind: document.getElementById('dlgBindChapter'),
      dlgCopyToEn: document.getElementById('dlgCopyToEn'),
      dlgCancel: document.getElementById('dlgCancel'),
      dlgApply: document.getElementById('dlgApply'),

      printBtn: document.getElementById('printBtn'),
      btnRunTests: document.getElementById('btnRunTests'),
      testOut: document.getElementById('testOut')
    };

    // ===== Ø£Ø¯ÙˆØ§Øª =====
    function multiMatch(text, query){ if(!query) return true; const parts=query.split(/\s+/).map(s=>s.trim().toLowerCase()).filter(Boolean); const t=String(text).toLowerCase(); return parts.every(p=>t.includes(p)); }
    const AR_DIGITS={'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
    const normDigits=s=>String(s||'').replace(/[Ù -Ù©]/g,d=>AR_DIGITS[d]).replace(/[^0-9.]/g,'').trim();

    // ===== Ø­ÙØ¸/Ø§Ø³ØªØ±Ø¬Ø§Ø¹ =====
    function persist(){
      const payload={ v:19, lang:state.lang, logoDataURL:state.logoDataURL, items:state.items, chapter:state.chapter, options:state.options, sections:state.sections };
      try{ localStorage.setItem(LS_KEY_DRAFT, JSON.stringify(payload)); }catch(e){}
      try{ localStorage.setItem(LS_KEY_SECTIONS, JSON.stringify(state.sections)); }catch(e){}
    }
    function restore(){
      const raw=localStorage.getItem(LS_KEY_DRAFT);
      if(raw){ try{
        const d=JSON.parse(raw);
        if(d.lang) state.lang=d.lang;
        if(d.logoDataURL){ state.logoDataURL=d.logoDataURL; els.companyLogo.src=d.logoDataURL; els.companyLogo.hidden=!d.logoDataURL; }
        if(d.chapter) state.chapter=d.chapter;
        if(d.items && d.items.ar && d.items.en) state.items=d.items;
        if(d.options) state.options=Object.assign(state.options,d.options);
        if(Array.isArray(d.sections)) state.sections=d.sections;
      }catch{} }
      els.chapterNo.value=state.chapter.number||'';
      els.chapterName.value=state.chapter.name||'';
      document.getElementById('optChecks').checked=!!state.options.includeChecks;
      document.getElementById('optRisk').checked=!!state.options.includeRisk;
      document.getElementById('optBorderW').value=state.options.borderW;
      document.getElementById('optBorderColor').value=state.options.borderColor;
      document.getElementById('optLogoIn').value=state.options.logoIn;
      document.getElementById('optAutoFill').checked=!!state.options.autoFill;
      if(state.logoDataURL){ els.companyLogo.hidden=false; }
      updateTitle(); renderTable(); renderUserTemplates();
    }

    // ===== ÙˆØ§Ø¬Ù‡Ø© =====
    function renderTable(){
      const list=state.items[state.lang]||[];
      const q=els.filter.value.trim();
      els.tbody.innerHTML='';
      list.forEach((txt,idx)=>{
        if(q && !multiMatch(txt,q)) return;
        const tr=document.createElement('tr'); tr.draggable=true; tr.dataset.row=idx;
        const safe=String(txt||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        tr.innerHTML=`<td><div class="rowlead"><input type="checkbox" class="pick" checked><span class="ord">${idx+1}</span></div></td>
                      <td contenteditable="true" data-index="${idx}">${safe}</td>`;
        els.tbody.appendChild(tr);
      });
    }
    function updateTitle(){
      const no=els.chapterNo.value.trim(); let nm=els.chapterName.value.trim(); if(!no && !nm) nm='ergonomic';
      if(state.lang==='ar'){
        els.title.textContent='Ù‚Ø§Ø¦Ù…Ø© ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø³Ù„Ø§Ù…Ø© â€“ '+(no?('Ø§Ù„Ø¨Ø§Ø¨ '+no+' â€“ '):'')+(nm||'');
        document.documentElement.lang='ar'; document.documentElement.dir='rtl'; document.body.dir='rtl';
      }else{
        els.title.textContent='Safety Audit Checklist â€“ '+(no?('Chapter '+no+' â€“ '):'')+(nm||'');
        document.documentElement.lang='en'; document.documentElement.dir='ltr'; document.body.dir='ltr';
      }
    }

    // ===== Ø¨Ù†Ø§Ø¡ Ù†Ø³Ø®Ø© Ø¹Ù…ÙŠÙ„ Ù„Ø¨Ø§Ø¨ ÙˆØ§Ø­Ø¯ =====
    function buildClientHTMLOne(sec){
      const t=(state.lang==='ar'); const opt=state.options;
      const title=(t?'Ù‚Ø§Ø¦Ù…Ø© ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø³Ù„Ø§Ù…Ø© â€“ ':'Safety Audit Checklist â€“ ')
        +(sec.no? (t? 'Ø§Ù„Ø¨Ø§Ø¨ '+sec.no+' â€“ ' : 'Chapter '+sec.no+' â€“ '):'')+(sec.name||'');
      const lblClient=t?'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:':'Client:'; const lblSite=t?'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹:':'Site:'; const lblAud=t?'Ø§Ù„Ù…Ø¯Ù‚Ù‚:':'Auditor:'; const lblNotes=t?'Ù…Ù„Ø§Ø­Ø¸Ø§Øª':'Notes'; const lblNo=t?'Ù…':'No.'; const lblRisk=t?'Ø§Ù„Ù…Ø®Ø§Ø·Ø± (1â€“5)':'Risk (1â€“5)';
      const list = (state.lang==='ar'? sec.itemsAr: sec.itemsEn) || [];
      const rows=list.map((txt,i)=>{
        const cells=[`<td>${i+1}</td>`,`<td>${String(txt).replace(/</g,'&lt;').replace(/>/g,'&gt;')}</td>`];
        if(opt.includeChecks){ cells.push('<td><input type="checkbox"></td>','<td><input type="checkbox"></td>'); }
        if(opt.includeRisk){ cells.push('<td contenteditable="true" style="text-align:center;min-width:60px"></td>'); }
        cells.push('<td contenteditable="true" class="note"></td>');
        return `<tr>${cells.join('')}</tr>`;
      }).join('');
      const logoHTML= state.logoDataURL? `<div style="text-align:center;margin-bottom:10px"><img src="${state.logoDataURL}" alt="logo" style="height:${opt.logoIn}in;object-fit:contain"></div>`:'';
      const checksHdr=opt.includeChecks?'<th>âœ”</th><th>âœ–</th>':''; const riskHdr=opt.includeRisk?`<th>${lblRisk}</th>`:'';
      return `<!doctype html><html lang="${t?'ar':'en'}" dir="${t?'rtl':'ltr'}"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${title}</title>
<style>
@page{size:A4;margin:12mm}
body{font-family:${t?"'Noto Kufi Arabic','Cairo',Tahoma,sans-serif":"'Segoe UI','Roboto',Arial,sans-serif"};margin:0;background:#fff}
.page{max-width:794px;margin:12px auto;border:${opt.borderW}px solid ${opt.borderColor};border-radius:10px;padding:18px}
h1{margin:0 0 10px;text-align:center}
table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{border:1px solid #ccc;padding:8px;vertical-align:top}
th{background:#eef2ff}
td.note{min-height:40px;max-height:60px;overflow-y:auto;white-space:pre-wrap;word-wrap:break-word}
</style>
</head><body>
<div class="page">
  ${logoHTML}
  <h1>${title}</h1>
  <div><strong>${lblClient}</strong> ${els.client.value||''}</div>
  <div><strong>${lblSite}</strong> ${els.site.value||''}</div>
  <div><strong>${lblAud}</strong> <div contenteditable="true" style="display:inline-block;min-width:200px;border-bottom:1px solid #000"></div></div>
  <table>
    <thead><tr><th>${lblNo}</th><th>${t?'Ø§Ù„Ø¨Ù†Ø¯':'Item'}</th>${checksHdr}${riskHdr}<th>${lblNotes}</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>
</div>
</body></html>`;
    }

    // ===== Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© (Ø£Ø²Ø±Ø§Ø± Ù…Ø«Ø§Ù„) =====
    function applyTemplateFromArray(arr,mode){ const set=Array.isArray(arr)? arr.filter(x=>typeof x==='string' && x.trim()):[]; if(!set.length){ alert('Ø§Ù„Ù‚Ø§Ù„Ø¨ ÙØ§Ø±Øº'); return; } if(mode==='replace') state.items[state.lang]=[...set]; else state.items[state.lang].push(...set); renderTable(); persist(); }
    function askAndApply(key){ const set=(templates[state.lang] && templates[state.lang][key])? templates[state.lang][key]:[]; const isReplace=confirm('Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ù‚Ø§Ù„Ø¨ØŸ\nOK = Ø§Ø³ØªØ¨Ø¯Ø§Ù„\nCancel = Ø¥Ø¶Ø§ÙØ©'); applyTemplateFromArray(set, isReplace?'replace':'append'); }
    function renderUserTemplates(){ /* Ù„Ø§Ø­Ù‚Ù‹Ø§: Ù†ÙØ³ Ù…Ù†Ø·Ù‚Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† Ø£Ø±Ø¯Øª */ els.tplUserContainer.innerHTML=''; }

    // ===== Ø£Ø­Ø¯Ø§Ø« Ø¹Ø§Ù…Ø© =====
    function getCheckedItemsText(lang){
      return [...document.querySelectorAll('#tbl tbody tr')]
        .filter(r=>r.querySelector('.pick')?.checked)
        .map(r=>r.cells[1].innerText.trim()).filter(Boolean);
    }
    function onReorderDrop(e){ e.preventDefault(); const from=parseInt(e.dataTransfer.getData('text/plain'),10); const toTr=e.target.closest('tr'); if(!toTr) return; const to=parseInt(toTr.dataset.row,10); if(Number.isNaN(from)||Number.isNaN(to)||from===to) return; const arr=state.items[state.lang]; const [moved]=arr.splice(from,1); arr.splice(to,0,moved); renderTable(); persist(); }

    // Ù„ØºØ© ÙˆØ­Ù‚ÙˆÙ„ ÙˆØ±Ø³Ù…
    document.getElementById('langAr').onclick=()=>{ state.lang='ar'; updateTitle(); renderTable(); persist(); renderUserTemplates(); };
    document.getElementById('langEn').onclick=()=>{ state.lang='en'; updateTitle(); renderTable(); persist(); renderUserTemplates(); };
    document.getElementById('optAutoFill').onchange=()=>{ state.options.autoFill = document.getElementById('optAutoFill').checked; persist(); };
    document.getElementById('optChecks').onchange=()=>{ state.options.includeChecks = document.getElementById('optChecks').checked; persist(); };
    document.getElementById('optRisk').onchange=()=>{ state.options.includeRisk = document.getElementById('optRisk').checked; persist(); };
    document.getElementById('optBorderW').oninput=()=>{ state.options.borderW=+document.getElementById('optBorderW').value||0; persist(); };
    document.getElementById('optBorderColor').oninput=()=>{ state.options.borderColor=document.getElementById('optBorderColor').value; persist(); };
    document.getElementById('optLogoIn').oninput=()=>{ state.options.logoIn=+document.getElementById('optLogoIn').value||1.0; persist(); };

    document.getElementById('chapterNo').addEventListener('input', ()=>{ state.chapter.number=document.getElementById('chapterNo').value; updateTitle(); persist(); });
    document.getElementById('chapterName').addEventListener('input', ()=>{ state.chapter.name=document.getElementById('chapterName').value; updateTitle(); persist(); });
    document.getElementById('filter').addEventListener('input', renderTable);

    document.getElementById('selectAll').onclick=()=> document.querySelectorAll('.pick').forEach(cb=>cb.checked=true);
    document.getElementById('clearAll').onclick=()=> document.querySelectorAll('.pick').forEach(cb=>cb.checked=false);
    document.getElementById('addRow').onclick=()=>{ const ph=state.lang==='ar'? '* Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯':'* New Item'; state.items[state.lang].unshift(ph); renderTable(); persist(); };
    document.getElementById('deleteChecked').onclick=()=>{ const keep=[]; document.querySelectorAll('#tbl tbody tr').forEach(r=>{ const checked=r.querySelector('.pick').checked; const text=r.cells[1].innerText.trim(); if(!checked) keep.push(text); }); state.items[state.lang]=keep; renderTable(); persist(); };

    // Ø³Ø­Ø¨ Ø¥ÙÙ„Ø§Øª
    els.tbody.addEventListener('dragstart', e=>{ const tr=e.target.closest('tr'); if(!tr) return; tr.classList.add('dragging'); e.dataTransfer.setData('text/plain', tr.dataset.row); });
    els.tbody.addEventListener('dragend', e=>{ const tr=e.target.closest('tr'); if(tr) tr.classList.remove('dragging'); });
    els.tbody.addEventListener('dragover', e=> e.preventDefault());
    els.tbody.addEventListener('drop', onReorderDrop);
    els.tbody.addEventListener('input', e=>{ const td=e.target.closest('td[data-index]'); if(!td) return; const idx=+td.dataset.index; const val=td.innerText.trim(); if(Number.isInteger(idx)&&idx>=0){ state.items[state.lang][idx]=val; persist(); } });

    // Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø± (ÙŠØ­ÙØ¸ Base64) + ØªÙ†Ø¨ÙŠÙ‡ Ø­Ø¬Ù… ÙƒØ¨ÙŠØ±
    document.getElementById('logoInput').addEventListener('change', e=>{
      const file=e.target.files[0];
      if(!file){ state.logoDataURL=''; els.companyLogo.hidden=true; persist(); return; }
      if(file.size>600*1024 && !confirm('Ø­Ø¬Ù… Ø§Ù„Ø´Ø¹Ø§Ø± ÙƒØ¨ÙŠØ± (>600KB). Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')){ e.target.value=''; return; }
      const r=new FileReader();
      r.onload=ev=>{ state.logoDataURL=ev.target.result; els.companyLogo.src=state.logoDataURL; els.companyLogo.hidden=false; persist(); };
      r.readAsDataURL(file);
    });

    // Ù‚ÙˆØ§Ù„Ø¨
    (els.tplCh1||{}).onclick=()=> askAndApply('ch1');
    (els.tplErgo||{}).onclick=()=> applyTemplateFromArray(templates[state.lang].ergo,'append');

    // Ù„ØµÙ‚ Ù…Ù† Word
    els.pasteFromWord.onclick=()=> els.dlg.showModal();
    els.dlgCancel.onclick=()=> els.dlg.close();
    function normalizeLines(text){
      return text.split(/\r?\n/).map(s=>s.replace(/^\s*(?:[0-9]+[\).\-\)]\s*|[\u2022\-â€¢â–ªâ—†â—¦\*]+\s*)?/,'').trim()).filter(Boolean);
    }
    els.dlgApply.onclick=()=>{
      const lines=normalizeLines(els.dlgText.value||''); if(!lines.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯.'); return; }
      if(els.dlgMode.value==='replace') state.items[state.lang]=lines; else state.items[state.lang].push(...lines);
      const no=els.dlgNo.value.trim(); const nm=els.dlgName.value.trim();
      if(no){ state.chapter.number=no; document.getElementById('chapterNo').value=no; }
      if(nm){ state.chapter.name=nm; document.getElementById('chapterName').value=nm; }
      renderTable(); updateTitle(); persist(); els.dlg.close();
    };

    // Ø·Ø¨Ø§Ø¹Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø¨
    els.exportPdf.onclick=()=>{
      const sec={ no:normDigits(els.chapterNo.value.trim())||els.chapterNo.value.trim(), name:els.chapterName.value.trim(), itemsAr:(state.lang==='ar'? getCheckedItemsText('ar'): state.items.ar.slice()), itemsEn:(state.lang==='en'? getCheckedItemsText('en'): state.items.en.slice()) };
      const html=buildClientHTMLOne(sec);
      const w=window.open('','_blank'); w.document.write(html); w.document.close(); setTimeout(()=>{ try{ w.print(); }catch{} },400);
    };
    document.getElementById('printBtn').onclick=()=> window.print();

    // ===== Ø¨Ø§Ø¨-Ø¨Ø§Ø¨: ØªØ¬Ù…ÙŠØ¹ ÙˆØªØµØ¯ÙŠØ± Ù…Ù†ÙØµÙ„ =====
    function loadSections(){ try{ return JSON.parse(localStorage.getItem(LS_KEY_SECTIONS))||[] }catch{return []} }
    function saveSections(){ try{ localStorage.setItem(LS_KEY_SECTIONS, JSON.stringify(state.sections)); }catch{} }

    els.bundleAdd.onclick=()=>{
      const no = normDigits(els.chapterNo.value.trim()) || els.chapterNo.value.trim();
      const nm = els.chapterName.value.trim();
      const picked = getCheckedItemsText(state.lang);
      if(!picked.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯ Ù…Ø­Ø¯Ø¯Ø© Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§.'); return; }
      const sec = {
        no, name:nm,
        itemsAr: (state.lang==='ar')? picked.slice() : (state.items.ar||[]).slice(),
        itemsEn: (state.lang==='en')? picked.slice() : (state.items.en||[]).slice()
      };
      state.sections.push(sec); saveSections(); persist();
      alert(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø§Ø¨ Ù„Ù„ØªØ¬Ù…ÙŠØ¹.\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¢Ù†: ${state.sections.length} Ø¨Ø§Ø¨(Ø£Ø¨ÙˆØ§Ø¨).`);
    };

    els.bundleClear.onclick=()=>{ if(confirm('ØªÙØ±ÙŠØº Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨ Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©ØŸ')){ state.sections=[]; saveSections(); persist(); alert('ØªÙ… Ø§Ù„ØªÙØ±ÙŠØº.'); } };

    els.bundleExport.onclick=()=>{
      if(!(state.sections && state.sections.length)){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¨ÙˆØ§Ø¨ Ù…Ø¬Ù…Ø¹Ø©. Ø£Ø¶Ù Ø£ÙˆÙ„Ø§Ù‹.'); return; }
      if(state.sections.length>6 && !confirm(`Ø³ÙŠØªÙ… ÙØªØ­ ${state.sections.length} ØªØ¨ÙˆÙŠØ¨Ø§Øª.\nÙ‚Ø¯ ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù…ØªØµÙØ­ Ø°Ù„Ùƒ. Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`)) return;

      // Ø§ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ù„ÙƒÙ„ Ø¨Ø§Ø¨: Ø­ÙØ¸ HTML ÙÙŠ LocalStorage + ÙØªØ­ client_flow.html
      const flowPath = 'client_flow.html'; // Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ùˆ Ù„Ø²Ù…
      state.sections.forEach((sec, i)=>{
        const html = buildClientHTMLOne(sec);
        try{ localStorage.setItem('client_preview_html', html); }catch(e){ console.warn('LS failed for section', i, e); }
        window.open(flowPath, '_blank');
      });
    };

    // Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¨Ø³ÙŠØ·Ø©
    if(els.btnRunTests){
      els.btnRunTests.onclick=()=>{
        const out=[];
        out.push('â€” Ø§Ù„Ù„ØºØ©: '+state.lang);
        out.push('â€” Ø¨Ù†ÙˆØ¯ AR/EN: '+(state.items.ar?.length||0)+' / '+(state.items.en?.length||0));
        out.push('â€” Ø£Ù‚Ø³Ø§Ù… Ù…Ø¬Ù…Ø¹Ø©: '+(state.sections?.length||0));
        els.testOut.textContent=out.join('\n');
      };
    }

    // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
    restore();
    if(!(state.items.ar.length||state.items.en.length)){
      state.items.ar = ['* Ù…Ø«Ø§Ù„: Ø¨Ù†Ø¯ Ø¹Ø±Ø¨ÙŠ 1','* Ù…Ø«Ø§Ù„: Ø¨Ù†Ø¯ Ø¹Ø±Ø¨ÙŠ 2'];
      state.items.en = ['* Example: Item 1','* Example: Item 2'];
      renderTable();
    }
  });
})();
</script>
</body>
</html>
