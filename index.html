<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>نسخة المصمم – اختبار الباب وإدخال بيانات العميل</title>
<style>
  :root{--bg:#f7f8fb;--ink:#111;--muted:#666;--line:#e5e7eb;--card:#fff;--accent:#2563eb;--head:#e6f0ff}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Kufi Arabic","Cairo",Tahoma,Arial,sans-serif}
  .wrap{max-width:1100px;margin:auto;padding:18px}
  .card{background:var(--card);border:1px solid #d9dde5;border-radius:14px;padding:18px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
  .title{display:flex;align-items:center;gap:12px}
  .title h1{margin:0;font-size:20px}
  .logo{height:64px;object-fit:contain}
  .muted{color:var(--muted);font-size:13px}
  .row{display:grid;gap:10px}
  @media(min-width:768px){.row{grid-template-columns:repeat(12,1fr)}.col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-8{grid-column:span 8}.col-12{grid-column:span 12}}
  input[type=text],input[type=date],input[type=search],input[type=number],select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #cfd7e3;padding:8px;vertical-align:middle}
  th{background:var(--head);text-align:center}
  td.num{width:54px;text-align:center}
  td[contenteditable]{outline:0;min-height:28px}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid #d0d7ff;background:#fff;cursor:pointer}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;border:1px solid #c7d2fe;font-size:.8rem;color:#374151}
  .hidden{display:none!important}
  .box{border:1px dashed #cfd7e3;border-radius:10px;padding:10px;margin:8px 0}
  @media print{.no-print{display:none!important}.card{border:0;box-shadow:none}body{background:#fff}}
</style>
</head>
<body>
<div class="wrap">
  <!-- لوحة المصمم -->
  <section id="designer" class="card">
    <div class="title">
      <img id="lg" class="logo" alt="logo" hidden>
      <h1>نسخة المصمم – اختبار الباب وتحضير نسخة العميل</h1>
      <span style="margin-inline-start:auto"></span>
      <button type="button" class="btn no-print" id="printSetup">🖨️ طباعة</button>
    </div>
    <div class="muted">أدخل بيانات العميل والموقع، اختر الباب والقالب، عدّل البنود، ثم اضغط "معاينة نسخة العميل" للاختبار. يمكنك أيضًا تصدير HTML جاهز للعميل.</div>
    <div id="toast" class="hidden" style="margin-top:8px;padding:8px 12px;border:1px solid #c7d2fe;background:#eef2ff;border-radius:10px;color:#374151"></div>

    <div class="row" style="margin-top:10px">
      <div class="col-4"><label>اسم الشركة<br><input id="dClient" type="text" placeholder="مثال: شركة الخليج"></label></div>
      <div class="col-4"><label>اسم الموقع<br><input id="dSite" type="text" placeholder="مثال: مصنع الشعيبة"></label></div>
      <div class="col-4"><label>وصف الموقع<br>
        <div style="display:flex;gap:6px">
          <select id="dDescSel" style="flex:1">
            <option value="">— اختر وصفًا —</option>
            <option>مكتب</option>
            <option>ورشة</option>
            <option>مصنع</option>
            <option>مستودع</option>
            <option>موقع خارجي</option>
            <option value="__other">أخرى…</option>
          </select>
          <input id="dDescOther" type="text" placeholder="اكتب وصفًا" class="hidden" style="flex:1">
        </div>
      </label></div>
      <div class="col-3"><label>رقم الباب<br><input id="gateNo" type="text" placeholder="1"></label></div>
      <div class="col-5"><label>اسم الباب<br><input id="gateName" type="text" placeholder="مثال: الحماية من الآلات"></label></div>
      <div class="col-4"><label>تاريخ الإصدار<br><input id="issueDate" type="date"></label></div>
      <div class="col-6"><label class="btn no-print" style="display:inline-flex;align-items:center;gap:8px"><input type="file" id="logoInput" accept="image/*"> رفع الشعار</label></div>
    </div>

    <div class="toolbar no-print">
      <span class="pill">📚 قوالب الأبواب السريعة:</span>
      <button type="button" class="btn" data-tpl="ch1">باب 1</button>
      <button type="button" class="btn" data-tpl="ch2">باب 2</button>
      <button type="button" class="btn" data-tpl="ch3">باب 3</button>
      <button type="button" class="btn" data-tpl="ch4">باب 4</button>
      <button type="button" class="btn" data-tpl="ch5">باب 5</button>
      <button type="button" class="btn" data-tpl="ch6">باب 6</button>
      <button type="button" class="btn" data-tpl="ch7">باب 7</button>
      <button type="button" class="btn" data-tpl="ch8">باب 8</button>
      <button type="button" class="btn" data-tpl="ergo">Ergonomic</button>
      <span style="flex:1"></span>
      <label class="pill"><input type="checkbox" id="optChecks" checked> ✔/✖</label>
      <label class="pill"><input type="checkbox" id="optRisk"> تقييم المخاطر (1–5)</label>
    </div>

    <div class="toolbar no-print">
      <button type="button" class="btn" id="addRow">➕ إضافة بند</button>
      <button type="button" class="btn" id="selectAll">✔️ تحديد الكل</button>
      <button type="button" class="btn" id="clearAll">❌ إلغاء التحديد</button>
      <button type="button" class="btn" id="saveDraft">💾 حفظ مسودة</button>
      <button type="button" class="btn" id="reset">إعادة تعيين</button>
      <span style="flex:1"></span>
      <input id="filter" type="search" placeholder="فلترة البنود…" style="max-width:280px">
    </div>

    <table>
      <thead><tr><th style="width:74px">تضمين</th><th>نص البند</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="toolbar no-print">
      <button type="button" class="btn primary" id="preview">👁️ معاينة نسخة العميل (اختبار)</button>
      <button type="button" class="btn" id="exportHtml">⬇️ تصدير HTML للعميل (أوفلاين)</button>
    </div>
  </section>

  <!-- معاينة/اختبار نسخة العميل -->
  <section id="client" class="card hidden">
    <div class="title" style="justify-content:center">
      <img id="lg2" class="logo" alt="logo" hidden>
      <h1 id="titleTxt">قائمة تدقيق السلامة – الباب</h1>
    </div>

    <div class="row">
      <div class="col-4"><label>اسم الشركة<br><input id="cClient" type="text"></label></div>
      <div class="col-4"><label>اسم الموقع<br><input id="cSite" type="text"></label></div>
      <div class="col-4"><label>وصف الموقع<br><input id="cDesc" type="text" placeholder="مكتب / ورشة / …"></label></div>
      <div class="col-4"><label>اسم المدقق<br><input id="cAuditor" type="text"></label></div>
      <div class="col-4"><label>التاريخ<br><input id="cDate" type="date"></label></div>
    </div>

    <table id="clientTable">
      <thead>
        <tr>
          <th>م</th><th>البند</th><th id="hOk">✓</th><th id="hNo">✗</th><th id="hRisk" class="hidden">المخاطر (1–5)</th><th>ملاحظات (≤50)</th>
        </tr>
      </thead>
      <tbody id="clientBody"></tbody>
    </table>

    <div class="toolbar no-print">
      <button type="button" class="btn" id="back">↩️ رجوع للتعديل</button>
      <span style="flex:1"></span>
      <button type="button" class="btn" id="printClient">🖨️ طباعة</button>
    </div>
  </section>
</div>

<script>
(function(){
  const $ = s=>document.querySelector(s);
  const S = s=>document.querySelectorAll(s);

  // العناصر
  const els = {
    // لوحة المصمم
    designer: $('#designer'), client: $('#client'),
    lg: $('#lg'), lg2: $('#lg2'), logoInput: $('#logoInput'),
    dClient: $('#dClient'), dSite: $('#dSite'), dDescSel: $('#dDescSel'), dDescOther: $('#dDescOther'),
    gateNo: $('#gateNo'), gateName: $('#gateName'), issueDate: $('#issueDate'),
    optChecks: $('#optChecks'), optRisk: $('#optRisk'),
    addRow: $('#addRow'), selectAll: $('#selectAll'), clearAll: $('#clearAll'), saveDraft: $('#saveDraft'), reset: $('#reset'),
    filter: $('#filter'),
    tbody: $('#tbody'),
    preview: $('#preview'), exportHtml: $('#exportHtml'), printSetup: $('#printSetup'),
    // معاينة العميل
    titleTxt: $('#titleTxt'), cClient: $('#cClient'), cSite: $('#cSite'), cDesc: $('#cDesc'), cAuditor: $('#cAuditor'), cDate: $('#cDate'),
    clientBody: $('#clientBody'), hRisk: $('#hRisk'), back: $('#back'), printClient: $('#printClient')
  };

  // تاريخ افتراضي
  const today = new Date().toISOString().slice(0,10);
  els.issueDate.value = today; els.cDate.value = today;

  // الحالة
  let logoData = '';
  let rows = []; // {id,text,include}

  // قوالب الأبواب
  function toast(msg){ const t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'),1500); }
  function applyTemplate(key){
    const arr = templates[key]||[]; if(!arr.length){ alert('لا توجد بنود لهذا الباب'); return; }
    const replace = confirm('استبدال القائمة الحالية بالقالب؟\nOK = استبدال\nCancel = إضافة');
    // أزل أي فلترة حتى تظهر البنود
    els.filter.value='';
    if(replace){ rows = []; }
    arr.forEach(t=> rows.push({id:uid(), text:t, include:true}));
    // اسم/رقم الباب تلقائيًا إن لم يُملأا
    if(!els.gateName.value){
  els.saveDraft.onclick=()=>{ persist(); alert('تم حفظ المسودة محليًا'); };
  els.reset.onclick=()=>{ if(confirm('مسح كل البيانات؟')){ localStorage.removeItem(LS_KEY); rows=[]; logoData=''; els.lg.hidden=true; renderSetup(); els.dClient.value=els.dSite.value=els.gateNo.value=els.gateName.value=''; els.dDescSel.value=''; els.dDescOther.value=''; } };
  els.printSetup.onclick=()=>window.print();

  // معاينة نسخة العميل
  els.preview.onclick=()=>{
    const list = rows.filter(r=>r.include && String(r.text||'').trim());
    if(!list.length) return alert('اختر بندًا واحدًا على الأقل');
    els.titleTxt.textContent = `قائمة تدقيق السلامة – الباب ${els.gateNo.value||'-'} – ${els.gateName.value||''}`;
    els.cClient.value = els.dClient.value; els.cSite.value = els.dSite.value;
    const desc = (els.dDescSel.value==='__other'? els.dDescOther.value : els.dDescSel.value) || '';
    els.cDesc.value = desc;
    $('#clientBody').innerHTML='';
    if(logoData){ els.lg2.src=logoData; els.lg2.hidden=false; } else { els.lg2.hidden=true; }

    const includeRisk = !!els.optRisk.checked; if(includeRisk){ els.hRisk.classList.remove('hidden'); } else { els.hRisk.classList.add('hidden'); }

    list.forEach((r,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td class="num">${i+1}</td>
                      <td>${escapeHtml(r.text)}</td>
                      ${els.optChecks.checked? `<td class="chk"><input type="checkbox" class="ok"></td><td class="chk"><input type="checkbox" class="no"></td>` : `<td class="chk">—</td><td class="chk">—</td>`}
                      ${includeRisk? `<td style="text-align:center"><select class="riskSel"><option value=""></option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></td>` : ''}
                      <td><input type="text" maxlength="50" placeholder="حتى 50 حرفًا"></td>`;
      $('#clientBody').appendChild(tr);
    });

    // تنافي ✓/✗
    $('#clientBody').querySelectorAll('tr').forEach(tr=>{
      const ok=tr.querySelector('.ok'), no=tr.querySelector('.no');
      if(ok && no){ ok.addEventListener('change',()=>{ if(ok.checked) no.checked=false; }); no.addEventListener('change',()=>{ if(no.checked) ok.checked=false; }); }
    });

    els.designer.classList.add('hidden'); els.client.classList.remove('hidden');
  };

  // تصدير HTML للعميل (أوفلاين)
  els.exportHtml.onclick=()=>{
    const list = rows.filter(r=>r.include && String(r.text||'').trim());
    if(!list.length) return alert('اختر بندًا واحدًا على الأقل');
    const includeRisk = !!els.optRisk.checked; const includeChecks = !!els.optChecks.checked;
    const desc = (els.dDescSel.value==='__other'? els.dDescOther.value : els.dDescSel.value) || '';

    const rowsHtml = list.map((r,i)=>{
      const cells = [ `<td style="text-align:center">${i+1}</td>`, `<td>${escapeHtml(r.text)}</td>` ];
      if(includeChecks){ cells.push('<td style="text-align:center">☐</td>','<td style="text-align:center">☐</td>'); }
      if(includeRisk){ cells.push('<td style="text-align:center">&nbsp;</td>'); }
      cells.push('<td></td>');
      return `<tr>${cells.join('')}</tr>`;
    }).join('');

    const checksHdr = includeChecks? '<th>✓</th><th>✗</th>' : '';
    const riskHdr   = includeRisk? '<th>المخاطر (1–5)</th>' : '';
    const logoHTML  = logoData? `<div style="text-align:center;margin-bottom:8px"><img src="${logoData}" style="height:60px;object-fit:contain"></div>`:'';

    const html = `<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>نسخة العميل</title>
<style>body{font-family:Tahoma,Arial;margin:0;background:#f7f8fb;color:#111} .wrap{max-width:900px;margin:auto;padding:16px} .card{background:#fff;border:1px solid #ddd;border-radius:12px;padding:16px} h2{text-align:center;margin:.2rem 0 .6rem} table{width:100%;border-collapse:collapse;margin-top:10px} th,td{border:1px solid #ccc;padding:8px;vertical-align:middle} th{background:#e6f0ff;text-align:center}</style></head>
<body><div class="wrap"><div class="card">${logoHTML}
<h2>قائمة تدقيق السلامة – الباب ${escapeHtml(els.gateNo.value||'-')} – ${escapeHtml(els.gateName.value||'')}</h2>
<div style="margin:6px 0 10px;color:#333">الشركة: ${escapeHtml(els.dClient.value||'-')} | الموقع: ${escapeHtml(els.dSite.value||'-')} | الوصف: ${escapeHtml(desc||'-')} | الإصدار: ${escapeHtml(els.issueDate.value||'-')}</div>
<table><thead><tr><th>م</th><th>البند</th>${checksHdr}${riskHdr}<th>ملاحظات</th></tr></thead><tbody>${rowsHtml}</tbody></table>
</div></div></body></html>`;

    const blob=new Blob([html],{type:'text/html'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='نسخة-العميل.html'; a.click(); URL.revokeObjectURL(url);
  };

  // العودة من المعاينة
  els.back.onclick=()=>{ els.client.classList.add('hidden'); els.designer.classList.remove('hidden'); };
  els.printClient.onclick=()=>window.print();

  // تزامن قيم عامة
  ['input','change'].forEach(ev=>{
    ['dClient','dSite','gateNo','gateName','issueDate','optChecks','optRisk'].forEach(id=>{ els[id].addEventListener(ev, persist); });
  });

  // بدء
  function seed(){ if(rows.length) return; ['التأكد من وجود دليل إرشادي للسلامة','تحديد مخاطر العمل','توفير معدات الوقاية الشخصية','فحص معدات الإطفاء وصلاحيتها'].forEach(t=>addRow(t)); }
  restore(); seed();
})();
</script>
</body>
</html>
