<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù‚Ø§Ø¦Ù…Ø© ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø³Ù„Ø§Ù…Ø© â€“ Ù†Ø³Ø®Ø© Ø«Ø§Ø¨ØªØ© ÙˆÙ…ØµØ­Ø­Ø©</title>
<style>
  :root{--bg:#f7f8fb;--ink:#111;--muted:#666;--line:#e5e7eb;--card:#fff;--accent:#2563eb}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:"Noto Kufi Arabic","Cairo",Tahoma,Arial,sans-serif}
  .wrap{max-width:1100px;margin:auto;padding:20px}
  .card{background:var(--card);border:1px solid #ddd;border-radius:14px;padding:20px}
  .header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
  .logo{height:70px;object-fit:contain}
  h1{margin:.2rem 0 1rem;font-size:22px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
  .btn{padding:8px 14px;border-radius:10px;cursor:pointer;margin:2px 0;font-size:14px;border:1px solid #ddd;background:#fff}
  .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .btn.warn{background:#fff3cd;border-color:#fcd34d}
  label{display:block}
  input[type="text"],input[type="search"],input[type="number"],input[type="color"],select{padding:6px 10px;border:1px solid #ccc;border-radius:10px}
  input[type="text"],input[type="search"]{width:100%}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #ccc;padding:8px;vertical-align:top}
  th{background:#eef2ff}
  [contenteditable]{outline:0;min-height:30px}
  .muted{color:var(--muted);font-size:.9rem}
  .grid{display:grid;gap:10px}
  .grid-2{grid-template-columns:1fr 1fr}
  .right{margin-inline-start:auto}
  .sticky-head thead th{position:sticky;top:0;z-index:1}
  .inline-help{font-size:.85rem;color:#555;margin-top:6px}
  .sep{height:1px;background:#eee;margin:12px 0}
  .tests{margin-top:12px;padding:10px;border:1px dashed #cbd5e1;border-radius:10px;background:#fafafa}
  .rowlead{display:flex;align-items:center;gap:8px}
  .ord{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:8px;background:#eef2ff;font-weight:600}
  tr.dragging{opacity:.6}
  details summary{cursor:pointer}
  dialog{border:1px solid #ddd;border-radius:12px;padding:0;max-width:720px;width:min(92vw,720px)}
  .dlg-head{padding:12px 16px;border-bottom:1px solid #eee;font-weight:700}
  .dlg-body{padding:12px 16px}
  .dlg-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .dlg-actions{padding:12px 16px;border-top:1px solid #eee;display:flex;gap:8px;justify-content:flex-end}
  textarea{width:100%;height:220px;padding:10px;border:1px solid #ccc;border-radius:10px;resize:vertical}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;border:1px solid #c7d2fe;font-size:.8rem;color:#374151}
  @media (max-width:720px){.grid-2{grid-template-columns:1fr}.dlg-grid{grid-template-columns:1fr}}
  @media print{.no-print{display:none} body{background:#fff}}
</style>
</head>
<body>
<div class="wrap">
  <section class="card">
    <div class="header">
      <img id="companyLogo" src="" class="logo" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©" hidden>
      <div>
        <h1 id="title">Ù‚Ø§Ø¦Ù…Ø© ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø³Ù„Ø§Ù…Ø© â€“ </h1>
        <div id="ref" class="muted"></div>
      </div>
      <button class="btn right no-print" id="printBtn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© / PDF</button>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù„ØºØ© ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª -->
    <div class="toolbar no-print">
      <button class="btn" id="langAr">ğŸ‡¸ğŸ‡¦ Ø¹Ø±Ø¨ÙŠ</button>
      <button class="btn" id="langEn">ğŸ‡¬ğŸ‡§ English</button>
      <span style="flex:1"></span>
      <label class="muted"><input type="checkbox" id="optAutoFill" checked> âš¡ ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„Ø¨Ø§Ø¨</label>
      <button class="btn" id="saveDraft">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©</button>
      <button class="btn warn" id="clearDraft">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©</button>
    </div>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø±Ø£Ø³ÙŠØ© -->
    <div class="grid grid-2 no-print">
      <label id="lblClient">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:
        <input id="client" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø±ÙƒØ© Ø§Ù„Ø®Ù„ÙŠØ¬ Ù„Ù„ØµÙ†Ø§Ø¹Ø§Øª">
      </label>
      <label id="lblSite">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹:
        <input id="site" type="text" placeholder="Ù…Ø«Ø§Ù„: Ù…ØµÙ†Ø¹ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ© â€“ Ø§Ù„Ø´Ø¹ÙŠØ¨Ø©">
      </label>
      <label id="lblLogo">Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø±:
        <input id="logoInput" type="file" accept="image/*">
      </label>
      <label id="lblChapNo">Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Ø¨:
        <input id="chapterNo" type="text" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: Ù¤ Ø£Ùˆ 4">
      </label>
      <label id="lblChapName">Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¨:
        <input id="chapterName" type="text" placeholder="Ù…Ø«Ø§Ù„: ØªØ¯Ø§ÙˆÙ„ ÙˆØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯">
      </label>
      <div>
        <label id="lblFilter">Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ù†ÙˆØ¯:
          <input id="filter" type="search" placeholder="Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ù„Ù„ÙÙ„ØªØ±Ø©â€¦">
        </label>
        <div class="inline-help" id="filterHelp">Ù…Ø«Ø§Ù„: Ø³Ù‚Ø§Ù„Ø§ØªØŒ Ù…Ø®Ø§Ø±Ø¬ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ØŒ Ø­ÙˆØ§Ø¬Ø² Ø§Ù„Ø¢Ù„Ø§Øªâ€¦</div>
      </div>
    </div>

    <!-- Ù‚ÙˆØ§Ù„Ø¨ ÙˆØ®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØµØ¯ÙŠØ± -->
    <div class="toolbar no-print">
      <span class="muted">ğŸ“š Ù‚ÙˆØ§Ù„Ø¨ Ø³Ø±ÙŠØ¹Ø©:</span>
      <button class="btn" id="tplCh1">Ø¨Ø§Ø¨ 1</button>
      <button class="btn" id="tplCh2">Ø¨Ø§Ø¨ 2</button>
      <button class="btn" id="tplCh3">Ø¨Ø§Ø¨ 3</button>
      <button class="btn" id="tplCh4">Ø¨Ø§Ø¨ 4</button>
      <button class="btn" id="tplCh5">Ø¨Ø§Ø¨ 5</button>
      <button class="btn" id="tplCh6">Ø¨Ø§Ø¨ 6</button>
      <button class="btn" id="tplCh7">Ø¨Ø§Ø¨ 7</button>
      <button class="btn" id="tplCh8">Ø¨Ø§Ø¨ 8</button>
      <button class="btn" id="tplErgo">Ergonomic</button>
      <span id="tplUserContainer" class="muted" style="display:flex;gap:6px;flex-wrap:wrap"></span>
      <button class="btn" id="saveAsTemplate">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙƒÙ‚Ø§Ù„Ø¨</button>
      <button class="btn" id="pasteFromWord">ğŸ“‹ Ù„ØµÙ‚ Ù…Ù† Word</button>
      <span style="flex:1"></span>
      <label class="muted"><input type="checkbox" id="optChecks" checked> Ø£Ø¹Ù…Ø¯Ø© âœ”/âœ–</label>
      <label class="muted"><input type="checkbox" id="optRisk"> ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø± (1â€“5)</label>
      <label class="muted">Ø¥Ø·Ø§Ø±:
        <input id="optBorderW" type="number" min="0" max="6" value="1" style="width:60px"> px
        <input id="optBorderColor" type="color" value="#333333">
      </label>
      <label class="muted">Ø­Ø¬Ù… Ø§Ù„Ø´Ø¹Ø§Ø±:
        <input id="optLogoIn" type="number" min="0.8" max="2.0" step="0.1" value="1.3" style="width:70px"> in
      </label>
      <button class="btn" id="exportPdf">ğŸ§¾ ØªØµØ¯ÙŠØ± PDF</button>
    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø¨Ù†Ø¯ -->
    <div class="toolbar no-print">
      <button class="btn" id="selectAll">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
      <button class="btn" id="clearAll">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ¯</button>
      <button class="btn" id="addRow">â• Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</button>
      <button class="btn" id="deleteChecked">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©</button>
      <span style="flex:1"></span>
      <button class="btn" id="importJson">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
      <button class="btn" id="exportJson">ğŸ“¤ ØªØµØ¯ÙŠØ± JSON</button>
      <button class="btn primary" id="exportHtml">â¬‡ï¸ ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ (HTML)</button>
    </div>

    <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
    <table id="tbl" class="sticky-head">
      <thead>
        <tr><th id="thSel">Ø§Ø®ØªÙŠØ§Ø± / Ø±Ù‚Ù…</th><th id="thItem">Ø¨Ù†Ø¯ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="sep"></div>
    <div class="muted no-print">ØªÙ„Ù…ÙŠØ­: ÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù…Ù† Word (ğŸ“‹)ØŒ ÙˆØ­ÙØ¸Ù‡Ø§ ÙƒÙ‚Ø§Ù„Ø¨ØŒ <span class="pill">Ø£Ùˆ Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ø¨Ø§Ø¨</span> Ù„ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. Ù„Ø§ ÙŠØªÙ… Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„Ù…ÙˆÙ‚Ø¹.</div>

    <details class="tests no-print" open>
      <summary>âœ… Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø© (Smoke Tests)</summary>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin:6px 0">
        <button class="btn" id="btnRunTests">ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</button>
        <span class="pill">Ù„Ù† Ù†Ø¹Ø¯Ù‘Ù„ Ø£ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙˆØ¬ÙˆØ¯Ø› Ø³Ù†Ø¶ÙŠÙ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙÙ‚Ø·</span>
      </div>
      <pre id="testOut" class="muted" style="white-space:pre-wrap"></pre>
    </details>
  </section>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ù„ØµÙ‚ Ù…Ù† Word -->
<dialog id="pasteDlg">
  <div class="dlg-head">ğŸ“‹ Ù„ØµÙ‚ Ø¨Ù†ÙˆØ¯ Ù…Ù† Word</div>
  <div class="dlg-body">
    <div class="dlg-grid">
      <label>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
        <input id="dlgChapterNo" type="text" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 4">
      </label>
      <label>Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
        <input id="dlgChapterName" type="text" placeholder="Ù…Ø«Ø§Ù„: ØªØ¯Ø§ÙˆÙ„ ÙˆØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯">
      </label>
    </div>
    <label>Ø§Ù„ØµÙ‚ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù‡Ù†Ø§ (Ø³Ø·Ø± Ù„ÙƒÙ„ Ø¨Ù†Ø¯):
      <textarea id="dlgText" placeholder="1- Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø£ÙˆÙ„\nâ€¢ Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ\n- Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ø«Ø§Ù„Ø«..."></textarea>
    </label>
    <div class="dlg-grid">
      <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø±Ø§Ø¬:
        <select id="dlgMode">
          <option value="replace">Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</option>
          <option value="append">Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</option>
        </select>
      </label>
      <label>Ø­ÙØ¸ ÙƒÙ‚Ø§Ù„Ø¨ Ø¨Ø§Ø³Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
        <input id="dlgTplName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨">
      </label>
    </div>
    <div class="inline-help" style="margin:6px 0 10px">Ø³ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªØ±Ù‚ÙŠÙ… ÙˆØ§Ù„Ø±Ù…ÙˆØ² (â€¢ - 1) ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <label class="muted"><input type="checkbox" id="dlgBindChapter" checked> Ø±Ø¨Ø· ÙƒØ¨Ø§Ø¨ Ù„Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</label>
      <label class="muted"><input type="checkbox" id="dlgCopyToEn" checked> Ù†Ø³Ø® Ø§Ù„Ø¨Ù†ÙˆØ¯ Ù„Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø£ÙŠØ¶Ù‹Ø§</label>
      <span class="pill">ÙŠÙÙŠØ¯ Ø¹Ù†Ø¯ Ø§Ù…ØªÙ„Ø§ÙƒÙƒ Ù†Øµ Ø¹Ø±Ø¨ÙŠ ÙÙ‚Ø·</span>
    </div>
  </div>
  <div class="dlg-actions">
    <button class="btn" id="dlgCancel" type="button">Ø¥Ù„ØºØ§Ø¡</button>
    <button class="btn primary" id="dlgApply" type="button">ØªØ·Ø¨ÙŠÙ‚</button>
  </div>
</dialog>

<script>
(function(){
  document.addEventListener('DOMContentLoaded', function(){
    // ===== Ø§Ù„Ø­Ø§Ù„Ø© =====
    let state = {
      lang: 'ar',
      logoDataURL: '',
      chapter: { number: '', name: '' },
      items: { ar: [], en: [] },
      options: { includeChecks: true, includeRisk: false, borderW: 1, borderColor: '#333333', logoIn: 1.3, autoFill: true }
    };

    const LS_KEY_DRAFT = 'audit_generic_draft';
    const LS_KEY_TPL = 'audit_user_templates_v1';
    const LS_KEY_CHMAP = 'audit_chapter_templates_v1';

    // ===== Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© =====
    const templates = {
      ar: {
        ch1:[
          "Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¯Ù„ÙŠÙ„ Ø¥Ø±Ø´Ø§Ø¯ÙŠ Ù„Ù„Ø³Ù„Ø§Ù…Ø© Ù…ÙƒØªÙˆØ¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆÙ„ØºØ© ÙŠÙÙ‡Ù…Ù‡Ø§ Ø§Ù„Ø¹Ù…Ø§Ù„",
          "ØªØ­Ø¯ÙŠØ¯ Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø¹Ù…Ù„ Ø­Ø³Ø¨ Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„Ù†Ø´Ø§Ø·",
          "ØªØ²ÙˆÙŠØ¯ Ø§Ù„Ù‡ÙŠØ¦Ø© Ø¨Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©",
          "Ø¥Ø¨Ù„Ø§Øº ÙˆØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¹Ù…Ø§Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø§Ø·Ø± ÙˆØ§Ù„ÙˆÙ‚Ø§ÙŠØ© Ù‚Ø¨Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø§Ù„Ø¹Ù…Ù„",
          "ØªÙˆÙÙŠØ± Ù…Ø¹Ø¯Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ø´Ø®ØµÙŠØ© Ù…Ø¬Ø§Ù†Ù‹Ø§ ÙˆØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¹Ù…Ø§Ù„ Ø¹Ù„Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§",
          "Ø§Ø¹ØªÙ…Ø§Ø¯ Ù„Ø§Ø¦Ø­Ø© Ø¬Ø²Ø§Ø¡Ø§Øª Ø®Ø§ØµØ© Ø¨Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©",
          "ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø§Øª Ø¥Ø±Ø´Ø§Ø¯ÙŠØ© ÙˆØªØ­Ø°ÙŠØ±ÙŠØ© ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…Ù„ØµÙ‚Ø§Øª Ø¨Ù„ØºØ© ÙŠÙÙ‡Ù…Ù‡Ø§ Ø§Ù„Ø¹Ù…Ø§Ù„",
          "ØªØ¹ÙŠÙŠÙ† Ù…Ø´Ø±Ù/Ù…Ø±Ø§Ù‚Ø¨ Ø³Ù„Ø§Ù…Ø© Ø­Ø³Ø¨ Ø­Ø¬Ù… ÙˆØ®Ø·ÙˆØ±Ø© Ø§Ù„Ù…Ù†Ø´Ø£Ø©",
          "ØªØ£Ù‡ÙŠÙ„ Ù…Ø´Ø±Ù Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø¨Ø´Ù‡Ø§Ø¯Ø© ÙˆØ®Ø¨Ø±Ø© Ù…Ù†Ø§Ø³Ø¨Ø©",
          "Ù„Ù„Ù…Ù†Ø´Ø¢Øª Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø®Ø·ÙˆØ±Ø© (300+ Ø¹Ø§Ù…Ù„): Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø³Ù… Ø³Ù„Ø§Ù…Ø© ÙˆØµØ­Ø© Ù…Ù‡Ù†ÙŠØ©",
          "ØªØ¯Ø±ÙŠØ¨ Ø¯ÙˆØ±ÙŠ Ù„Ù…Ø´Ø±ÙÙŠ ÙˆÙ…Ø±Ø§Ù‚Ø¨ÙŠ Ø§Ù„Ø³Ù„Ø§Ù…Ø©",
          "Ø¥Ø¬Ø±Ø§Ø¡ ØªÙØªÙŠØ´ Ø¯ÙˆØ±ÙŠ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­ÙˆØ§Ø¯Ø« ÙˆØ§Ù„Ø¥ØµØ§Ø¨Ø§Øª",
          "Ø¥Ø®Ø·Ø§Ø± Ø§Ù„Ù‡ÙŠØ¦Ø© Ø¨Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ø¬Ø³ÙŠÙ…Ø© Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©",
          "Ø­ÙØ¸ Ø³Ø¬Ù„Ø§Øª Ù…Ø­Ø¯Ø«Ø© Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…ÙØªØ´ÙŠÙ†"
        ],
        ch2:["Ù…ØªØ§Ù†Ø© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ÙˆØ§Ù„Ø£Ø³Ù‚Ù","ØªØ¬Ù‡ÙŠØ² Ø³Ø§Ø­Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø¨Ù…Ø¸Ù„Ø§Øª/Ø£Ø³Ù‚Ù","Ù…Ù…Ø±Ø§Øª ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…Ø®Ø§Ø±Ø¬ Ø·ÙˆØ§Ø±Ø¦ Ø¢Ù…Ù†Ø©","Ø£Ø±Ø¶ÙŠØ§Øª Ø³Ù„ÙŠÙ…Ø© ÙˆÙ†Ø¸ÙŠÙØ© ÙˆØµØ±Ù Ù…ØºØ·Ù‰","Ø§Ù„ØªØ®Ù„Øµ Ø§Ù„Ø³Ù„ÙŠÙ… Ù…Ù† Ø§Ù„ÙØ¶Ù„Ø§Øª ÙˆØ§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ©","ØµÙŠØ§Ù†Ø© Ø¯ÙˆØ±ÙŠØ© Ù„Ù„Ù…Ø¨Ø§Ù†ÙŠ ÙˆØ§Ù„Ù…Ø±Ø§ÙÙ‚","ÙˆÙ‚Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø³Ù‚ÙˆØ· ÙˆØ§Ù„Ø£Ø´ÙŠØ§Ø¡ Ø§Ù„Ù…ØªØ³Ø§Ù‚Ø·Ø© ÙˆØ§Ù„Ø­ÙØ±","Ø³Ù„Ø§Ù„Ù… Ù…ØªÙŠÙ†Ø© ØºÙŠØ± Ø²Ù„Ù‚Ø© ÙˆÙ…Ø²ÙˆØ¯Ø© Ø¨Ø­ÙˆØ§Ø¬Ø²","Ø³Ù‚Ø§Ù„Ø§Øª Ø¢Ù…Ù†Ø© Ù…Ø¹ Ø­ÙˆØ§Ø¬Ø² ÙˆØªØ«Ø¨ÙŠØª Ø¬ÙŠØ¯","Ø³Ù†Ø¯Ø±Ø§Øª/Ù…Ù†ØµØ§Øª Ù…Ø±Ø®ØµØ© ÙˆØ¢Ù…Ù†Ø©","Ø¹Ø²Ù„ Ù…ØµØ§Ø¯Ø± Ø§Ù„ØºØ¨Ø§Ø±/Ø§Ù„ØºØ§Ø²Ø§Øª Ù…Ø¹ Ø´ÙØ·","ÙØ­Øµ Ø£ÙˆØ¹ÙŠØ© Ø§Ù„Ø¶ØºØ·","Ø£Ø¯ÙˆØ§Øª ØµØ§Ù„Ø­Ø© ÙˆÙ…Ø­Ø¯Ø¯Ø© Ø£Ù…Ø§ÙƒÙ†Ù‡Ø§","Ù…Ø¹Ø¯Ø§Øª Ø¥Ø·ÙØ§Ø¡ Ù…Ù†Ø§Ø³Ø¨Ø© ÙˆÙ…ÙˆØ²Ø¹Ø©"],
        ch3:["ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¹Ù…Ø§Ù„ Ø¹Ù„Ù‰ ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ø¢Ù„Ø§Øª","Ù„Ø§ ØªØ´ØºÙŠÙ„ Ø¯ÙˆÙ† Ø­ÙˆØ§Ø¬Ø²","Ø¹Ø¯Ù… ØªØ¹Ø·ÙŠÙ„ Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©","Ù…Ø³Ø§ÙØ© 60 Ø³Ù… Ø­ÙˆÙ„ Ø§Ù„Ø¢Ù„Ø§Øª","Ø­ÙˆØ§Ø¬Ø² Ø¯Ø§Ø¦Ù…Ø© Ù„Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ø®Ø·Ø±Ø©","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­ÙˆØ§Ø¬Ø² ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù","Ù…ÙØªØ§Ø­ Ø¥ÙŠÙ‚Ø§Ù Ø·Ø§Ø±Ø¦","ØµÙŠØ§Ù†Ø© Ø¯ÙˆØ±ÙŠØ© Ø¨Ø³Ø¬Ù„Ø§Øª","ÙˆÙ‚Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø´Ø±Ø± ÙˆØ§Ù„Ø´Ø¸Ø§ÙŠØ§"],
        ch4:[
          "ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø®Ø§Ù…Ø§Øª Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¢Ù…Ù†Ø© Ù„Ø§ ØªØ´ÙƒÙ„ Ø®Ø·Ø±Ø§Ù‹ Ø¹Ù„Ù‰ Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø¹Ø§Ù…Ù„ÙŠÙ†",
          "Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© ÙˆØµÙŠØ§Ù†ØªÙ‡Ø§ Ø¯ÙˆØ±ÙŠØ§Ù‹ (ØªÙØªÙŠØ´ Ø£Ø³Ø¨ÙˆØ¹ÙŠ ÙˆØ§Ø®ØªØ¨Ø§Ø± Ø³Ù†ÙˆÙŠ)",
          "ØªØ«Ø¨ÙŠØª Ù„ÙˆØ­Ø© ØªØ¨ÙŠÙ† Ø£Ù‚ØµÙ‰ Ø­Ù…ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ù…Ø£Ù…ÙˆÙ†Ø© Ø¹Ù„Ù‰ ÙƒÙ„ Ø¢Ù„Ø© Ø±ÙØ¹",
          "Ø¥Ø¹Ø¯Ø§Ø¯ Ø³Ø¬Ù„ Ø®Ø§Øµ Ù„ÙƒÙ„ Ø¢Ù„Ø© Ø±ÙØ¹ ÙŠØ´Ù…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ†Ø¹ØŒ Ø§Ù„Ø­Ù…Ù„ Ø§Ù„Ø£Ù‚ØµÙ‰ØŒ Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¯ÙˆØ±ÙŠØŒ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª",
          "ØªØ²ÙˆÙŠØ¯ Ù…Ø´ØºÙ‘Ù„ Ø¢Ù„Ø© Ø§Ù„Ø±ÙØ¹ Ø¨ÙˆØ³ÙŠÙ„Ø© Ø§ØªØµØ§Ù„ ØµØ§Ù„Ø­Ø© Ù‚Ø¨Ù„ Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„",
          "ØªØ­Ø¯ÙŠØ¯ Ù…Ø³Ø§Ø±Ø§Øª Ø¢Ù„Ø§Øª Ø§Ù„Ø±ÙØ¹ Ø¨ÙˆØ³Ø§Ø¦Ù„ ØªØ­Ø°ÙŠØ± ÙˆÙ…Ù†Ø¹ Ù…Ø±ÙˆØ± Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø£Ùˆ ÙˆÙ‚ÙˆÙÙ‡Ù… ØªØ­Øª Ø§Ù„Ø£Ø­Ù…Ø§Ù„ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©",
          "ØªØ´ØºÙŠÙ„ Ø¢Ù„Ø§Øª Ø§Ù„Ø±ÙØ¹ ÙˆØ§Ù„Ø¬Ø± ÙˆØ§Ù„Ù†Ù‚Ù„ ÙŠÙ‚ØªØµØ± Ø¹Ù„Ù‰ Ø£Ø´Ø®Ø§Øµ Ù…Ø®ØªØµÙŠÙ† ÙˆÙ…Ø¤Ù‡Ù„ÙŠÙ† ÙˆÙ…Ø±Ø®Ù‘ØµÙŠÙ†",
          "ØªØ£Ù…ÙŠÙ† ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ© ÙˆØ¥Ø¬Ø±Ø§Ø¡ ÙØ­Øµ Ø¯ÙˆØ±ÙŠ Ù„Ù‡Ø§ ÙˆÙÙ‚Ø§Ù‹ Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©",
          "ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ù…Ø¹Ø¯Ø§Øª ÙˆÙÙ‚ Ø£ØµÙˆÙ„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ù„ÙŠÙ…ØŒ Ù…Ø¹ Ø¹Ø²Ù„ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø·Ø±Ø© ÙÙŠ Ù…Ø®Ø§Ø²Ù† Ø®Ø§ØµØ©",
          "ÙˆØ¶Ø¹ Ù„Ø§ÙØªØ§Øª Ø¥Ø±Ø´Ø§Ø¯ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø§Ø²Ù† ØªØ¨ÙŠÙ† Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®Ø·ÙˆØ±Ø© ÙˆØ·Ø±Ù‚ Ø§Ù„ØªØ¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ù†Ù‚Ù„ Ø§Ù„Ø¢Ù…Ù†"
        ],
        ch5:["Ù…ÙØ§ØªÙŠØ­ Ø¹Ø²Ù„ Ø¢Ù…Ù†Ø© ÙˆØ¨Ø£Ù…Ø§ÙƒÙ† Ø¸Ø§Ù‡Ø±Ø©","Ù‚ÙˆØ§Ø·Ø¹ Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠØ© Ù„Ù„Ø£Ø¹Ø·Ø§Ù„","Ù„ÙˆØ­Ø§Øª ØªÙˆØ²ÙŠØ¹ ÙÙŠ Ø£Ù…Ø§ÙƒÙ† Ø¢Ù…Ù†Ø©","Ø¹Ø¯Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù„ÙˆØ­Ø§Øª Ù„Ù„ØªØ®Ø²ÙŠÙ†","Ø¹Ø²Ù„ ÙƒØ§Ù…Ù„ Ù„Ù„Ø£Ø³Ù„Ø§Ùƒ ÙˆØ§Ù„ÙƒØ§Ø¨Ù„Ø§Øª","ÙØ­Øµ Ø¯ÙˆØ±ÙŠ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© ÙÙˆØ±ÙŠØ©","Ø¹Ø§Ù…Ù„ÙˆÙ† Ù…Ø¤Ù‡Ù„ÙˆÙ†","Ø¹Ø²Ù„ Ø§Ù„ØªÙŠØ§Ø± Ù‚Ø¨Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØªØ­Ø°ÙŠØ±Ø§Øª","Ù‚ÙØ§Ø²Ø§Øª/Ø£Ø­Ø°ÙŠØ© Ø¹Ø§Ø²Ù„Ø© ÙˆÙ…Ù†Ø¹ Ø§Ù„Ù…Ø¬ÙˆÙ‡Ø±Ø§Øª","ØªØ£Ø±ÙŠØ¶ Ø§Ù„Ø³ØªØ§ØªÙŠÙƒ","Ù…Ø¹Ø¯Ø§Øª Ø¥Ø·ÙØ§Ø¡ Ø­Ø±Ø§Ø¦Ù‚ ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©","ÙØ­ÙˆØµ Ø·Ø¨ÙŠØ© Ù„Ù„Ø¹Ø§Ù…Ù„ÙŠÙ† Ø¨Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡","Ù„ÙˆØ­Ø§Øª ØªØ­Ø°ÙŠØ± ÙˆØ§Ø¶Ø­Ø©"],
        ch6:["Ø¥Ø¶Ø§Ø¡Ø© ÙƒØ§ÙÙŠØ© ÙˆÙ…ØªØ¬Ø§Ù†Ø³Ø©","Ø§Ù„Ø­Ø¯ Ù…Ù† Ø§Ù„Ø¶ÙˆØ¶Ø§Ø¡/Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø²Ø§Øª","Ø­Ø±Ø§Ø±Ø© Ø¹Ù…Ù„ Ø¶Ù…Ù† Ø§Ù„Ø­Ø¯ÙˆØ¯","ÙˆÙ‚Ø§ÙŠØ© Ù„Ù„Ø¹Ù…Ø§Ù„ Ø¨Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…ÙƒØ´ÙˆÙØ©","ØªÙ‡ÙˆÙŠØ© ÙƒØ§ÙÙŠØ©","Ø­ÙˆØ§Ø¬Ø² Ø­Ø±Ø§Ø±ÙŠØ© Ù„Ù„Ø£ÙØ±Ù† ÙˆØ§Ù„Ù„Ø­Ø§Ù…"],
        ch7:["Ø­Ø¯ÙˆØ¯ Ø§Ù„ØªØ¹Ø±Ø¶ Ù„Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ©","Ø´ÙØ·/ØªÙ‡ÙˆÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ù…ØµØ¯Ø±","Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¨Ø¨Ø¯Ø§Ø¦Ù„ Ø£Ù‚Ù„ Ø®Ø·Ø±Ø§Ù‹","ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ù…ÙØªØ´ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯","ØªÙ†Ø¸ÙŠÙ Ø±Ø·Ø¨/Ø´ÙØ· Ø¯ÙˆØ±ÙŠ"],
        ch8:["Ø£Ù…Ø§ÙƒÙ† Ø±Ø§Ø­Ø©/Ø·Ø¹Ø§Ù… ÙˆÙÙ‚ Ø§Ø´ØªØ±Ø§Ø·Ø§Øª","ØºØ±Ù ØªØ¨Ø¯ÙŠÙ„ ÙˆØ®Ø²Ø§Ø¦Ù†","Ø­Ù…Ø§Ù…Ø§Øª ÙˆÙ…ÙˆØ§Ø¯ ØªÙ†Ø¸ÙŠÙ","Ù…ÙŠØ§Ù‡ Ø´Ø±Ø¨ Ù…Ø¨Ø±Ø¯Ø© ÙƒØ§ÙÙŠØ©","Ø¹Ø¯Ø¯ ÙƒØ§ÙÙ Ù…Ù† Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ÙŠØ§Ù‡","ØµØ±Ù ØµØ­ÙŠ Ù…Ù„Ø§Ø¦Ù… Ù„Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù†Ø§Ø¦ÙŠØ©"],
        ergo:["Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù…Ù†Ø§Ø³Ø¨","ÙƒØ±Ø³ÙŠ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø¯Ø¹Ù… Ø£Ø³ÙÙ„ Ø§Ù„Ø¸Ù‡Ø±","Ù…Ø³Ø§ÙØ© Ø±Ø¤ÙŠØ© Ø§Ù„Ø´Ø§Ø´Ø© Ù…ÙˆØµÙ‰ Ø¨Ù‡Ø§","Ù…Ù†Ø§ÙˆÙ„Ø© ÙŠØ¯ÙˆÙŠØ© Ø¶Ù…Ù† Ø§Ù„Ø­Ø¯ÙˆØ¯"]
      },
      en:{
        ch1:["Safety manual available","Identify work hazards","Submit approved drawings","Train workers before work","Provide PPE free","Penalty policy","Clear safety signs","Appoint safety supervisor","Supervisor certified","High-risk: safety dept.","Regular training","Periodic inspections","Report serious accidents","Keep updated records"],
        ch2:["Sound buildings/roofs","Yard shades/roofs","Marked passages & safe exits","Safe clean floors & drainage","Waste/chemicals disposal","Regular maintenance","Fall/excavation precautions","Sturdy non-slip ladders","Safe scaffolds with guardrails","Licensed safe platforms","Isolate dust/fumes with extraction","Inspect pressure vessels","Serviceable tools stored","Adequate extinguishers"],
        ch3:["Train on machine guarding","No operation without guards","Do not disable guards","60 cm clearance","Permanent guards","Remove guards only when stopped","Emergency stop nearby","Regular maintenance records","No cleaning during operation","Protect from sparks/debris"],
        ch4:[
          "Materials and raw substances are handled safely without endangering workers",
          "Proper lifting equipment is used and inspected weekly & tested at least annually",
          "Maximum safe load is clearly displayed on each lifting machine",
          "A logbook is maintained for each lifting machine (manufacture date, safe load, inspections, maintenance)",
          "Lifting machine operator is provided with a working communication device before operation",
          "Lifting paths are marked with warnings; no personnel are allowed under suspended loads",
          "Only trained, licensed, and authorized personnel operate lifting/hauling/transport machines",
          "Mechanical transport equipment is secured and regularly inspected per safety requirements",
          "Materials are stored safely; hazardous substances are isolated in designated storage",
          "Warning signs are posted on storage areas showing hazard level and safe handling methods"
        ],
        ch5:["Isolation switches","Automatic breakers","Safe distribution boards","No storage in panels","Insulated cables","Periodic inspection","Qualified electricians","Isolate power before maintenance","Insulated PPE; no jewelry","Static grounding","Electrical fire equipment","Medical exams","Warning signs"],
        ch6:["Adequate lighting","Noise/vibration control","Safe work temperature","Outdoor worker protection","Adequate ventilation","Heat shields"],
        ch7:["Within exposure limits","Extract at source","Substitute safer materials","Inspectors access chemicals","Wet/vacuum cleaning"],
        ch8:["Rest/eating areas","Changing rooms","Showers with supplies","Safe cool drinking water","Sufficient toilets","Approved sewage for remote sites"],
        ergo:["Desk height ok","Adjustable chair lumbar","Proper viewing distance","Manual handling within limits"]
      }
    };

    // ===== Ø¹Ù†Ø§ØµØ± DOM =====
    const els = {
      companyLogo: document.getElementById('companyLogo'),
      logoInput: document.getElementById('logoInput'),
      chapterNo: document.getElementById('chapterNo'),
      chapterName: document.getElementById('chapterName'),
      title: document.getElementById('title'),
      ref: document.getElementById('ref'),
      tbody: document.querySelector('#tbl tbody'),
      filter: document.getElementById('filter'),
      client: document.getElementById('client'),
      site: document.getElementById('site'),
      langAr: document.getElementById('langAr'),
      langEn: document.getElementById('langEn'),
      saveDraft: document.getElementById('saveDraft'),
      clearDraft: document.getElementById('clearDraft'),
      selectAll: document.getElementById('selectAll'),
      clearAll: document.getElementById('clearAll'),
      addRow: document.getElementById('addRow'),
      deleteChecked: document.getElementById('deleteChecked'),
      importJson: document.getElementById('importJson'),
      exportJson: document.getElementById('exportJson'),
      exportHtml: document.getElementById('exportHtml'),
      exportPdf: document.getElementById('exportPdf'),
      optChecks: document.getElementById('optChecks'),
      optRisk: document.getElementById('optRisk'),
      optBorderW: document.getElementById('optBorderW'),
      optBorderColor: document.getElementById('optBorderColor'),
      optLogoIn: document.getElementById('optLogoIn'),
      optAutoFill: document.getElementById('optAutoFill'),
      tplUserContainer: document.getElementById('tplUserContainer'),
      saveAsTemplate: document.getElementById('saveAsTemplate'),
      pasteFromWord: document.getElementById('pasteFromWord'),
      tplCh1: document.getElementById('tplCh1'),
      tplCh2: document.getElementById('tplCh2'),
      tplCh3: document.getElementById('tplCh3'),
      tplCh4: document.getElementById('tplCh4'),
      tplCh5: document.getElementById('tplCh5'),
      tplCh6: document.getElementById('tplCh6'),
      tplCh7: document.getElementById('tplCh7'),
      tplCh8: document.getElementById('tplCh8'),
      tplErgo: document.getElementById('tplErgo'),
      testOut: document.getElementById('testOut'),
      btnRunTests: document.getElementById('btnRunTests'),
      printBtn: document.getElementById('printBtn'),
      dlg: document.getElementById('pasteDlg'),
      dlgNo: document.getElementById('dlgChapterNo'),
      dlgName: document.getElementById('dlgChapterName'),
      dlgText: document.getElementById('dlgText'),
      dlgMode: document.getElementById('dlgMode'),
      dlgTplName: document.getElementById('dlgTplName'),
      dlgBind: document.getElementById('dlgBindChapter'),
      dlgCopyToEn: document.getElementById('dlgCopyToEn'),
      dlgCancel: document.getElementById('dlgCancel'),
      dlgApply: document.getElementById('dlgApply')
    };

    // ===== Ù‚ÙˆØ§Ù„Ø¨ Ù…Ø®ØµÙ‘ØµØ© =====
    function loadUserTemplates(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY_TPL)) || {ar:{},en:{}}; }
      catch{ return {ar:{},en:{}}; }
    }
    function saveUserTemplates(obj){
      try{ localStorage.setItem(LS_KEY_TPL, JSON.stringify(obj)); }
      catch(e){ console.warn('save tpl failed', e); }
    }
    function renderUserTemplates(){
      const store = loadUserTemplates();
      els.tplUserContainer.innerHTML = '';
      const map = store[state.lang] || {};
      Object.keys(map).forEach(name=>{
        const b = document.createElement('button');
        b.className='btn'; b.textContent = `ğŸ“„ ${name}`;
        b.addEventListener('click', ()=>{
          const isReplace = confirm('Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ù‚Ø§Ù„Ø¨ØŸ\nOK = Ø§Ø³ØªØ¨Ø¯Ø§Ù„\nCancel = Ø¥Ø¶Ø§ÙØ©');
          applyTemplateFromArray(map[name], isReplace? 'replace':'append');
        });
        els.tplUserContainer.appendChild(b);
      });
    }

    // ===== Ø±Ø¨Ø· Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨ =====
    function loadChapterMap(){ try{ return JSON.parse(localStorage.getItem(LS_KEY_CHMAP)) || {}; }catch{ return {}; } }
    function saveChapterMap(map){ try{ localStorage.setItem(LS_KEY_CHMAP, JSON.stringify(map)); }catch(e){ console.warn('save chapter map failed', e); } }
    const AR_DIGITS = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9'};
    function normalizeDigits(s){ return String(s||'').replace(/[Ù -Ù©]/g, d=>AR_DIGITS[d]).replace(/[^0-9.]/g,'').trim(); }
    function stripDiacritics(s){ return String(s||'').replace(/[\u064B-\u065F\u0670\u06D6-\u06ED]/g,''); }
    function normalizeName(s){ return stripDiacritics(String(s||'').replace(/\u0640/g,'')).toLowerCase().replace(/[\s\-â€“â€”_]+/g,' ').trim(); }
    function chapterKey(num,name){ const n=normalizeDigits(num); const nm=normalizeName(name); return n+'|'+nm; }

    function setChapterTemplate(num,name, arrAr, arrEn){ const map = loadChapterMap(); const key = chapterKey(num,name); map[key] = { ar: (arrAr||[]), en: (arrEn||[]) }; saveChapterMap(map); }
    function findChapterTemplate(num,name){
      const map = loadChapterMap();
      const n=normalizeDigits(num), nm=normalizeName(name);
      const entries = Object.entries(map);
      let hit = entries.find(([k])=>{const [kn,knm]=k.split('|'); return kn===n && knm===nm;});
      if(hit) return hit[1];
      if(n){ hit = entries.find(([k])=>k.split('|')[0]===n); if(hit) return hit[1]; }
      if(nm){ hit = entries.find(([k])=>k.split('|')[1]===nm); if(hit) return hit[1]; }
      if(n==='1') return { ar: templates.ar.ch1, en: templates.en.ch1 };
      if(n==='2') return { ar: templates.ar.ch2, en: templates.en.ch2 };
      if(n==='3') return { ar: templates.ar.ch3, en: templates.en.ch3 };
      if(n==='4') return { ar: templates.ar.ch4, en: templates.en.ch4 };
      if(n==='5') return { ar: templates.ar.ch5, en: templates.en.ch5 };
      if(n==='6') return { ar: templates.ar.ch6, en: templates.en.ch6 };
      if(n==='7') return { ar: templates.ar.ch7, en: templates.en.ch7 };
      if(n==='8') return { ar: templates.ar.ch8, en: templates.en.ch8 };
      if(nm.includes('ØªØ¯Ø§ÙˆÙ„') || (nm.includes('ØªØ®Ø²ÙŠÙ†') && nm.includes('Ù…ÙˆØ§Ø¯'))) return { ar: templates.ar.ch4, en: templates.en.ch4 };
      if(nm.includes('Ø§Ø­ØªÙŠØ§Ø·Ø§Øª') && nm.includes('Ø§Ù„Ø³Ù„Ø§Ù…Ø©')) return { ar: templates.ar.ch2, en: templates.en.ch2 };
      if(nm.includes('Ø§Ù„Ø­Ù…Ø§ÙŠØ©') && (nm.includes('Ø§Ù„Ø§Øª') || nm.includes('Ø§Ù„Ø§Ù„Ø§Øª') || nm.includes('Ø§Ù„Ø¢Ù„Ø§Øª'))) return { ar: templates.ar.ch3, en: templates.en.ch3 };
      if(nm.includes('Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©') && nm.includes('Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡')) return { ar: templates.ar.ch5, en: templates.en.ch5 };
      if(nm.includes('Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©') && nm.includes('Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©')) return { ar: templates.ar.ch6, en: templates.en.ch6 };
      if(nm.includes('Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©') && nm.includes('Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ©')) return { ar: templates.ar.ch7, en: templates.en.ch7 };
      if(nm.includes('Ø§Ù„Ù…Ø±Ø§ÙÙ‚') && nm.includes('Ø§Ù„Ø¹Ø§Ù…Ø©')) return { ar: templates.ar.ch8, en: templates.en.ch8 };
      if(nm.includes('ergonomic')) return { ar: templates.ar.ergo, en: templates.en.ergo };
      if((nm.includes('handling') || nm.includes('storage')) && nm.includes('material')) return { ar: templates.ar.ch4, en: templates.en.ch4 };
      if(nm.includes('safety') && nm.includes('health') && nm.includes('precautions')) return { ar: templates.ar.ch2, en: templates.en.ch2 };
      if((nm.includes('machinery') || nm.includes('machine')) && (nm.includes('safety') || nm.includes('protection'))) return { ar: templates.ar.ch3, en: templates.en.ch3 };
      if(nm.includes('electrical') && nm.includes('safety')) return { ar: templates.ar.ch5, en: templates.en.ch5 };
      if(nm.includes('natural') && (nm.includes('hazard') || nm.includes('hazards'))) return { ar: templates.ar.ch6, en: templates.en.ch6 };
      if((nm.includes('chemical') || nm.includes('hazardous')) && (nm.includes('safety') || nm.includes('substances'))) return { ar: templates.ar.ch7, en: templates.en.ch7 };
      if(nm.includes('general facilities')) return { ar: templates.ar.ch8, en: templates.en.ch8 };
      return null;
    }

    function tryAutoFillFromChapter(){
      if(!state.options.autoFill) return;
      const no = els.chapterNo.value.trim();
      const nm = els.chapterName.value.trim();
      const tpl = findChapterTemplate(no, nm);
      if(tpl){ state.items.ar = (tpl.ar||[]).slice(); state.items.en = (tpl.en||[]).slice(); renderTable(); persist(); }
    }

    // ===== ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© =====
    function multiMatch(text, query){ if(!query) return true; const parts = query.split(/\s+/).map(s=>s.trim().toLowerCase()).filter(Boolean); const t = String(text).toLowerCase(); return parts.every(p=>t.includes(p)); }

    function renderTable(){
      const list = state.items[state.lang] || [];
      const q = els.filter.value.trim();
      els.tbody.innerHTML = '';
      list.forEach((txt, idx)=>{
        if(q && !multiMatch(txt, q)) return;
        const tr = document.createElement('tr');
        tr.draggable = true; tr.dataset.row = idx;
        const safe = String(txt||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        tr.innerHTML = `<td><div class="rowlead"><input type="checkbox" class="pick" checked aria-label="select"><span class="ord">${idx+1}</span></div></td>
          <td contenteditable="true" data-index="${idx}">${safe}</td>`;
        els.tbody.appendChild(tr);
      });
    }

    function updateTitle(){
      const no = els.chapterNo.value.trim();
      let nm = els.chapterName.value.trim();
      if(!no && !nm) nm = 'ergonomic';
      if(state.lang==='ar'){
        els.title.textContent = 'Ù‚Ø§Ø¦Ù…Ø© ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø³Ù„Ø§Ù…Ø© â€“ ' + (no? ('Ø§Ù„Ø¨Ø§Ø¨ ' + no + ' â€“ ') : '') + (nm||'');
        els.langAr.classList.add('primary'); els.langEn.classList.remove('primary');
        document.documentElement.lang='ar'; document.documentElement.dir='rtl'; document.body.dir='rtl';
      } else {
        els.title.textContent = 'Safety Audit Checklist â€“ ' + (no? ('Chapter ' + no + ' â€“ ') : '') + (nm||'');
        els.langEn.classList.add('primary'); els.langAr.classList.remove('primary');
        document.documentElement.lang='en'; document.documentElement.dir='ltr'; document.body.dir='ltr';
      }
    }

    function persist(){
      const payload = { v:18, lang: state.lang, logoDataURL: state.logoDataURL, items: state.items, chapter: state.chapter, options: state.options };
      try{ localStorage.setItem(LS_KEY_DRAFT, JSON.stringify(payload)); } catch(e){ console.warn('persist failed', e); }
    }

    function restore(){
      const raw = localStorage.getItem(LS_KEY_DRAFT);
      if(raw){
        try{
          const d = JSON.parse(raw);
          if(d.lang) state.lang = d.lang;
          if(d.logoDataURL){ state.logoDataURL = d.logoDataURL; els.companyLogo.src = d.logoDataURL; els.companyLogo.hidden = !d.logoDataURL; }
          if(d.chapter) state.chapter = d.chapter;
          if(d.items && d.items.ar && d.items.en) state.items = d.items;
          if(d.options) state.options = Object.assign(state.options, d.options);
        }catch(e){ console.warn('restore failed', e); }
      }
      els.chapterNo.value = state.chapter.number || '';
      els.chapterName.value = state.chapter.name || '';
      els.optChecks.checked = !!state.options.includeChecks;
      els.optRisk.checked = !!state.options.includeRisk;
      els.optBorderW.value = state.options.borderW;
      els.optBorderColor.value = state.options.borderColor;
      els.optLogoIn.value = state.options.logoIn;
      els.optAutoFill.checked = !!state.options.autoFill;
      if(state.logoDataURL){ els.companyLogo.hidden=false; els.companyLogo.src=state.logoDataURL; }
      updateTitle(); renderTable(); renderUserTemplates();
    }

    function buildClientHTML(){
      const no = els.chapterNo.value.trim();
      const nm = els.chapterName.value.trim();
      const t = (state.lang==='ar');
      const opt = state.options;
      const title = (t? 'Ù‚Ø§Ø¦Ù…Ø© ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø³Ù„Ø§Ù…Ø© â€“ ' : 'Safety Audit Checklist â€“ ') + (no? (t? 'Ø§Ù„Ø¨Ø§Ø¨ '+no+' â€“ ' : 'Chapter '+no+' â€“ ') : '') + (nm||'');
      const lblClient = t? 'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:' : 'Client:';
      const lblSite   = t? 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹:' : 'Site:';
      const lblAud    = t? 'Ø§Ù„Ù…Ø¯Ù‚Ù‚:' : 'Auditor:';
      const lblNotes  = t? 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª' : 'Notes';
      const lblNo     = t? 'Ù…' : 'No.';
      const lblRisk   = t? 'Ø§Ù„Ù…Ø®Ø§Ø·Ø± (1â€“5)' : 'Risk (1â€“5)';

      const rows = [...document.querySelectorAll('#tbl tbody tr')]
        .filter(r=>r.querySelector('.pick')?.checked)
        .map(r=>r.cells[1].innerText.trim()).filter(Boolean);

      const rowsHTML = rows.map((txt,i)=>{
        const cells = [`<td>${i+1}</td>`,`<td>${txt.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</td>`];
        if(opt.includeChecks){ cells.push('<td><input type="checkbox"></td>','<td><input type="checkbox"></td>'); }
        if(opt.includeRisk){ cells.push('<td contenteditable="true" style="text-align:center;min-width:60px"></td>'); }
        cells.push('<td contenteditable="true" class="note"></td>');
        return `<tr>${cells.join('')}</tr>`;
      }).join('');

      const logoHTML = state.logoDataURL ? `<div style="text-align:center;margin-bottom:10px"><img src="${state.logoDataURL}" alt="logo" style="height:${opt.logoIn}in;display:inline-block;object-fit:contain"></div>` : '';
      const checksHdr = opt.includeChecks? '<th>âœ”</th><th>âœ–</th>' : '';
      const riskHdr = opt.includeRisk? `<th>${lblRisk}</th>` : '';

      return `<!doctype html>
<html lang="${t?'ar':'en'}" dir="${t?'rtl':'ltr'}"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>${title}</title>
<style>
@page{size:A4;margin:12mm}
body{font-family:${t?"'Noto Kufi Arabic','Cairo',Tahoma,sans-serif":"'Segoe UI','Roboto',Arial,sans-serif"};margin:0;background:#fff}
.page{max-width:794px;margin:12px auto;border:${opt.borderW}px solid ${opt.borderColor};border-radius:10px;padding:18px}
h1{margin:0 0 10px;text-align:center}
table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{border:1px solid #ccc;padding:8px;vertical-align:top}
th{background:#eef2ff}
tr{break-inside:avoid}
td.note{min-height:40px;max-height:60px;overflow-y:auto;white-space:pre-wrap;word-wrap:break-word}
</style>
</head><body>
<div class="page">
  ${logoHTML}
  <h1>${title}</h1>
  <div><strong>${lblClient}</strong> ${els.client.value||''}</div>
  <div><strong>${lblSite}</strong> ${els.site.value||''}</div>
  <div><strong>${lblAud}</strong> <div contenteditable="true" style="display:inline-block;min-width:200px;border-bottom:1px solid #000"></div></div>
  <table>
    <thead><tr><th>${lblNo}</th><th>${t?'Ø§Ù„Ø¨Ù†Ø¯':'Item'}</th>${checksHdr}${riskHdr}<th>${lblNotes}</th></tr></thead>
    <tbody>${rowsHTML}</tbody>
  </table>
</div>
</body></html>`;
    }

    // ===== Ù‚ÙˆØ§Ù„Ø¨ Ø¬Ø§Ù‡Ø²Ø© =====
    function applyTemplate(key, mode){ const set = templates[state.lang] && templates[state.lang][key] ? templates[state.lang][key] : []; if(!set.length){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù‚Ø§Ù„Ø¨ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù„ØºØ©/Ø§Ù„Ø¨Ø§Ø¨ Ø­Ø§Ù„ÙŠØ§Ù‹'); return; } applyTemplateFromArray(set, mode); }
    function applyTemplateFromArray(arr, mode){ const set = Array.isArray(arr)? arr.filter(x=>typeof x==='string' && x.trim()) : []; if(!set.length){ alert('Ø§Ù„Ù‚Ø§Ù„Ø¨ ÙØ§Ø±Øº'); return; } if(mode==='replace') state.items[state.lang] = [...set]; else state.items[state.lang].push(...set); renderTable(); persist(); }
    function askAndApply(key){ const isReplace = confirm('Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨Ù†ÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø§Ù„Ù‚Ø§Ù„Ø¨ØŸ\nOK = Ø§Ø³ØªØ¨Ø¯Ø§Ù„\nCancel = Ø¥Ø¶Ø§ÙØ©'); applyTemplate(key, isReplace ? 'replace' : 'append'); }

    // ===== Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« =====
    els.chapterNo.addEventListener('input', ()=>{ state.chapter.number = els.chapterNo.value; updateTitle(); tryAutoFillFromChapter(); persist(); });
    els.chapterName.addEventListener('input', ()=>{ state.chapter.name = els.chapterName.value; updateTitle(); tryAutoFillFromChapter(); persist(); });
    els.filter.addEventListener('input', renderTable);

    els.langAr.addEventListener('click', ()=>{ state.lang='ar'; updateTitle(); renderTable(); persist(); renderUserTemplates(); });
    els.langEn.addEventListener('click', ()=>{ state.lang='en'; updateTitle(); renderTable(); persist(); renderUserTemplates(); });

    els.optAutoFill.addEventListener('change', ()=>{ state.options.autoFill = els.optAutoFill.checked; persist(); });
    els.optChecks.addEventListener('change', ()=>{ state.options.includeChecks = els.optChecks.checked; persist(); });
    els.optRisk.addEventListener('change', ()=>{ state.options.includeRisk = els.optRisk.checked; persist(); });
    els.optBorderW.addEventListener('input', ()=>{ state.options.borderW = +els.optBorderW.value||0; persist(); });
    els.optBorderColor.addEventListener('input', ()=>{ state.options.borderColor = els.optBorderColor.value; persist(); });
    els.optLogoIn.addEventListener('input', ()=>{ state.options.logoIn = +els.optLogoIn.value||1.0; persist(); });

    els.selectAll.addEventListener('click', ()=> document.querySelectorAll('.pick').forEach(cb=>cb.checked=true));
    els.clearAll.addEventListener('click', ()=> document.querySelectorAll('.pick').forEach(cb=>cb.checked=false));
    els.addRow.addEventListener('click', ()=>{ const ph = state.lang==='ar'? '* Ø¨Ù†Ø¯ Ø¬Ø¯ÙŠØ¯' : '* New Item'; state.items[state.lang].unshift(ph); renderTable(); persist(); });
    els.deleteChecked.addEventListener('click', ()=>{ const keep=[]; document.querySelectorAll('#tbl tbody tr').forEach(r=>{ const checked=r.querySelector('.pick').checked; const text=r.cells[1].innerText.trim(); if(!checked) keep.push(text); }); state.items[state.lang] = keep; renderTable(); persist(); });

    els.tbody.addEventListener('input', (e)=>{ const td = e.target.closest('td[data-index]'); if(!td) return; const idx = +td.dataset.index; const val = td.innerText.trim(); if(Number.isInteger(idx) && idx>=0){ state.items[state.lang][idx] = val; persist(); }});

    // Ø³Ø­Ø¨ ÙˆØ¥ÙÙ„Ø§Øª Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨
    els.tbody.addEventListener('dragstart', (e)=>{ const tr = e.target.closest('tr'); if(!tr) return; tr.classList.add('dragging'); e.dataTransfer.setData('text/plain', tr.dataset.row); });
    els.tbody.addEventListener('dragend', (e)=>{ const tr = e.target.closest('tr'); if(tr) tr.classList.remove('dragging'); });
    els.tbody.addEventListener('dragover', (e)=>{ e.preventDefault(); });
    els.tbody.addEventListener('drop', (e)=>{ e.preventDefault(); const from = parseInt(e.dataTransfer.getData('text/plain'),10); const toTr = e.target.closest('tr'); if(toTr==null) return; const to = parseInt(toTr.dataset.row,10); if(Number.isNaN(from) || Number.isNaN(to) || from===to) return; const arr = state.items[state.lang]; const [moved] = arr.splice(from,1); arr.splice(to,0,moved); renderTable(); persist(); });

    // Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø±
    els.logoInput.addEventListener('change', e=>{
      const file = e.target.files[0];
      if(!file){ state.logoDataURL=''; els.companyLogo.hidden=true; persist(); return; }
      const r = new FileReader();
      r.onload = ev => { state.logoDataURL = ev.target.result; els.companyLogo.src = state.logoDataURL; els.companyLogo.hidden=false; persist(); };
      r.readAsDataURL(file);
    });

    // Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ù…Ø¯Ù…Ø¬Ø©
    els.tplCh1.addEventListener('click', ()=> askAndApply('ch1'));
    els.tplCh2.addEventListener('click', ()=> askAndApply('ch2'));
    els.tplCh3.addEventListener('click', ()=> askAndApply('ch3'));
    els.tplCh4.addEventListener('click', ()=> askAndApply('ch4'));
    els.tplCh5.addEventListener('click', ()=> askAndApply('ch5'));
    els.tplCh6.addEventListener('click', ()=> askAndApply('ch6'));
    els.tplCh7.addEventListener('click', ()=> askAndApply('ch7'));
    els.tplCh8.addEventListener('click', ()=> askAndApply('ch8'));
    els.tplErgo.addEventListener('click', ()=> applyTemplateFromArray(templates[state.lang].ergo,'append'));

    // Ø­ÙØ¸ ÙƒÙ‚Ø§Ù„Ø¨ Ù…Ø³ØªØ®Ø¯Ù…
    els.saveAsTemplate.addEventListener('click', ()=>{
      const name = prompt(state.lang==='ar'?'Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨ØŸ':'Template name?');
      if(!name) return;
      const store = loadUserTemplates();
      store[state.lang] = store[state.lang] || {};
      store[state.lang][name] = (state.items[state.lang]||[]).slice();
      saveUserTemplates(store);
      renderUserTemplates();
      alert(state.lang==='ar'?'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚Ø§Ù„Ø¨.':'Template saved.');
    });

    // Ù„ØµÙ‚ Ù…Ù† Word
    els.pasteFromWord.addEventListener('click', ()=> els.dlg.showModal());
    els.dlgCancel.addEventListener('click', ()=> els.dlg.close());
    function normalizeLines(text){
      return text.split(/\r?\n/)
        .map(s=>s.replace(/^\s*(?:[0-9]+[\).\-\)]\s*|[\u2022\-â€¢â–ªâ—†â—¦\*]+\s*)?/,'').trim())
        .filter(Boolean);
    }
    els.dlgApply.addEventListener('click', ()=>{
      const lines = normalizeLines(els.dlgText.value||'');
      if(!lines.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù†ÙˆØ¯.'); return; }
      if(els.dlgMode.value==='replace') state.items[state.lang] = lines; else state.items[state.lang].push(...lines);
      // Ù†Ø³Ø® Ù„Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù„Ùˆ Ø·Ù„Ø¨
      if(els.dlgCopyToEn.checked){
        if(state.lang==='ar'){ state.items.en = lines.slice(); } else { state.items.ar = lines.slice(); }
      }
      // Ø±Ø¨Ø· ÙƒØ¨Ø§Ø¨
      const no = els.dlgNo.value.trim();
      const nm = els.dlgName.value.trim();
      if(els.dlgBind.checked && (no||nm)){
        const arrAr = (state.lang==='ar')? lines.slice() : (state.items.ar||[]).slice();
        const arrEn = (state.lang==='en')? lines.slice() : (state.items.en||[]).slice();
        setChapterTemplate(no,nm, arrAr, arrEn);
      }
      // Ø­ÙØ¸ ÙƒÙ‚Ø§Ù„Ø¨ Ø¨Ø§Ø³Ù…
      const tplName = (els.dlgTplName.value||'').trim();
      if(tplName){
        const store = loadUserTemplates();
        store[state.lang] = store[state.lang] || {};
        store[state.lang][tplName] = lines.slice();
        saveUserTemplates(store);
      }
      if(no) { state.chapter.number = no; els.chapterNo.value = no; }
      if(nm) { state.chapter.name = nm; els.chapterName.value = nm; }
      renderTable(); updateTitle(); persist(); renderUserTemplates(); els.dlg.close();
    });

    // ØªØµØ¯ÙŠØ± HTML Ù„Ù„Ø¹Ù…ÙŠÙ„
    function download(filename, text){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([text], {type:'text/html'}));
      a.download = filename; a.click(); URL.revokeObjectURL(a.href);
    }
    els.exportHtml.addEventListener('click', ()=>{
      const html = buildClientHTML();
      const base = (state.lang==='ar'?'Ù‚Ø§Ø¦Ù…Ø©-ØªØ¯Ù‚ÙŠÙ‚':'Checklist');
      const no = (els.chapterNo.value||'').trim();
      const nm = (els.chapterName.value||'').trim().replace(/\s+/g,'-');
      const fn = `${base}-${no||'X'}-${nm||'Generic'}.html`;
      download(fn, html);
    });

    // Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ± JSON
    els.exportJson.addEventListener('click', ()=>{
      const data = { lang: state.lang, chapter: state.chapter, items: state.items, options: state.options };
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([JSON.stringify(data,null,2)], {type:'application/json'}));
      a.download = 'audit-checklist.json'; a.click(); URL.revokeObjectURL(a.href);
    });
    els.importJson.addEventListener('click', ()=>{
      const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
      inp.onchange = async (e)=>{
        const file = e.target.files[0]; if(!file) return;
        try{ const text = await file.text(); const data = JSON.parse(text);
          if(data.items){ state.items = data.items; }
          if(data.lang){ state.lang = data.lang; }
          if(data.chapter){ state.chapter = data.chapter; }
          if(data.options){ state.options = Object.assign(state.options, data.options); }
          renderTable(); updateTitle(); persist(); renderUserTemplates();
        }catch(err){ alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); console.error(err); }
      };
      inp.click();
    });

    // Ø·Ø¨Ø§Ø¹Ø© Ùˆ PDF
    els.printBtn.addEventListener('click', ()=> window.print());
    els.exportPdf.addEventListener('click', ()=>{
      const html = buildClientHTML();
      const w = window.open('', '_blank');
      w.document.write(html); w.document.close();
      w.focus();
      // Ø§Ù…Ù†Ø­ Ø§Ù„ØµÙØ­Ø© ÙˆÙ‚ØªÙ‹Ø§ Ù„ØªÙØ­Ù…Ù‘ÙÙ„ Ø«Ù… Ø§Ø·Ø¨Ø¹
      setTimeout(()=>{ try{ w.print(); } finally { /* Ù„Ø§ Ù†ØºÙ„Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø­ÙØ¸ Ù…Ù„Ù PDF */ } }, 400);
    });

    // Ø­ÙØ¸/Ù…Ø³Ø­ Ù…Ø³ÙˆØ¯Ø©
    els.saveDraft.addEventListener('click', ()=>{ persist(); alert(state.lang==='ar'?'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©.':'Draft saved.'); });
    els.clearDraft.addEventListener('click', ()=>{ if(confirm('Ù…Ø³Ø­ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø§Ù„Ù…Ø®Ø²Ù‘Ù†Ø©ØŸ')){ localStorage.removeItem(LS_KEY_DRAFT); alert('ØªÙ… Ø§Ù„Ù…Ø³Ø­.'); location.reload(); } });

    // Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø©
    els.btnRunTests.addEventListener('click', ()=>{
      const out=[];
      out.push('â€” Ø§Ù„Ù„ØºØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: '+state.lang);
      out.push('â€” Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ù†ÙˆØ¯ (AR/EN): '+(state.items.ar?.length||0)+' / '+(state.items.en?.length||0));
      out.push('â€” Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: '+document.title);
      out.push('â€” Ø®ÙŠØ§Ø±Ø§Øª: checks='+state.options.includeChecks+', risk='+state.options.includeRisk);
      // ØªØ¬Ø±Ø¨Ø© Ø¨Ù†Ø§Ø¡ HTML
      try{ const s = buildClientHTML(); out.push('â€” Ø¨Ù†Ø§Ø¡ HTML âœ… ('+s.length+' chars)'); }catch(e){ out.push('â€” Ø¨Ù†Ø§Ø¡ HTML âŒ '+e.message); }
      // ØªØ¬Ø±Ø¨Ø© Ø±Ø¨Ø· Ø§Ù„Ø¨Ø§Ø¨
      try{
        setChapterTemplate('4','ØªØ¯Ø§ÙˆÙ„ ÙˆØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯', ['Ø§Ø®ØªØ¨Ø§Ø±'], ['Test']);
        const got = findChapterTemplate('4','ØªØ¯Ø§ÙˆÙ„ ÙˆØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯');
        out.push('â€” Ø±Ø¨Ø· Ø§Ù„Ø¨Ø§Ø¨ âœ… ' + (!!got && got.ar && got.en));
      }catch(e){ out.push('â€” Ø±Ø¨Ø· Ø§Ù„Ø¨Ø§Ø¨ âŒ '+e.message); }
      els.testOut.textContent = out.join('\n');
    });

    // Ø¨Ø¯Ø§ÙŠØ© ØªØ´ØºÙŠÙ„
    restore();
    // Ø¥Ù† Ù„Ù… ØªÙˆØ¬Ø¯ Ù…Ø³ÙˆØ¯Ø©ØŒ Ø¬Ù‡Ù‘Ø² Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
    if(!(state.items.ar.length||state.items.en.length)){
      state.items.ar = templates.ar.ch1.slice();
      state.items.en = templates.en.ch1.slice();
      renderTable();
    }
  });
})();
</script>
</body>
</html>
